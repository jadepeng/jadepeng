<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.iflyresearch.com","root":"/blog/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
<meta property="og:type" content="website">
<meta property="og:title" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
<meta property="og:url" content="http://blog.iflyresearch.com/page/9/index.html">
<meta property="og:site_name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
<meta property="og:description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="JadePeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.iflyresearch.com/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">çˆ±å­¦ä¹ çˆ±åˆ†äº«</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-åšå®¢">

    <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" rel="section"><i class="fa fa-th fa-fw"></i>åšå®¢</a>

  </li>
        <li class="menu-item menu-item-åˆ†ç±»">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/12/22/jqpeng-kgtemp%E6%96%87%E4%BB%B6%E8%BD%ACmp3%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/12/22/jqpeng-kgtemp%E6%96%87%E4%BB%B6%E8%BD%ACmp3%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">kgtempæ–‡ä»¶è½¬mp3å·¥å…·</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-12-22 13:24:00" itemprop="dateCreated datePublished" datetime="2017-12-22T13:24:00+08:00">2017-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/8085563.html">kgtempæ–‡ä»¶è½¬mp3å·¥å…·</a></p>
<p>kgtempæ–‡ä»¶æ˜¯é…·æˆ‘éŸ³ä¹è½¯ä»¶çš„ç¼“å­˜æ–‡ä»¶ï¼Œæœ¬æ–‡ä»æŠ€æœ¯å±‚é¢æ¢è®¨å¦‚ä½•è§£å¯†è¯¥æ–‡ä»¶ä¸ºmp3æ–‡ä»¶ï¼Œå¹¶é€šè¿‡è¯»å–ID3ä¿¡æ¯æ¥é‡å‘½åã€‚</p>
<p>å¤‡æ³¨ï¼šé’ˆå¯¹è€ç‰ˆæœ¬çš„é…·æˆ‘éŸ³ä¹ç”Ÿæ•ˆï¼Œæ–°ç‰ˆæœ¬ä¸æ”¯æŒï¼ï¼ï¼</p>
<h2 id="kgtempè§£å¯†"><a href="#kgtempè§£å¯†" class="headerlink" title="kgtempè§£å¯†"></a>kgtempè§£å¯†</h2><p>kgtempæ–‡ä»¶å‰1024ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„åŒ…å¤´ä¿¡æ¯ï¼Œè§£å¯†æ–¹æ¡ˆè¯¦ç»†å¯ä»¥å‚è§(<a target="_blank" rel="noopener" href="http://www.cnblogs.com/KMBlog/p/6877752.html">http://www.cnblogs.com/KMBlog/p/6877752.html</a>)ï¼š</p>
<pre><code>class Program&#123;    static void Main(string[] args)    &#123;
        byte[] key=&#123;0xAC,0xEC,0xDF,0x57&#125;;        using (var input = new FileStream(@&quot;E:\KuGou\Temp\236909b6016c6e98365e5225f488dd7a.kgtemp&quot;, FileMode.Open, FileAccess.Read))        &#123;            var output = File.OpenWrite(@&quot;d:\test.mp3&quot;);//è¾“å‡ºæ–‡ä»¶            input.Seek(1024, SeekOrigin.Begin);//è·³è¿‡1024å­—èŠ‚çš„åŒ…å¤´            byte[] buffer = new byte[key.Length];            int length;            while((length=input.Read(buffer,0,buffer.Length))&gt;0)            &#123;                for(int i=0;i&lt;length;i++)                &#123;                    var k = key[i];                    var kh = k &gt;&gt; 4;                    var kl = k &amp; 0xf;                    var b = buffer[i];                    var low = b &amp; 0xf ^ kl;//è§£å¯†åçš„ä½4ä½                    var high = (b &gt;&gt; 4) ^ kh ^ low &amp; 0xf;//è§£å¯†åçš„é«˜4ä½                    buffer[i] = (byte)(high &lt;&lt; 4 | low);                &#125;                output.Write(buffer, 0, length);            &#125;            output.Close();        &#125;        Console.WriteLine(&quot;æŒ‰ä»»æ„é”®é€€å‡º...&quot;);        Console.ReadKey();    &#125;&#125;
</code></pre>
<p>è¿™æ ·è§£å¯†å‡ºæ¥å°±æ˜¯mp3æ–‡ä»¶äº†</p>
<h2 id="è¯»å–ID3ä¿¡æ¯"><a href="#è¯»å–ID3ä¿¡æ¯" class="headerlink" title="è¯»å–ID3ä¿¡æ¯"></a>è¯»å–ID3ä¿¡æ¯</h2><p>è§£å¯†å‡ºæ¥çš„æ–‡ä»¶è¿˜éœ€è¦æ‰‹åŠ¨å‘½åï¼Œä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå¯ä»¥è¯»å–ID3V1ä¿¡æ¯é‡å‘½åæ–‡ä»¶ã€‚<br> ID3V1æ¯”è¾ƒç®€å•ï¼Œå®ƒæ˜¯å­˜æ”¾åœ¨MP3æ–‡ä»¶çš„æœ«å°¾ï¼Œç”¨16è¿›åˆ¶çš„ç¼–è¾‘å™¨æ‰“å¼€ä¸€ä¸ªMP3æ–‡ä»¶ï¼ŒæŸ¥çœ‹å…¶æœ«å°¾çš„128ä¸ªé¡ºåºå­˜æ”¾å­—èŠ‚ï¼Œæ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š<br> char Header<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1513919861693.jpg" title="1513919861693">3</a>;    /<em>æ ‡ç­¾å¤´å¿…é¡»æ˜¯â€TAGâ€å¦åˆ™è®¤ä¸ºæ²¡æœ‰æ ‡ç­¾</em>/<br> char Title[30];    /<em>æ ‡é¢˜</em>/<br> char Artist[30];   /<em>ä½œè€…</em>/<br> char Album[30];    /<em>ä¸“é›†</em>/<br> char Year<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1513920067729.jpg" title="1513920067729">4</a>;    /<em>å‡ºå“å¹´ä»£</em>/<br> char Comment[30];   /<em>å¤‡æ³¨</em>/<br> char Genre;    /<em>ç±»å‹ï¼Œæµæ´¾</em>/</p>
<p>è§£æä»£ç æ¯”è¾ƒç®€å•ï¼Œæ³¨æ„ä¸­æ–‡æ­Œæ›²ç”¨GBKç¼–ç å°±å¯ä»¥äº†ï¼š</p>
<pre><code>  private static Mp3Info FormatMp3Info(byte[] Info, System.Text.Encoding Encoding)    &#123;        Mp3Info myMp3Info = new Mp3Info();        string str = null;        int i;        int position = 0ä¸»è¦ä»£ç jiaï¼Œ; //å¾ªç¯çš„èµ·å§‹å€¼        int currentIndex = 0; //Infoçš„å½“å‰ç´¢å¼•å€¼
        //è·å–TAGæ ‡è¯†        for (i = currentIndex; i &lt; currentIndex + 3; i++)        &#123;            str = str + (char)Info[i];            position++;        &#125;        currentIndex = position;        myMp3Info.identify = str;
        //è·å–æ­Œå        str = null;        byte[] bytTitle = new byte[30]; //å°†æ­Œåéƒ¨åˆ†è¯»åˆ°ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„ä¸­        int j = 0;        for (i = currentIndex; i &lt; currentIndex + 30; i++)        &#123;            bytTitle[j] = Info[i];            position++;            j++;        &#125;        currentIndex = position;        myMp3Info.Title = ByteToString(bytTitle, Encoding);
        //è·å–æ­Œæ‰‹å        str = null;        j = 0;        byte[] bytArtist = new byte[30]; //å°†æ­Œæ‰‹åéƒ¨åˆ†è¯»åˆ°ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„ä¸­        for (i = currentIndex; i &lt; currentIndex + 30; i++)        &#123;            bytArtist[j] = Info[i];            position++;            j++;        &#125;        currentIndex = position;        myMp3Info.Artist = ByteToString(bytArtist, Encoding);
        //è·å–å”±ç‰‡å        str = null;        j = 0;        byte[] bytAlbum = new byte[30]; //å°†å”±ç‰‡åéƒ¨åˆ†è¯»åˆ°ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„ä¸­        for (i = currentIndex; i &lt; currentIndex + 30; i++)        &#123;            bytAlbum[j] = Info[i];            position++;            j++;        &#125;        currentIndex = position;        myMp3Info.Album = ByteToString(bytAlbum, Encoding);
        //è·å–å¹´        str = null;        j = 0;        byte[] bytYear = new byte[4]; //å°†å¹´éƒ¨åˆ†è¯»åˆ°ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„ä¸­        for (i = currentIndex; i &lt; currentIndex + 4; i++)        &#123;            bytYear[j] = Info[i];            position++;            j++;        &#125;        currentIndex = position;        myMp3Info.Year = ByteToString(bytYear, Encoding);
        //è·å–æ³¨é‡Š        str = null;        j = 0;        byte[] bytComment = new byte[28]; //å°†æ³¨é‡Šéƒ¨åˆ†è¯»åˆ°ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„ä¸­        for (i = currentIndex; i &lt; currentIndex + 25; i++)        &#123;            bytComment[j] = Info[i];            position++;            j++;        &#125;        currentIndex = position;        myMp3Info.Comment = ByteToString(bytComment, Encoding);
        //ä»¥ä¸‹è·å–ä¿ç•™ä½        myMp3Info.reserved1 = (char)Info[++position];        myMp3Info.reserved2 = (char)Info[++position];        myMp3Info.reserved3 = (char)Info[++position];
        //        return myMp3Info;    &#125;
</code></pre>
<h2 id="è½¬æ¢å°å·¥å…·"><a href="#è½¬æ¢å°å·¥å…·" class="headerlink" title="è½¬æ¢å°å·¥å…·"></a>è½¬æ¢å°å·¥å…·</h2><p>å†™äº†ä¸€ä¸ªå°å·¥å…·ï¼Œæ¥è¿›è¡Œè½¬æ¢</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1513919861693.jpg" alt="è£…æ¢å·¥å…·" title="1513919861693"></p>
<p>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1o7FIsPk">https://pan.baidu.com/s/1o7FIsPk</a></p>
<p>PS:ä¸Šé¢åªè¯»å–äº†IDV1ï¼Œéƒ¨åˆ†æ­Œæ›²å¯èƒ½ä¸å­˜åœ¨<br> å¯ä»¥ä¸‹è½½@ç¼¤çº· æä¾›çš„ç¨‹åºï¼Œå¢åŠ äº†ID3V2çš„æ”¯æŒï¼š<br><a target="_blank" rel="noopener" href="https://files.cnblogs.com/files/gxlxzys/kgtemp%E6%96%87%E4%BB%B6%E8%BD%ACmp3%E5%B7%A5%E5%85%B7.zip">https://files.cnblogs.com/files/gxlxzys/kgtempæ–‡ä»¶è½¬mp3å·¥å…·.zip</a></p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/12/08/jqpeng-%E4%BD%BF%E7%94%A8SpringBoot%E5%BC%80%E5%8F%91REST%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/12/08/jqpeng-%E4%BD%BF%E7%94%A8SpringBoot%E5%BC%80%E5%8F%91REST%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">ä½¿ç”¨SpringBootå¼€å‘RESTæœåŠ¡</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-12-08 16:35:00" itemprop="dateCreated datePublished" datetime="2017-12-08T16:35:00+08:00">2017-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>9.4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>9 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/SpringBootRest.html">ä½¿ç”¨SpringBootå¼€å‘RESTæœåŠ¡</a></p>
<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åŸºäºSpring Bootæ­å»ºä¸€ä¸ªç®€æ˜“çš„RESTæœåŠ¡æ¡†æ¶ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡è‡ªå®šä¹‰æ³¨è§£å®ç°RestæœåŠ¡é‰´æƒ</p>
<h1 id="æ­å»ºæ¡†æ¶"><a href="#æ­å»ºæ¡†æ¶" class="headerlink" title="æ­å»ºæ¡†æ¶"></a>æ­å»ºæ¡†æ¶</h1><h2 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h2><p>é¦–å…ˆï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ï¼Œæ•°æ®åº“ä½¿ç”¨mongodbï¼ŒåŒæ—¶ä½¿ç”¨redisåšç¼“å­˜</p>
<pre><code>æ³¨æ„ï¼Œè¿™é‡Œæ²¡æœ‰ä½¿ç”¨tomcatï¼Œè€Œæ˜¯ä½¿ç”¨undertow



    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;    &lt;/dependency&gt;
    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;        &lt;scope&gt;test&lt;/scope&gt;    &lt;/dependency&gt;
    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;        &lt;exclusions&gt;            &lt;exclusion&gt;                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;                &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;            &lt;/exclusion&gt;        &lt;/exclusions&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt;    &lt;/dependency&gt;
    &lt;!--redisæ”¯æŒ--&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;    &lt;/dependency&gt;
    &lt;!--mongodbæ”¯æŒ--&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;    &lt;/dependency&gt;
</code></pre>
<ul>
<li>å¼•å…¥spring-boot-starter-webæ”¯æŒwebæœåŠ¡</li>
<li>å¼•å…¥spring-boot-starter-data-redis å’Œspring-boot-starter-data-mongodbå°±å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨mongodbå’Œredisäº†</li>
</ul>
<h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><h3 id="profilesåŠŸèƒ½"><a href="#profilesåŠŸèƒ½" class="headerlink" title="profilesåŠŸèƒ½"></a>profilesåŠŸèƒ½</h3><p>ä¸ºäº†æ–¹ä¾¿ åŒºåˆ†å¼€å‘ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨profilesåŠŸèƒ½ï¼Œåœ¨application.propertiesé‡Œå¢åŠ <br> spring.profiles.active=dev</p>
<p>ç„¶åå¢åŠ application-dev.propertiesä½œä¸ºdevé…ç½®æ–‡ä»¶ã€‚</p>
<h3 id="mondbé…ç½®"><a href="#mondbé…ç½®" class="headerlink" title="mondbé…ç½®"></a>mondbé…ç½®</h3><p>é…ç½®æ•°æ®åº“åœ°å€å³å¯</p>
<pre><code>spring.data.mongodb.uri=mongodb://ip:port/database?readPreference=primaryPreferred
</code></pre>
<h3 id="redisé…ç½®"><a href="#redisé…ç½®" class="headerlink" title="redisé…ç½®"></a>redisé…ç½®</h3><pre><code>spring.redis.database=0  
# RedisæœåŠ¡å™¨åœ°å€
spring.redis.host=ip
# RedisæœåŠ¡å™¨è¿æ¥ç«¯å£
spring.redis.port=6379  
# RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰
spring.redis.password=
# è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
spring.redis.pool.max-active=8  
# è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
spring.redis.pool.max-wait=-1  
# è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
spring.redis.pool.max-idle=8  
# è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
spring.redis.pool.min-idle=0  
# è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
spring.redis.timeout=0  
</code></pre>
<h2 id="æ•°æ®è®¿é—®"><a href="#æ•°æ®è®¿é—®" class="headerlink" title="æ•°æ®è®¿é—®"></a>æ•°æ®è®¿é—®</h2><h3 id="mongdb"><a href="#mongdb" class="headerlink" title="mongdb"></a>mongdb</h3><p>mongdbè®¿é—®å¾ˆç®€å•ï¼Œç›´æ¥å®šä¹‰æ¥å£extends MongoRepositoryå³å¯ï¼Œå¦å¤–å¯ä»¥æ”¯æŒJPAè¯­æ³•ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code>@Component
public interface UserRepository extends MongoRepository&lt;User, Integer&gt; &#123;
public User findByUserName(String userName);
&#125;
</code></pre>
<p>ä½¿ç”¨æ—¶ï¼ŒåŠ ä¸Š@Autowiredæ³¨è§£å³å¯ã€‚</p>
<pre><code>@Component
public class AuthService extends BaseService &#123;
@AutowiredUserRepository userRepository;&#125;
</code></pre>
<h3 id="Redisè®¿é—®"><a href="#Redisè®¿é—®" class="headerlink" title="Redisè®¿é—®"></a>Redisè®¿é—®</h3><p>ä½¿ç”¨StringRedisTemplateå³å¯ç›´æ¥è®¿é—®Redis</p>
<pre><code>@Component
public class BaseService &#123;@Autowiredprotected MongoTemplate mongoTemplate;
@Autowiredprotected StringRedisTemplate stringRedisTemplate;
&#125;
</code></pre>
<p>å‚¨å­˜æ•°æ®ï¼š</p>
<pre><code>.stringRedisTemplate.opsForValue().set(token_key, user.getId()+&quot;&quot;,token_max_age, TimeUnit.SECONDS);
</code></pre>
<p>åˆ é™¤æ•°æ®ï¼š</p>
<pre><code>stringRedisTemplate.delete(getFormatToken(accessToken,platform));
</code></pre>
<h2 id="WebæœåŠ¡"><a href="#WebæœåŠ¡" class="headerlink" title="WebæœåŠ¡"></a>WebæœåŠ¡</h2><p>å®šä¹‰ä¸€ä¸ªControllerç±»ï¼ŒåŠ ä¸ŠRestControllerå³å¯ï¼Œä½¿ç”¨RequestMappingç”¨æ¥è®¾ç½®url route</p>
<pre><code>@RestController
public class AuthController extends BaseController &#123;
@RequestMapping(value = &#123;&quot;/&quot;&#125;, produces = &quot;application/json;charset=utf-8&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)@ResponseBodypublic String main() &#123;    return &quot;hello worldï¼&quot;;&#125;

&#125;
</code></pre>
<p>ç°åœ¨å¯åŠ¨ï¼Œåº”è¯¥å°±èƒ½çœ‹åˆ°hello worldï¼äº†</p>
<h1 id="æœåŠ¡é‰´æƒ"><a href="#æœåŠ¡é‰´æƒ" class="headerlink" title="æœåŠ¡é‰´æƒ"></a>æœåŠ¡é‰´æƒ</h1><h2 id="ç®€æ˜“accessTokenæœºåˆ¶"><a href="#ç®€æ˜“accessTokenæœºåˆ¶" class="headerlink" title="ç®€æ˜“accessTokenæœºåˆ¶"></a>ç®€æ˜“accessTokenæœºåˆ¶</h2><p>æä¾›ç™»å½•æ¥å£ï¼Œè®¤è¯æˆåŠŸåï¼Œç”Ÿæˆä¸€ä¸ªaccessTokenï¼Œä»¥åè®¿é—®æ¥å£æ—¶ï¼Œå¸¦ä¸ŠaccessTokenï¼ŒæœåŠ¡ç«¯é€šè¿‡accessTokenæ¥åˆ¤æ–­æ˜¯å¦æ˜¯åˆæ³•ç”¨æˆ·ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥å°†accessTokenå­˜å…¥redisï¼Œè®¾å®šæœ‰æ•ˆæœŸã€‚</p>
<pre><code>        String token = EncryptionUtils.sha256Hex(String.format(&quot;%s%s&quot;, user.getUserName(), System.currentTimeMillis()));    String token_key = getFormatToken(token, platform);    this.stringRedisTemplate.opsForValue().set(token_key, user.getId()+&quot;&quot;,token_max_age, TimeUnit.SECONDS);
</code></pre>
<h2 id="æ‹¦æˆªå™¨èº«ä»½è®¤è¯"><a href="#æ‹¦æˆªå™¨èº«ä»½è®¤è¯" class="headerlink" title="æ‹¦æˆªå™¨èº«ä»½è®¤è¯"></a>æ‹¦æˆªå™¨èº«ä»½è®¤è¯</h2><p>ä¸ºäº†æ–¹ä¾¿åšç»Ÿä¸€çš„èº«ä»½è®¤è¯ï¼Œå¯ä»¥åŸºäºSpringçš„æ‹¦æˆªå™¨æœºåˆ¶ï¼Œåˆ›å»ºä¸€ä¸ªæ‹¦æˆªå™¨æ¥åšç»Ÿä¸€è®¤è¯ã€‚</p>
<pre><code>public class AuthCheckInterceptor implements HandlerInterceptor &#123;
&#125;
</code></pre>
<p>è¦ä½¿æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦ä¸€æ­¥ï¼Œå¢åŠ é…ç½®ï¼š</p>
<pre><code>@Configuration
public class SessionConfiguration extends WebMvcConfigurerAdapter &#123;
@AutowiredAuthCheckInterceptor authCheckInterceptor;
@Overridepublic void addInterceptors(InterceptorRegistry registry) &#123;    super.addInterceptors(registry);    // æ·»åŠ æ‹¦æˆªå™¨    registry.addInterceptor(authCheckInterceptor).addPathPatterns(&quot;/**&quot;);&#125;
&#125;
</code></pre>
<h2 id="è‡ªå®šä¹‰è®¤è¯æ³¨è§£"><a href="#è‡ªå®šä¹‰è®¤è¯æ³¨è§£" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯æ³¨è§£"></a>è‡ªå®šä¹‰è®¤è¯æ³¨è§£</h2><p>ä¸ºäº†ç²¾ç»†åŒ–æƒé™è®¤è¯ï¼Œæ¯”å¦‚æœ‰çš„æ¥å£åªèƒ½å…·æœ‰ç‰¹å®šæƒé™çš„äººæ‰èƒ½è®¿é—®ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ³¨è§£è½»æ¾è§£å†³ã€‚åœ¨è‡ªå®šä¹‰çš„æ³¨è§£é‡Œï¼ŒåŠ ä¸Šroleså³å¯ã€‚</p>
<pre><code>/**
 *  æƒé™æ£€éªŒæ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface AuthCheck &#123;
/** *  è§’è‰²åˆ—è¡¨ * @return */String[] roles() default &#123;&#125;;
&#125;
</code></pre>
<p>æ£€éªŒé€»è¾‘ï¼š</p>
<ul>
<li>åªè¦æ¥å£åŠ ä¸Šäº†AuthCheckæ³¨è§£ï¼Œå°±å¿…é¡»æ˜¯ç™»é™†ç”¨æˆ·</li>
<li>å¦‚æœæŒ‡å®šäº†rolesï¼Œåˆ™é™¤äº†ç™»å½•å¤–ï¼Œç”¨æˆ·è¿˜åº”è¯¥å…·å¤‡ç›¸åº”çš„è§’è‰²ã€‚</li>
</ul>
<pre><code>    String[] ignoreUrls = new String[]&#123;
            &quot;/user/.*&quot;,
            &quot;/cat/.*&quot;,
            &quot;/app/.*&quot;,
            &quot;/error&quot;
    &#125;;
 public boolean preHandle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler) throws Exception &#123;

        // 0 æ£€éªŒå…¬å…±å‚æ•°
        if(!checkParams(&quot;platform&quot;,httpServletRequest,httpServletResponse))&#123;
            return  false;
        &#125;

        // 1ã€å¿½ç•¥éªŒè¯çš„URL
        String url = httpServletRequest.getRequestURI().toString();
        for(String ignoreUrl :ignoreUrls)&#123;
            if(url.matches(ignoreUrl))&#123;
                return true;
            &#125;
        &#125;

        // 2ã€æŸ¥è¯¢éªŒè¯æ³¨è§£
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        Method method = handlerMethod.getMethod();
        // æŸ¥è¯¢æ³¨è§£
        AuthCheck authCheck = method.getAnnotation(AuthCheck.class);
        if (authCheck == null) &#123;
            // æ— æ³¨è§£ï¼Œä¸éœ€è¦
            return true;
        &#125;

        // 3ã€æœ‰æ³¨è§£ï¼Œå…ˆæ£€æŸ¥accessToken
        if(!checkParams(&quot;accessToken&quot;,httpServletRequest,httpServletResponse))&#123;
            return  false;
        &#125;
        // æ£€éªŒtokenæ˜¯å¦è¿‡æœŸ
        Integer userId = authService.getUserIdFromToken(httpServletRequest.getParameter(&quot;accessToken&quot;),
                httpServletRequest.getParameter(&quot;platform&quot;));
        if(userId==null)&#123;
            logger.debug(&quot;accessToken timeout&quot;);
            output(ResponseResult.Builder.error(&quot;accessTokenå·²è¿‡æœŸ&quot;).build(),httpServletResponse);
            return false;
        &#125;

        // 4ã€å†æ£€éªŒæ˜¯å¦åŒ…å«å¿…è¦çš„è§’è‰²
        if(authCheck.roles()!=null&amp;&amp;authCheck.roles().length&gt;0)&#123;
            User user = authService.getUser(userId);
            boolean isMatch = false;
            for(String role : authCheck.roles())&#123;
                if(user.getRole().getName().equals(role))&#123;
                    isMatch =  true;
                    break;
                &#125;
            &#125;
            // è§’è‰²æœªåŒ¹é…ï¼ŒéªŒè¯å¤±è´¥
            if(!isMatch)&#123;
                return false;
            &#125;
        &#125;

        return true;
    &#125;
</code></pre>
<h1 id="æœåŠ¡å“åº”ç»“æœå°è£…"><a href="#æœåŠ¡å“åº”ç»“æœå°è£…" class="headerlink" title="æœåŠ¡å“åº”ç»“æœå°è£…"></a>æœåŠ¡å“åº”ç»“æœå°è£…</h1><p>å¢åŠ ä¸€ä¸ªBuilderï¼Œæ–¹ä¾¿ç”Ÿæˆæœ€ç»ˆç»“æœ</p>
<pre><code>public class ResponseResult &#123;

    public static class Builder&#123;
        ResponseResult responseResult;

        Map&lt;String,Object&gt; dataMap = Maps.newHashMap();

        public Builder()&#123;
            this.responseResult = new ResponseResult();
        &#125;

        public Builder(String state)&#123;
            this.responseResult = new ResponseResult(state);
        &#125;


        public static Builder newBuilder()&#123;
           return new Builder();
        &#125;

        public static Builder success()&#123;
            return new Builder(&quot;success&quot;);
        &#125;

        public static Builder error(String message)&#123;
            Builder builder =  new Builder(&quot;error&quot;);
            builder.responseResult.setError(message);
            return builder;
        &#125;

        public  Builder append(String key,Object data)&#123;
            this.dataMap.put(key,data);
            return this;
        &#125;

        /**
         *  è®¾ç½®åˆ—è¡¨æ•°æ®
         * @param datas æ•°æ®
         * @return
         */
        public  Builder setListData(List&lt;?&gt; datas)&#123;
            this.dataMap.put(&quot;result&quot;,datas);
            this.dataMap.put(&quot;total&quot;,datas.size());
            return this;
        &#125;

        public  Builder setData(Object data)&#123;
            this.dataMap.clear();
            this.responseResult.setData(data);
            return this;
        &#125;

        boolean wrapData = false;

        /**
         * å°†æ•°æ®åŒ…è£¹åœ¨dataä¸­
         * @param wrapData
         * @return
         */
        public  Builder wrap(boolean wrapData)&#123;
            this.wrapData = wrapData;
            return this;
        &#125;

        public String build()&#123;

            JSONObject jsonObject = new JSONObject();
            jsonObject.put(&quot;state&quot;,this.responseResult.getState());
            if(this.responseResult.getState().equals(&quot;error&quot;))&#123;
                jsonObject.put(&quot;error&quot;,this.responseResult.getError());
            &#125;
            if(this.responseResult.getData()!=null)&#123;
                jsonObject.put(&quot;data&quot;, JSON.toJSON(this.responseResult.getData()));
            &#125;else  if(dataMap.size()&gt;0)&#123;
                if(wrapData) &#123;
                    JSONObject data = new JSONObject();
                    dataMap.forEach((key, value) -&gt; &#123;
                        data.put(key, value);
                    &#125;);
                    jsonObject.put(&quot;data&quot;, data);
                &#125;else&#123;
                    dataMap.forEach((key, value) -&gt; &#123;
                        jsonObject.put(key, value);
                    &#125;);
                &#125;
            &#125;
            return jsonObject.toJSONString();
        &#125;

    &#125;

    private String state;
    private Object data;
    private String error;


    public String getError() &#123;
        return error;
    &#125;

    public void setError(String error) &#123;
        this.error = error;
    &#125;

    public ResponseResult()&#123;&#125;

    public ResponseResult(String rc)&#123;
        this.state = rc;
    &#125;

    /**
     * æˆåŠŸæ—¶è¿”å›
     * @param rc
     * @param result
     */
    public ResponseResult(String rc, Object result)&#123;
        this.state = rc;
        this.data = result;
    &#125;

    public String getState() &#123;
        return state;
    &#125;

    public void setState(String state) &#123;
        this.state = state;
    &#125;

    public Object getData() &#123;
        return data;
    &#125;

    public void setData(Object data) &#123;
        this.data = data;
    &#125;

&#125;
</code></pre>
<p>è°ƒç”¨æ—¶å¯ä»¥ä¼˜é›…ä¸€ç‚¹</p>
<pre><code>    @RequestMapping(value = &#123;&quot;/user/login&quot;,&quot;/pc/user/login&quot;&#125;, produces = &quot;application/json;charset=utf-8&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)
    @ResponseBody
    public String login(String userName,String password,Integer platform) &#123;
        User user = this.authService.login(userName,password);
        if(user!=null)&#123;
            //  ç™»é™†
            String token = authService.updateToken(user,platform);
            return ResponseResult.Builder                 .success()
                    .append(&quot;accessToken&quot;,token)
                    .append(&quot;userId&quot;,user.getId())
                    .build();
        &#125;
        return ResponseResult.Builder.error(&quot;ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯&quot;).build();
    &#125;
    protected String error(String message)&#123;
        return  ResponseResult.Builder.error(message).build();
    &#125;

    protected String success()&#123;
        return  ResponseResult.Builder
                .success()
                .build();
    &#125;

    protected String successDataList(List&lt;?&gt; data)&#123;
        return ResponseResult.Builder
                .success()
                .wrap(true) // dataåŒ…è£¹
                .setListData(data)
                .build();
    &#125;
</code></pre>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/12/01/jqpeng-%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81%E4%B9%8Bzookeeper(1)%20--%20%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/12/01/jqpeng-%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81%E4%B9%8Bzookeeper(1)%20--%20%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) -- å¯åŠ¨åˆ†æ</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-12-01 14:43:00" itemprop="dateCreated datePublished" datetime="2017-12-01T14:43:00+08:00">2017-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>20 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/7942234.html">ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) â€“ å¯åŠ¨åˆ†æ</a></p>
<p>ä»æœ¬æ–‡å¼€å§‹ï¼Œä¸å®šæœŸåˆ†æä¸€ä¸ªå¼€æºé¡¹ç›®æºä»£ç ï¼Œèµ·ç¯‡ä»å¤§åé¼é¼çš„zookeeperå¼€å§‹ã€‚<br> ä¸ºä»€ä¹ˆæ˜¯zkï¼Œå› ä¸ºç”¨åˆ°zkçš„åœºæ™¯å®åœ¨å¤ªå¤šäº†ï¼Œå¤§éƒ¨åˆ†è€³ç†Ÿèƒ½è¯¦çš„åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æœ‰zookeeperçš„å½±å­ï¼Œæ¯”å¦‚hbaseï¼Œstormï¼Œdubboï¼Œkafkaç­‰ç­‰ï¼Œå¦å¤–å‰é¢æåˆ°çš„<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi/p/java-rpc.html">RPCæ¡†æ¶åŸç†ä¸å®ç°</a>ä¹Ÿç”¨åˆ°äº†zookeeperã€‚</p>
<p>ç›®å½•</p>
<ul>
<li>1 ç¯å¢ƒå‡†å¤‡<ul>
<li>1.1 å¯¼å…¥ä»£ç </li>
<li>1.2 è®¾ç½®é…ç½®æ–‡ä»¶</li>
<li>1.3 è°ƒè¯•é…ç½®</li>
</ul>
</li>
<li>2 å¯åŠ¨åˆ†æ<ul>
<li>2.1 QuorumPeerMain</li>
<li>2.2 ZooKeeperServerMain</li>
<li>2.3 ServerCnxnFactory</li>
<li>2.4 ZooKeeperServer</li>
<li>2.5 æœåŠ¡å¯åŠ¨<ul>
<li>2.5.1 é…ç½®cnxnFactory</li>
<li>2.5.2 å¯åŠ¨cnxnFactory<ul>
<li>socketå¤„ç†çº¿ç¨‹</li>
<li>socketç½‘ç»œè¯·æ±‚å¤„ç†</li>
<li>è¯»å–è¿æ¥è¯·æ±‚</li>
<li>åˆ›å»ºsession</li>
</ul>
</li>
<li>2.5.3 zkæœåŠ¡å™¨å¯åŠ¨<ul>
<li>SessionTracker</li>
</ul>
</li>
<li>2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»<ul>
<li>RequestProcessor</li>
<li>PrepRequestProcessor</li>
<li>SyncRequestProcessor</li>
<li>FinalRequestProcessor</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1 ç¯å¢ƒå‡†å¤‡"></a>1 ç¯å¢ƒå‡†å¤‡</h2><p>é¦–å…ˆï¼Œä¸‹è½½zkçš„æ–°ç‰ˆæœ¬ï¼Œæœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯3.4.10ï¼Œç”±äºå·²ä¸‹è½½3.4.9.å…ˆç›´æ¥ä½¿ç”¨ã€‚</p>
<h3 id="1-1-å¯¼å…¥ä»£ç "><a href="#1-1-å¯¼å…¥ä»£ç " class="headerlink" title="1.1 å¯¼å…¥ä»£ç "></a>1.1 å¯¼å…¥ä»£ç </h3><p>IDEAç›´æ¥æ‰“å¼€zkç›®å½•ï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/590166a796fb3.jpg" alt="enter description here" title="1493264040459"></p>
<p>é¡¹ç›®è®¾ç½®ä¸ºjdk1.7<br> ç„¶åï¼Œå°†src/javaä¸‹é¢çš„mainå’Œgeneratedè®¾ç½®ä¸ºæºç ç›®å½•ï¼ŒåŒæ—¶å°†libç›®å½•æ·»åŠ ä¸ºliabaryã€‚</p>
<h3 id="1-2-è®¾ç½®é…ç½®æ–‡ä»¶"><a href="#1-2-è®¾ç½®é…ç½®æ–‡ä»¶" class="headerlink" title="1.2 è®¾ç½®é…ç½®æ–‡ä»¶"></a>1.2 è®¾ç½®é…ç½®æ–‡ä»¶</h3><p>åœ¨confç›®å½•ï¼Œæ–°å»ºzoo.cfgï¼Œæ‹·è´sample.cfgå³å¯</p>
<p><img src="https://ooo.0o0.ooo/2017/04/27/5901674b5600d.jpg" alt="enter description here" title="1493264204261"></p>
<h3 id="1-3-è°ƒè¯•é…ç½®"><a href="#1-3-è°ƒè¯•é…ç½®" class="headerlink" title="1.3 è°ƒè¯•é…ç½®"></a>1.3 è°ƒè¯•é…ç½®</h3><p>æŸ¥çœ‹bin/zkServer</p>
<pre><code>set ZOOMAIN=org.apache.zookeeper.server.quorum.QuorumPeerMain
....
endlocal
</code></pre>
<p>è°ƒç”¨çš„æ˜¯org.apache.zookeeper.server.quorum.QuorumPeerMainï¼Œå› æ­¤QuorumPeerMainï¼Œé…ç½®è°ƒè¯•ç¨‹åºï¼Œargumentsè®¾ç½®conf/zoo.cfg</p>
<p><img src="https://ooo.0o0.ooo/2017/04/27/5901838aed112.jpg" alt="enter description here" title="1493271435981"></p>
<p>è¿™æ ·ï¼Œå°±å¯ä»¥æ„‰å¿«çš„Debugä»£ç äº†-ğŸ˜ƒ</p>
<h2 id="2-å¯åŠ¨åˆ†æ"><a href="#2-å¯åŠ¨åˆ†æ" class="headerlink" title="2 å¯åŠ¨åˆ†æ"></a>2 å¯åŠ¨åˆ†æ</h2><h3 id="2-1-QuorumPeerMain"><a href="#2-1-QuorumPeerMain" class="headerlink" title="2.1 QuorumPeerMain"></a>2.1 QuorumPeerMain</h3><p>QuorumPeerMainçš„mainé‡Œï¼Œè°ƒç”¨initializeAndRun</p>
<pre><code>    protected void initializeAndRun(String[] args)
        throws ConfigException, IOException
    &#123;
        QuorumPeerConfig config = new QuorumPeerConfig();
        if (args.length == 1) &#123;
            config.parse(args[0]);
        &#125;

        // Start and schedule the the purge task æ¸…ç†ä»»åŠ¡
        DatadirCleanupManager purgeMgr = new DatadirCleanupManager(config
                .getDataDir(), config.getDataLogDir(), config
                .getSnapRetainCount(), config.getPurgeInterval());
        purgeMgr.start();

        // é›†ç¾¤æ¨¡å¼
        if (args.length == 1 &amp;&amp; config.servers.size() &gt; 0) &#123;
            runFromConfig(config);
        &#125; else &#123;
            LOG.warn(&quot;Either no config or no quorum defined in config, running &quot;
                    + &quot; in standalone mode&quot;);
            // there is only server in the quorum -- run as standalone
            // å•æœºæ¨¡å¼
            ZooKeeperServerMain.main(args);
        &#125;
    &#125;
</code></pre>
<p>ä¸»è¦æ‰§è¡Œäº†ï¼š</p>
<ul>
<li>åŠ è½½è§£æé…ç½®æ–‡ä»¶åˆ°QuorumPeerConfig</li>
<li>æ‰§è¡Œæ¸…ç†ä»»åŠ¡</li>
<li>åˆ¤æ–­æ˜¯é›†ç¾¤æ¨¡å¼è¿˜æ˜¯å•æœºæ¨¡å¼ï¼Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æœªé…ç½®serverï¼Œæ‰€ä»¥æ˜¯å•æœºæ¨¡å¼ï¼Œæ‰§è¡Œ ZooKeeperServerMain.main</li>
</ul>
<blockquote>
<p>æœ¬æ–‡é‡ç‚¹åˆ†æå•æœºæ¨¡å¼ä¸‹çš„zkï¼Œé›†ç¾¤æ¨¡å¼æš‚æ—¶ä¸è§£è¯»</p>
</blockquote>
<h3 id="2-2-ZooKeeperServerMain"><a href="#2-2-ZooKeeperServerMain" class="headerlink" title="2.2 ZooKeeperServerMain"></a>2.2 ZooKeeperServerMain</h3><p>ZooKeeperServerMain.mainè°ƒç”¨initializeAndRun</p>
<pre><code> protected void initializeAndRun(String[] args)
        throws ConfigException, IOException
    &#123;
        try &#123;
            ManagedUtil.registerLog4jMBeans();
        &#125; catch (JMException e) &#123;
            LOG.warn(&quot;Unable to register log4j JMX control&quot;, e);
        &#125;

        ServerConfig config = new ServerConfig();
        if (args.length == 1) &#123;
            config.parse(args[0]);
        &#125; else &#123;
            config.parse(args);
        &#125;

        runFromConfig(config);
    &#125;```

è¯»å–é…ç½®ï¼Œç„¶årunFromConfigï¼š

``` java
 public void runFromConfig(ServerConfig config) throws IOException &#123;
        LOG.info(&quot;Starting server&quot;);
        FileTxnSnapLog txnLog = null;
        try &#123;
            // Note that this thread isn&#39;t going to be doing anything else,
            // so rather than spawning another thread, we will just call
            // run() in this thread.
            // create a file logger url from the command line args
            final ZooKeeperServer zkServer = new ZooKeeperServer();
            // Registers shutdown handler which will be used to know the
            // server error or shutdown state changes.
            final CountDownLatch shutdownLatch = new CountDownLatch(1);
            zkServer.registerServerShutdownHandler(
                    new ZooKeeperServerShutdownHandler(shutdownLatch));

            // å¿«ç…§
            txnLog = new FileTxnSnapLog(new File(config.dataLogDir), new File(
                    config.dataDir));
            zkServer.setTxnLogFactory(txnLog);
            zkServer.setTickTime(config.tickTime);
            zkServer.setMinSessionTimeout(config.minSessionTimeout);
            zkServer.setMaxSessionTimeout(config.maxSessionTimeout);
            // socketå·¥å‚
            cnxnFactory = ServerCnxnFactory.createFactory();
            cnxnFactory.configure(config.getClientPortAddress(),
                    config.getMaxClientCnxns());
            cnxnFactory.startup(zkServer);

            // Watch status of ZooKeeper server. It will do a graceful shutdown
            // if the server is not running or hits an internal error.
            shutdownLatch.await();
            shutdown();

            cnxnFactory.join();
            if (zkServer.canShutdown()) &#123;
                zkServer.shutdown();
            &#125;
        &#125; catch (InterruptedException e) &#123;
            // warn, but generally this is ok
            LOG.warn(&quot;Server interrupted&quot;, e);
        &#125; finally &#123;
            if (txnLog != null) &#123;
                txnLog.close();
            &#125;
        &#125;
    &#125;
</code></pre>
<p>å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>åˆ›å»ºzkServerï¼Œå¯¹ZooKeeperServerè®¾ç½®ä¸€äº›é…ç½®å‚æ•°ï¼Œå¦‚tickTimeã€minSessionTimeoutã€maxSessionTimeout</li>
<li>åˆ›å»ºCountDownLatchï¼Œæ³¨é‡Šé‡Œå†™äº†ï¼Œç”¨æ¥watch zkçš„çŠ¶æ€ï¼Œå½“zkå…³é—­æˆ–è€…å‡ºç°å†…éƒ¨é”™è¯¯çš„æ—¶å€™<strong>ä¼˜é›…</strong>çš„å…³é—­æœåŠ¡</li>
<li>æ ¹æ®é…ç½®å‚æ•°dataLogDirå’ŒdataDiråˆ›å»ºFileTxnSnapLogï¼Œç”¨æ¥å­˜å‚¨zkæ•°æ®å’Œæ—¥å¿—å¿«ç…§</li>
<li>åˆ›å»ºcnxnFactoryï¼Œzkçš„ socketå·¥å‚ï¼Œè´Ÿè´£å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œzké‡Œæœ‰nettyå’ŒNIOä¸¤ç§å®ç°</li>
<li>cnxnFactory.startup(zkServer)ï¼Œå¯åŠ¨zkæœåŠ¡å™¨</li>
</ul>
<h3 id="2-3-ServerCnxnFactory"><a href="#2-3-ServerCnxnFactory" class="headerlink" title="2.3 ServerCnxnFactory"></a>2.3 ServerCnxnFactory</h3><p>cnxnFactoryè´Ÿè´£zkçš„ç½‘ç»œè¯·æ±‚ï¼ŒcreateFactoryä¸­ï¼Œä»ç³»ç»Ÿé…ç½®ä¸­è¯»å–ZOOKEEPER_SERVER_CNXN_FACTORYï¼Œé»˜è®¤æ˜¯æ²¡æœ‰è¿™ä¸ªé…ç½®çš„ï¼Œå› æ­¤é»˜è®¤æ˜¯ä½¿ç”¨NIOServerCnxnFactoryï¼ŒåŸºäºjavaçš„NIOå®ç°ï¼Œ</p>
<pre><code>    static public ServerCnxnFactory createFactory() throws IOException &#123;
        String serverCnxnFactoryName =
            System.getProperty(ZOOKEEPER_SERVER_CNXN_FACTORY);
        if (serverCnxnFactoryName == null) &#123;
            serverCnxnFactoryName = NIOServerCnxnFactory.class.getName();
        &#125;
        try &#123;
            return (ServerCnxnFactory) Class.forName(serverCnxnFactoryName)
                                                .newInstance();
        &#125; catch (Exception e) &#123;
            IOException ioe = new IOException(&quot;Couldn&#39;t instantiate &quot;
                    + serverCnxnFactoryName);
            ioe.initCause(e);
            throw ioe;
        &#125;
    &#125;
</code></pre>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“å‘ç°ï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/59018f04f17b9.jpg" alt="enter description here" title="1493274374075"></p>
<p>ServerCnxnFactoryè¿˜æœ‰ä¸ªNettyServerCnxnFactoryå®ç°ï¼ŒåŸºäºNettyå®ç°NIOã€‚ServerCnxnFactoryé‡Œå…·ä½“è´Ÿè´£ä»€ä¹ˆï¼Œåé¢å†æ¥çœ‹ã€‚</p>
<h3 id="2-4-ZooKeeperServer"><a href="#2-4-ZooKeeperServer" class="headerlink" title="2.4 ZooKeeperServer"></a>2.4 ZooKeeperServer</h3><p>ç°åœ¨ï¼Œä¸»è§’ç™»åœºï¼Œæˆ‘ä»¬æ¥çœ‹ZooKeeperServerå†…éƒ¨æœ‰ä»€ä¹ˆç„å¦™ã€‚<br><img src="https://ooo.0o0.ooo/2017/04/27/59018cc60446f.jpg" alt="enter description here" title="1493273799033"></p>
<p>ZooKeeperServeræ˜¯å•æœºæ¨¡å¼ä½¿ç”¨çš„ç±»ï¼Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨çš„æ˜¯å®ƒçš„å­ç±»ã€‚<br> æˆ‘ä»¬å…ˆæ¥çœ‹ZooKeeperServeråŒ…å«å“ªäº›å†…å®¹ï¼š</p>
<pre><code>    public static final int DEFAULT_TICK_TIME = 3000;
    protected int tickTime = DEFAULT_TICK_TIME;
    /** value of -1 indicates unset, use default */
    protected int minSessionTimeout = -1;
    /** value of -1 indicates unset, use default */
    protected int maxSessionTimeout = -1;
    protected SessionTracker sessionTracker; //åˆ›å»ºå’Œç®¡ç†session
    private FileTxnSnapLog txnLogFactory = null; //æ–‡ä»¶å¿«ç…§
    private ZKDatabase zkDb; // ZooKeeperæ ‘å½¢æ•°æ®çš„æ¨¡å‹
    private final AtomicLong hzxid = new AtomicLong(0); //åŸå­å¢é•¿Longï¼Œç”¨äºåˆ†é…äº‹åŠ¡ç¼–å·
    public final static Exception ok = new Exception(&quot;No prob&quot;);
    protected RequestProcessor firstProcessor; // ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä¸­çš„ç¬¬ä¸€ä¸ªå¤„ç†å™¨
    protected volatile State state = State.INITIAL;

    protected enum State &#123;
        INITIAL, RUNNING, SHUTDOWN, ERROR;
    &#125;

    /**
     * This is the secret that we use to generate passwords, for the moment it
     * is more of a sanity check.
     */
    static final private long superSecret = 0XB3415C00L;

    private final AtomicInteger requestsInProcess = new AtomicInteger(0);
    final List&lt;ChangeRecord&gt; outstandingChanges = new ArrayList&lt;ChangeRecord&gt;();
    // this data structure must be accessed under the outstandingChanges lock
    final HashMap&lt;String, ChangeRecord&gt; outstandingChangesForPath =
        new HashMap&lt;String, ChangeRecord&gt;();
    
    private ServerCnxnFactory serverCnxnFactory; //ServerSocketå·¥å‚ï¼Œæ¥å—å®¢æˆ·ç«¯çš„socketè¿æ¥

    private final ServerStats serverStats; //serverçš„è¿è¡ŒçŠ¶æ€ç»Ÿè®¡
    private final ZooKeeperServerListener listener; // ZKè¿è¡ŒçŠ¶æ€ç›‘å¬
    private ZooKeeperServerShutdownHandler zkShutdownHandler;
</code></pre>
<h3 id="2-5-æœåŠ¡å¯åŠ¨"><a href="#2-5-æœåŠ¡å¯åŠ¨" class="headerlink" title="2.5 æœåŠ¡å¯åŠ¨"></a>2.5 æœåŠ¡å¯åŠ¨</h3><p>å‰é¢æœ‰ç‚¹è·‘åï¼Œç»§ç»­å›å½’å¯åŠ¨è¿‡ç¨‹:</p>
<pre><code>            cnxnFactory = ServerCnxnFactory.createFactory();
            cnxnFactory.configure(config.getClientPortAddress(),
                    config.getMaxClientCnxns());
            cnxnFactory.startup(zkServer);
</code></pre>
<h4 id="2-5-1-é…ç½®cnxnFactory"><a href="#2-5-1-é…ç½®cnxnFactory" class="headerlink" title="2.5.1 é…ç½®cnxnFactory"></a>2.5.1 é…ç½®cnxnFactory</h4><p>è¿›å…¥configureï¼š</p>
<pre><code>    @Override
    public void configure(InetSocketAddress addr, int maxcc) throws IOException &#123;
        configureSaslLogin();

        // ZKç½‘ç»œè¯·æ±‚ä¸»çº¿ç¨‹
        thread = new ZooKeeperThread(this, &quot;NIOServerCxn.Factory:&quot; + addr);
        thread.setDaemon(true);

        maxClientCnxns = maxcc;
        this.ss = ServerSocketChannel.open();
        ss.socket().setReuseAddress(true);
        LOG.info(&quot;binding to port &quot; + addr);
        ss.socket().bind(addr);
        ss.configureBlocking(false);
        ss.register(selector, SelectionKey.OP_ACCEPT);
    &#125;
</code></pre>
<p>å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>configureSaslLoginï¼Œå…·ä½“ä¸ç»†çœ‹ï¼Œåº”è¯¥æ˜¯å¤„ç†é‰´æƒ</li>
<li>åˆå§‹åŒ–ZooKeeperThreadï¼Œè¿™ä¸ªZooKeeperThreadçš„ä½œç”¨æ˜¯è´Ÿè´£å¤„ç†æœªå¤„ç†å¼‚å¸¸ï¼š</li>
</ul>
<pre><code>public class ZooKeeperThread extends Thread &#123;

    private static final Logger LOG = LoggerFactory
            .getLogger(ZooKeeperThread.class);

    private UncaughtExceptionHandler uncaughtExceptionalHandler = new UncaughtExceptionHandler() &#123;

        @Override
        public void uncaughtException(Thread t, Throwable e) &#123;
            handleException(t.getName(), e);
        &#125;
    &#125;;

    public ZooKeeperThread(Runnable thread, String threadName) &#123;
        super(thread, threadName);
        setUncaughtExceptionHandler(uncaughtExceptionalHandler);
    &#125;

    protected void handleException(String thName, Throwable e) &#123;
        LOG.warn(&quot;Exception occured from thread &#123;&#125;&quot;, thName, e);
    &#125;
&#125;
</code></pre>
<ul>
<li>å¯åŠ¨ServerSocketChannelï¼Œå¹¶ç»‘å®šé…ç½®çš„addrï¼Œå¹¶ä¸”æ³¨å†Œselectorï¼ˆå¯ä»¥æœç´¢NIOäº†è§£ç»†èŠ‚ï¼‰</li>
</ul>
<h4 id="2-5-2-å¯åŠ¨cnxnFactory"><a href="#2-5-2-å¯åŠ¨cnxnFactory" class="headerlink" title="2.5.2 å¯åŠ¨cnxnFactory"></a>2.5.2 å¯åŠ¨cnxnFactory</h4><p>ç»§ç»­åˆ†æï¼Œè¿›å…¥cnxnFactory.startup(zkServer)</p>
<pre><code>    @Override
    public void startup(ZooKeeperServer zks) throws IOException,
            InterruptedException &#123;
        start();
        setZooKeeperServer(zks);
        zks.startdata();
        zks.startup();
    &#125;
</code></pre>
<p>é¦–å…ˆï¼Œstartï¼Œåˆ¤æ–­çº¿ç¨‹çŠ¶æ€ï¼Œå¦‚æœæœªå¯åŠ¨åˆ™å¯åŠ¨çº¿ç¨‹ï¼Œæ³¨æ„åªä¼šå¯åŠ¨ä¸€æ¬¡ã€‚</p>
<pre><code>    @Override
    public void start() &#123;
        // ensure thread is started once and only once
        if (thread.getState() == Thread.State.NEW) &#123;
            thread.start();
        &#125;
    &#125;
</code></pre>
<h5 id="socketå¤„ç†çº¿ç¨‹"><a href="#socketå¤„ç†çº¿ç¨‹" class="headerlink" title="socketå¤„ç†çº¿ç¨‹"></a>socketå¤„ç†çº¿ç¨‹</h5><p>å¯åŠ¨åï¼Œå°±ä¼šæ‰§è¡ŒcnxnFactory.run</p>
<pre><code>    public void run() &#123;
        while (!ss.socket().isClosed()) &#123;
            try &#123;
                selector.select(1000);
                Set&lt;SelectionKey&gt; selected;
                synchronized (this) &#123;
                    selected = selector.selectedKeys();
                &#125;
                ArrayList&lt;SelectionKey&gt; selectedList = new ArrayList&lt;SelectionKey&gt;(
                        selected);
                Collections.shuffle(selectedList);
                for (SelectionKey k : selectedList) &#123;
                    if ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != 0) &#123;
                        SocketChannel sc = ((ServerSocketChannel) k
                                .channel()).accept();
                        InetAddress ia = sc.socket().getInetAddress();
                        int cnxncount = getClientCnxnCount(ia);
                        if (maxClientCnxns &gt; 0 &amp;&amp; cnxncount &gt;= maxClientCnxns)&#123;
                            LOG.warn(&quot;Too many connections from &quot; + ia
                                     + &quot; - max is &quot; + maxClientCnxns );
                            sc.close();
                        &#125; else &#123;
                            LOG.info(&quot;Accepted socket connection from &quot;
                                     + sc.socket().getRemoteSocketAddress());
                            sc.configureBlocking(false);
                            SelectionKey sk = sc.register(selector,
                                    SelectionKey.OP_READ);
                            NIOServerCnxn cnxn = createConnection(sc, sk);
                            sk.attach(cnxn);
                            addCnxn(cnxn);
                        &#125;
                    &#125; else if ((k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != 0) &#123;
                        NIOServerCnxn c = (NIOServerCnxn) k.attachment();
                        c.doIO(k);
                    &#125; else &#123;
                        if (LOG.isDebugEnabled()) &#123;
                            LOG.debug(&quot;Unexpected ops in select &quot;
                                      + k.readyOps());
                        &#125;
                    &#125;
                &#125;
                selected.clear();
            &#125; catch (RuntimeException e) &#123;
                LOG.warn(&quot;Ignoring unexpected runtime exception&quot;, e);
            &#125; catch (Exception e) &#123;
                LOG.warn(&quot;Ignoring exception&quot;, e);
            &#125;
        &#125;
        closeAll();
        LOG.info(&quot;NIOServerCnxn factory exited run method&quot;);
    &#125;
</code></pre>
<p>è¿™é‡Œç›¸å½“äºä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¿æ¥ï¼Œé€šè¿‡selector.select(1000)æ¥è·å–ç½‘ç»œè¯·æ±‚ï¼Œä¸€æ—¦æœ‰è¿æ¥å°±ç»ªï¼Œåˆ™å¼€å§‹å¤„ç†ï¼š</p>
<ul>
<li>é¦–å…ˆæ‰“ä¹± Collections.shuffle(selectedList);</li>
<li>forå¾ªç¯å¤„ç†<ul>
<li>å¦‚æœSelectionKey.OP_ACCEPTï¼Œä»£è¡¨ä¸€ä¸ªæ–°è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºSocketChannelï¼Œåˆ›å»ºNIOServerCnxnï¼Œç„¶åaddCnxn</li>
<li>å¦‚æœå¯è¯»å†™ï¼Œåˆ™ NIOServerCnxn.doIO(k)ï¼Œæ‰§è¡ŒIOæ“ä½œ</li>
</ul>
</li>
</ul>
<h5 id="socketç½‘ç»œè¯·æ±‚å¤„ç†"><a href="#socketç½‘ç»œè¯·æ±‚å¤„ç†" class="headerlink" title="socketç½‘ç»œè¯·æ±‚å¤„ç†"></a>socketç½‘ç»œè¯·æ±‚å¤„ç†</h5><p>è¿™é‡Œç®€å•åˆ†æä¸‹doIO,æ‘˜å½•éƒ¨åˆ†ä»£ç ï¼š</p>
<pre><code>void doIO(SelectionKey k) throws InterruptedException &#123;
        try &#123;
            if (isSocketOpen() == false) &#123;
                LOG.warn(&quot;trying to do i/o on a null socket for session:0x&quot;
                         + Long.toHexString(sessionId));

                return;
            &#125;
            if (k.isReadable()) &#123;
                // è¯»å–4ä¸ªå­—èŠ‚
                int rc = sock.read(incomingBuffer);
                if (rc &lt; 0) &#123;
                    throw new EndOfStreamException(
                            &quot;Unable to read additional data from client sessionid 0x&quot;
                            + Long.toHexString(sessionId)
                            + &quot;, likely client has closed socket&quot;);
                &#125;
                // è¯»æ»¡äº†
                if (incomingBuffer.remaining() == 0) &#123;
                    boolean isPayload;
                    if (incomingBuffer == lenBuffer) &#123; // start of next request
                        incomingBuffer.flip(); // å¤ä½
                        isPayload = readLength(k); // è¯»å–è½½è·é•¿åº¦
                        incomingBuffer.clear();
                    &#125; else &#123;
                        // continuation
                        isPayload = true;
                    &#125;
                    if (isPayload) &#123; // not the case for 4letterword
                        readPayload();
                    &#125;
                    else &#123;
                        // four letter words take care
                        // need not do anything else
                        return;
                    &#125;
                &#125;
            &#125;
</code></pre>
<p>è¯»å–4ä¸ªå­—èŠ‚ï¼Œè·å–åˆ°æ•°æ®é•¿åº¦ï¼Œç„¶åè¯»å–è½½è·ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚</p>
<pre><code>    private void readPayload() throws IOException, InterruptedException &#123;
        if (incomingBuffer.remaining() != 0) &#123; // have we read length bytes?
            int rc = sock.read(incomingBuffer); // sock is non-blocking, so ok
            if (rc &lt; 0) &#123;
                throw new EndOfStreamException(
                        &quot;Unable to read additional data from client sessionid 0x&quot;
                        + Long.toHexString(sessionId)
                        + &quot;, likely client has closed socket&quot;);
            &#125;
        &#125;

        if (incomingBuffer.remaining() == 0) &#123; // have we read length bytes?
            packetReceived();
            incomingBuffer.flip(); // å¤ä½
            if (!initialized) &#123;
                readConnectRequest(); // è¯»å–è¿æ¥è¯·æ±‚
            &#125; else &#123;
                readRequest();
            &#125;
            lenBuffer.clear();
            incomingBuffer = lenBuffer;
        &#125;
    &#125;
</code></pre>
<p>å…ˆæ˜¯è¯»å–æ•°æ®ï¼Œç„¶åå†è¯»å–è¯·æ±‚ï¼Œè¿™é‡Œå…³æ³¨readConnectRequest</p>
<h5 id="è¯»å–è¿æ¥è¯·æ±‚"><a href="#è¯»å–è¿æ¥è¯·æ±‚" class="headerlink" title="è¯»å–è¿æ¥è¯·æ±‚"></a>è¯»å–è¿æ¥è¯·æ±‚</h5><pre><code>    private void readConnectRequest() throws IOException, InterruptedException &#123;
        if (zkServer == null) &#123;
            throw new IOException(&quot;ZooKeeperServer not running&quot;);
        &#125;
        zkServer.processConnectRequest(this, incomingBuffer);
        initialized = true;
    &#125;
</code></pre>
<p>ç»§ç»­ï¼Œä¸‹é¢æ˜¯å¤„ç†è¿æ¥è¯·æ±‚ï¼š</p>
<pre><code>     public void processConnectRequest(ServerCnxn cnxn, ByteBuffer incomingBuffer) throws IOException &#123;
        BinaryInputArchive bia = BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer));
        ConnectRequest connReq = new ConnectRequest();
        connReq.deserialize(bia, &quot;connect&quot;); // ååºåˆ—åŒ–è¯·æ±‚
        ....
        // å®¢æˆ·ç«¯è®¾ç½®çš„è¶…æ—¶æ—¶é—´
        int sessionTimeout = connReq.getTimeOut();
        byte passwd[] = connReq.getPasswd();
        int minSessionTimeout = getMinSessionTimeout();
        if (sessionTimeout &lt; minSessionTimeout) &#123;
            sessionTimeout = minSessionTimeout;
        &#125;
        // æœåŠ¡ç«¯è®¾ç½®çš„æœ€å¤§è¶…æ—¶æ—¶é—´
        int maxSessionTimeout = getMaxSessionTimeout();
        if (sessionTimeout &gt; maxSessionTimeout) &#123;
            sessionTimeout = maxSessionTimeout;
        &#125;
        cnxn.setSessionTimeout(sessionTimeout);
        // We don&#39;t want to receive any packets until we are sure that the
        // session is setup
        cnxn.disableRecv();
        // è¯·æ±‚æ˜¯å¦å¸¦ä¸Šsessionid
        long sessionId = connReq.getSessionId();
        if (sessionId != 0) &#123;
            // è¯·æ±‚å¸¦äº†sessionid
            long clientSessionId = connReq.getSessionId();
            LOG.info(&quot;Client attempting to renew session 0x&quot;
                    + Long.toHexString(clientSessionId)
                    + &quot; at &quot; + cnxn.getRemoteSocketAddress());
            // å…³é—­è¯·æ±‚
            serverCnxnFactory.closeSession(sessionId);
            cnxn.setSessionId(sessionId);
            // é‡æ–°æ‰“å¼€è¯·æ±‚
            reopenSession(cnxn, sessionId, passwd, sessionTimeout);
        &#125; else &#123;
            LOG.info(&quot;Client attempting to establish new session at &quot;
                    + cnxn.getRemoteSocketAddress());
            // åˆ›å»ºæ–°sesssion
            createSession(cnxn, passwd, sessionTimeout);
        &#125;
    &#125;
</code></pre>
<p>ä»¥ä¸Šå®Œæˆï¼š</p>
<ul>
<li>å°†è¯»å–å‡ºæ¥çš„incomingBufferååºåˆ—åŒ–ä¸ºConnectRequestå¯¹è±¡</li>
<li>ç„¶åè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ŒServerCnxnæ¥æ”¶åˆ°è¯¥ç”³è¯·åï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„sessionTimeoutæ—¶é—´ä»¥åŠZooKeeperServeræœ¬èº«çš„minSessionTimeoutã€maxSessionTimeoutå‚æ•°ï¼Œç¡®å®šæœ€ç»ˆçš„sessionTimeoutæ—¶é—´</li>
<li>åˆ¤æ–­å®¢æˆ·ç«¯çš„è¯·æ±‚æ˜¯å¦å·²ç»å«æœ‰sessionId<ul>
<li>å¦‚æœå«æœ‰ï¼Œåˆ™æ‰§è¡ŒsessionIdçš„æ˜¯å¦è¿‡æœŸã€å¯†ç æ˜¯å¦æ­£ç¡®ç­‰æ£€æŸ¥</li>
<li>å¦‚æœæ²¡æœ‰sessionIdï¼Œåˆ™åˆ›å»ºä¸€ä¸ªsession</li>
</ul>
</li>
</ul>
<h5 id="åˆ›å»ºsession"><a href="#åˆ›å»ºsession" class="headerlink" title="åˆ›å»ºsession"></a>åˆ›å»ºsession</h5><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å†çœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºsessionï¼š</p>
<pre><code>    long createSession(ServerCnxn cnxn, byte passwd[], int timeout) &#123;
        long sessionId = sessionTracker.createSession(timeout);
        Random r = new Random(sessionId ^ superSecret);
        r.nextBytes(passwd);
        ByteBuffer to = ByteBuffer.allocate(4);
        to.putInt(timeout);
        cnxn.setSessionId(sessionId);
        submitRequest(cnxn, sessionId, OpCode.createSession, 0, to, null);
        return sessionId;
    &#125;
</code></pre>
<ul>
<li>ä½¿ç”¨sessionTrackerç”Ÿæˆä¸€ä¸ªsessionId</li>
<li>submitRequestæ„å»ºä¸€ä¸ªRequestè¯·æ±‚ï¼Œè¯·æ±‚çš„ç±»å‹ä¸ºOpCode.createSession</li>
</ul>
<pre><code>    private void submitRequest(ServerCnxn cnxn, long sessionId, int type,
            int xid, ByteBuffer bb, List&lt;Id&gt; authInfo) &#123;
        Request si = new Request(cnxn, sessionId, xid, type, bb, authInfo);
        submitRequest(si);
    &#125;
    
    public void submitRequest(Request si) &#123;
        if (firstProcessor == null) &#123;
            synchronized (this) &#123;
                try &#123;
                    // Since all requests are passed to the request
                    // processor it should wait for setting up the request
                    // processor chain. The state will be updated to RUNNING
                    // after the setup.
                    while (state == State.INITIAL) &#123;
                        wait(1000);
                    &#125;
                &#125; catch (InterruptedException e) &#123;
                    LOG.warn(&quot;Unexpected interruption&quot;, e);
                &#125;
                if (firstProcessor == null || state != State.RUNNING) &#123;
                    throw new RuntimeException(&quot;Not started&quot;);
                &#125;
            &#125;
        &#125;
        try &#123;
            touch(si.cnxn);
            boolean validpacket = Request.isValid(si.type);
            if (validpacket) &#123;
                firstProcessor.processRequest(si);
                if (si.cnxn != null) &#123;
                    incInProcess();
                &#125;
            &#125; else &#123;
                LOG.warn(&quot;Received packet at server of unknown type &quot; + si.type);
                new UnimplementedRequestProcessor().processRequest(si);
            &#125;
        &#125; catch (MissingSessionException e) &#123;
            if (LOG.isDebugEnabled()) &#123;
                LOG.debug(&quot;Dropping request: &quot; + e.getMessage());
            &#125;
        &#125; catch (RequestProcessorException e) &#123;
            LOG.error(&quot;Unable to process request:&quot; + e.getMessage(), e);
        &#125;
    &#125;
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªRequest</li>
<li>ç­‰å¾…firstProcessoråˆ›å»ºå®Œæˆï¼Œç„¶åè°ƒç”¨firstProcessor.processRequest</li>
</ul>
<blockquote>
<p>firstProcessoræ˜¯ä»€ä¹ˆä¸œä¸œï¼Œä¸‹é¢å†æ­æ™“</p>
</blockquote>
<h4 id="2-5-3-zkæœåŠ¡å™¨å¯åŠ¨"><a href="#2-5-3-zkæœåŠ¡å™¨å¯åŠ¨" class="headerlink" title="2.5.3 zkæœåŠ¡å™¨å¯åŠ¨"></a>2.5.3 zkæœåŠ¡å™¨å¯åŠ¨</h4><p>å†æ¬¡å›åˆ°startupï¼Œ  setZooKeeperServer(zks)ï¼Œä»£ç å¾ˆç®€å•</p>
<pre><code> final public void setZooKeeperServer(ZooKeeperServer zk) &#123;
        this.zkServer = zk;
        if (zk != null) &#123;
            zk.setServerCnxnFactory(this);
        &#125;
    &#125;
</code></pre>
<p>ç„¶åæ˜¯zkæœåŠ¡å™¨çš„startdata:</p>
<pre><code>    public void startdata() 
    throws IOException, InterruptedException &#123;
        //check to see if zkDb is not null
        if (zkDb == null) &#123;
            zkDb = new ZKDatabase(this.txnLogFactory);
        &#125;  
        if (!zkDb.isInitialized()) &#123;
            loadData();
        &#125;
    &#125;
</code></pre>
<p>åˆå§‹åŒ–ZKDatabaseï¼Œä»txnLogFactoryé‡Œè¯»å–å¿«ç…§æ•°æ®ã€‚</p>
<p>æœ€åæ˜¯zkæœåŠ¡å™¨çš„startupï¼š</p>
<pre><code>    public synchronized void startup() &#123;
        if (sessionTracker == null) &#123;
            createSessionTracker();
        &#125;
        startSessionTracker();
        setupRequestProcessors();

        registerJMX();

        setState(State.RUNNING);
        notifyAll();
    &#125;
</code></pre>
<p>å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>createSessionTrackeråˆ›å»ºsessionTracker</li>
<li>startSessionTrackerå¯åŠ¨SessionTracker</li>
<li>setupRequestProcessors åˆ›å»ºè¯·æ±‚å¤„ç†å™¨é“¾</li>
<li>registerJMX æ³¨å†ŒJMX</li>
<li>setState(State.RUNNING) è®¾ç½®çŠ¶æ€ä¸ºè¿è¡Œä¸­</li>
</ul>
<h5 id="SessionTracker"><a href="#SessionTracker" class="headerlink" title="SessionTracker"></a>SessionTracker</h5><p>çœ‹SessionTrackerçš„æ³¨é‡Šï¼š</p>
<blockquote>
<p>This is the basic interface that ZooKeeperServer uses to track sessions.<br> è´Ÿè´£è¿½è¸ªSessionçš„</p>
</blockquote>
<p>åœ¨zké‡Œçš„å®ç°æ˜¯SessionTrackerImplï¼š</p>
<pre><code>    protected void createSessionTracker() &#123;
        sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(),
                tickTime, 1, getZooKeeperServerListener());
    &#125;
    
    protected void startSessionTracker() &#123;
        ((SessionTrackerImpl)sessionTracker).start();
    &#125;
</code></pre>
<p>SessionTrackerImplåé¢å†è¯¦ç»†åˆ†æã€‚</p>
<h4 id="2-5-4-ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»"><a href="#2-5-4-ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»" class="headerlink" title="2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»"></a>2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»</h4><p>è¿™é‡Œæ˜¯zkçš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œzkæ¥æ”¶åˆ°çš„è¯·æ±‚æœ€ç»ˆåœ¨è¿™é‡Œè¿›è¡Œå¤„ç†ã€‚</p>
<pre><code> protected void setupRequestProcessors() &#123;
        RequestProcessor finalProcessor = new FinalRequestProcessor(this);
        RequestProcessor syncProcessor = new SyncRequestProcessor(this,
                finalProcessor);
        ((SyncRequestProcessor)syncProcessor).start();
        firstProcessor = new PrepRequestProcessor(this, syncProcessor);
        ((PrepRequestProcessor)firstProcessor).start();
    &#125;
</code></pre>
<p>è¯·æ±‚å¤„ç†é“¾ä»‹ç»</p>
<ul>
<li>é¦–å…ˆæ˜¯PrepRequestProcessor</li>
<li>ç„¶åæ˜¯SyncRequestProcessor</li>
<li>æœ€åæ˜¯finalProcessor</li>
</ul>
<p>ä¸‹é¢ä¾æ¬¡è§£è¯»ï¼š</p>
<h5 id="RequestProcessor"><a href="#RequestProcessor" class="headerlink" title="RequestProcessor"></a>RequestProcessor</h5><blockquote>
<p>RequestProcessors are chained together to process transactions.<br> RequestProcessorséƒ½æ˜¯é“¾åœ¨ä¸€èµ·çš„äº‹åŠ¡å¤„ç†é“¾</p>
</blockquote>
<pre><code>public interface RequestProcessor &#123;
    @SuppressWarnings(&quot;serial&quot;)
    public static class RequestProcessorException extends Exception &#123;
        public RequestProcessorException(String msg, Throwable t) &#123;
            super(msg, t);
        &#125;
    &#125;

    void processRequest(Request request) throws RequestProcessorException;

    void shutdown();
&#125;
</code></pre>
<p>åŒ…å«ä¸‹é¢è¿™äº›å®ç°ï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/5901abdf8ffaa.jpg" alt="enter description here" title="1493281760211"><br> æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸‹é¢å‡ ä¸ªï¼š</p>
<h5 id="PrepRequestProcessor"><a href="#PrepRequestProcessor" class="headerlink" title="PrepRequestProcessor"></a>PrepRequestProcessor</h5><p>ä¸ºä»€ä¹ˆæˆä¸ºè¯·æ±‚å¤„ç†é“¾ï¼Œçœ‹ä¸‹PrepRequestProcessorä»£ç å°±çŸ¥é“äº†ï¼š</p>
<pre><code>    RequestProcessor nextProcessor;

    ZooKeeperServer zks;

    public PrepRequestProcessor(ZooKeeperServer zks,
            RequestProcessor nextProcessor) &#123;
        super(&quot;ProcessThread(sid:&quot; + zks.getServerId() + &quot; cport:&quot;
                + zks.getClientPort() + &quot;):&quot;, zks.getZooKeeperServerListener());
        this.nextProcessor = nextProcessor;
        this.zks = zks;
    &#125;protected void pRequest(Request request) throws RequestProcessorException &#123;
        â€¦â€¦
        nextProcessor.processRequest(request);
    &#125;
</code></pre>
<p>æ„é€ å‡½æ•°é‡ŒåŒ…å«nextProcessorï¼Œåœ¨pRequestå®Œæˆåï¼Œæ‰§è¡ŒnextProcessor.processRequestï¼Œç›¸å½“äºé“¾å¼æ‰§è¡Œã€‚</p>
<p>æ¥ç€åˆ†æï¼Œå†æ¥çœ‹ç±»çš„å®šä¹‰ï¼š</p>
<pre><code>public class PrepRequestProcessor extends ZooKeeperCriticalThread implements
            RequestProcessor &#123;

        LinkedBlockingQueue&lt;Request&gt; submittedRequests = new LinkedBlockingQueue&lt;Request&gt;();

        RequestProcessor nextProcessor;    
&#125;
</code></pre>
<p>å‡ ä¸ªè¦ç‚¹</p>
<ul>
<li>ç»§æ‰¿è‡ªZooKeeperCriticalThreadï¼Œæ˜¯ä¸€ä¸ªThread</li>
<li>é‡è¦å±æ€§submittedRequests æ˜¯ä¸€ä¸ªLinkedBlockingQueueï¼ŒLinkedBlockingQueueå®ç°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ç°äº†å…ˆè¿›å…ˆå‡ºç‰¹æ€§ï¼Œæ˜¯ä½œä¸ºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„é¦–é€‰ã€‚</li>
</ul>
<p>PrepRequestProcessorä½œä¸ºå¤„ç†é“¾çš„æºå¤´ï¼Œå¯¹å¤–æä¾›processRequestæ–¹æ³•æ”¶é›†è¯·æ±‚ï¼Œç”±äºæ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å°†è¯·æ±‚æ”¾å…¥submittedRequestsé˜Ÿåˆ—ã€‚</p>
<pre><code>    public void processRequest(Request request) &#123;
        // request.addRQRec(&quot;&gt;prep=&quot;+zks.outstandingChanges.size());
        submittedRequests.add(request);
    &#125;
</code></pre>
<p>æ”¾å…¥é˜Ÿåˆ—åï¼ŒPrepRequestProcessoræœ¬èº«å°±æ˜¯ä¸€ä¸ªThreadï¼Œæ‰€ä»¥startåæ‰§è¡Œrunï¼Œåœ¨runæ–¹æ³•ä¸­åˆä¼šå°†ç”¨æˆ·æäº¤çš„è¯·æ±‚å–å‡ºæ¥è¿›è¡Œå¤„ç†ï¼š</p>
<pre><code>    public void run() &#123;
            while (true) &#123;
                // å–å‡ºä¸€ä¸ªè¯·æ±‚
                Request request = submittedRequests.take();
                if (Request.requestOfDeath == request) &#123;
                    break;
                &#125;
                // å¤„ç†è¯·æ±‚
                pRequest(request);
            &#125;
        &#125;
</code></pre>
<p>å†æ¥çœ‹pRequestï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/5901af5b683c8.jpg" alt="enter description here" title="1493282652397"></p>
<p>æ ¹æ®requestçš„typeï¼Œæ„é€ å¯¹åº”çš„è¯·æ±‚ï¼Œå¯¹äºå¢åˆ æ”¹ç­‰å½±å“æ•°æ®çŠ¶æ€çš„æ“ä½œéƒ½è¢«è®¤ä¸ºæ˜¯äº‹åŠ¡ï¼ˆtxn:transaction) ï¼Œéœ€è¦åˆ›å»ºå‡ºäº‹åŠ¡è¯·æ±‚å¤´(hdr)ï¼Œè°ƒç”¨pRequest2Txnï¼Œå…¶ä»–æ“ä½œåˆ™ä¸å±äºäº‹åŠ¡æ“ä½œï¼Œéœ€è¦éªŒè¯ä¸‹sessionIdæ˜¯å¦åˆæ³•ã€‚</p>
<pre><code> //create/close session don&#39;t require request record
            case OpCode.createSession:
            case OpCode.closeSession:
                pRequest2Txn(request.type, zks.getNextZxid(), request, null, true);
                break;
 
            //All the rest don&#39;t need to create a Txn - just verify session
            case OpCode.sync:
            case OpCode.exists:
            case OpCode.getData:
            case OpCode.getACL:
            case OpCode.getChildren:
            case OpCode.getChildren2:
            case OpCode.ping:
            case OpCode.setWatches:
                zks.sessionTracker.checkSession(request.sessionId,
                        request.getOwner());
                break;
</code></pre>
<p>æ¥çœ‹pRequest2Txnï¼Œä»¥createä¸ºä¾‹</p>
<pre><code>  pRequest2Txn(request.type, zks.getNextZxid(), request, createRequest, true);
 
   protected void pRequest2Txn(int type, long zxid, Request request, Record record, boolean deserialize)
        throws KeeperException, IOException, RequestProcessorException
    &#123;
        request.hdr = new TxnHeader(request.sessionId, request.cxid, zxid,
                                    zks.getTime(), type);

        switch (type) &#123;
            case OpCode.create:                
                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());
                CreateRequest createRequest = (CreateRequest)record;   
                if(deserialize)
                    ByteBufferInputStream.byteBuffer2Record(request.request, createRequest);
                String path = createRequest.getPath();
                int lastSlash = path.lastIndexOf(&#39;/&#39;);
                if (lastSlash == -1 || path.indexOf(&#39;\0&#39;) != -1 || failCreate) &#123;
                    LOG.info(&quot;Invalid path &quot; + path + &quot; with session 0x&quot; +
                            Long.toHexString(request.sessionId));
                    throw new KeeperException.BadArgumentsException(path);
                &#125;
                List&lt;ACL&gt; listACL = removeDuplicates(createRequest.getAcl());
                if (!fixupACL(request.authInfo, listACL)) &#123;
                    throw new KeeperException.InvalidACLException(path);
                &#125;
                String parentPath = path.substring(0, lastSlash);
                ChangeRecord parentRecord = getRecordForPath(parentPath);

                checkACL(zks, parentRecord.acl, ZooDefs.Perms.CREATE,
                        request.authInfo);
                int parentCVersion = parentRecord.stat.getCversion();
                CreateMode createMode =
                    CreateMode.fromFlag(createRequest.getFlags());
                if (createMode.isSequential()) &#123;
                    path = path + String.format(Locale.ENGLISH, &quot;%010d&quot;, parentCVersion);
                &#125;
                validatePath(path, request.sessionId);
                try &#123;
                    if (getRecordForPath(path) != null) &#123;
                        throw new KeeperException.NodeExistsException(path);
                    &#125;
                &#125; catch (KeeperException.NoNodeException e) &#123;
                    // ignore this one
                &#125;
                boolean ephemeralParent = parentRecord.stat.getEphemeralOwner() != 0;
                if (ephemeralParent) &#123;
                    throw new KeeperException.NoChildrenForEphemeralsException(path);
                &#125;
                int newCversion = parentRecord.stat.getCversion()+1;
                request.txn = new CreateTxn(path, createRequest.getData(),
                        listACL,
                        createMode.isEphemeral(), newCversion);
                StatPersisted s = new StatPersisted();
                if (createMode.isEphemeral()) &#123;
                    s.setEphemeralOwner(request.sessionId);
                &#125;
                parentRecord = parentRecord.duplicate(request.hdr.getZxid());
                parentRecord.childCount++;
                parentRecord.stat.setCversion(newCversion);
                addChangeRecord(parentRecord);
                addChangeRecord(new ChangeRecord(request.hdr.getZxid(), path, s,
                        0, listACL));
                break;
</code></pre>
<ul>
<li>é¦–å…ˆæ˜¯ zks.getNextZxid()åˆ›å»ºä¸€ä¸ªäº‹åŠ¡idï¼ŒAtomicLong hzxidæ˜¯è‡ªå¢é•¿idï¼Œåˆå§‹åŒ–ä¸º0ï¼Œæ¯æ¬¡åŠ ä¸€</li>
<li>åœ¨pRequest2Txnå†…éƒ¨ï¼Œå…ˆç»™requeståˆ›å»ºä¸€ä¸ªTxnHeaderï¼Œè¿™ä¸ªheaderåŒ…å«äº‹åŠ¡id</li>
<li>ç„¶ååˆ¤æ–­è¯·æ±‚ç±»å‹</li>
<li>zks.sessionTracker.checkSession(request.sessionId, request.getOwner()) æ£€æŸ¥session</li>
<li>ååºåˆ—åŒ–ä¸ºCreateRequest</li>
</ul>
<h5 id="SyncRequestProcessor"><a href="#SyncRequestProcessor" class="headerlink" title="SyncRequestProcessor"></a>SyncRequestProcessor</h5><h5 id="FinalRequestProcessor"><a href="#FinalRequestProcessor" class="headerlink" title="FinalRequestProcessor"></a>FinalRequestProcessor</h5><p>æœªå®Œå¾…ç»­</p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/11/21/jqpeng-%E4%BB%8E%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB%E3%80%81BK%E6%A0%91%E5%88%B0%E6%96%87%E6%9C%AC%E7%BA%A0%E9%94%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/11/21/jqpeng-%E4%BB%8E%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB%E3%80%81BK%E6%A0%91%E5%88%B0%E6%96%87%E6%9C%AC%E7%BA%A0%E9%94%99/" class="post-title-link" itemprop="url">ä»ç¼–è¾‘è·ç¦»ã€BKæ ‘åˆ°æ–‡æœ¬çº é”™</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-11-21 10:33:00" itemprop="dateCreated datePublished" datetime="2017-11-21T10:33:00+08:00">2017-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>5.2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>5 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/BK-Tree.html">ä»ç¼–è¾‘è·ç¦»ã€BKæ ‘åˆ°æ–‡æœ¬çº é”™</a></p>
<p>æœç´¢å¼•æ“é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„è¯é¢˜ï¼Œå°±æ˜¯æ–‡æœ¬çº é”™ï¼Œä¸»è¦æœ‰ä¸¤ç§åšæ³•ï¼Œä¸€æ˜¯ä»è¯å…¸çº é”™ï¼Œä¸€æ˜¯åˆ†æç”¨æˆ·æœç´¢æ—¥å¿—ï¼Œä»Šå¤©æˆ‘ä»¬æ¢è®¨ä½¿ç”¨åŸºäºè¯å…¸çš„æ–¹å¼çº é”™ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯åŸºäºç¼–è¾‘è·ç¦»ï¼Œä½¿ç”¨BKæ ‘ã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€æ¢è®¨ï¼š</p>
<h1 id="ç¼–è¾‘è·ç¦»"><a href="#ç¼–è¾‘è·ç¦»" class="headerlink" title="ç¼–è¾‘è·ç¦»"></a>ç¼–è¾‘è·ç¦»</h1><p>1965å¹´ï¼Œä¿„å›½ç§‘å­¦å®¶Vladimir<br> Levenshteinç»™å­—ç¬¦ä¸²ç›¸ä¼¼åº¦åšå‡ºäº†ä¸€ä¸ªæ˜ç¡®çš„å®šä¹‰å«åšLevenshteinè·ç¦»ï¼Œæˆ‘ä»¬é€šå¸¸å«å®ƒâ€œç¼–è¾‘è·ç¦»â€ã€‚</p>
<p>å­—ç¬¦ä¸²Aåˆ°Bçš„ç¼–è¾‘è·ç¦»æ˜¯æŒ‡ï¼Œåªç”¨æ’å…¥ã€åˆ é™¤å’Œæ›¿æ¢ä¸‰ç§æ“ä½œï¼Œæœ€å°‘éœ€è¦å¤šå°‘æ­¥å¯ä»¥æŠŠAå˜æˆBã€‚ä¾‹å¦‚ï¼Œä»FAMEåˆ°GATEéœ€è¦ä¸¤æ­¥ï¼ˆä¸¤æ¬¡æ›¿æ¢ï¼‰ï¼Œä»GAMEåˆ°ACMåˆ™éœ€è¦ä¸‰æ­¥ï¼ˆåˆ é™¤Gå’ŒEå†æ·»åŠ Cï¼‰ã€‚Levenshteinç»™å‡ºäº†ç¼–è¾‘è·ç¦»çš„ä¸€èˆ¬æ±‚æ³•ï¼Œå°±æ˜¯å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰çš„ç»å…¸åŠ¨æ€è§„åˆ’é—®é¢˜ã€‚</p>
<pre><code> class LevenshteinDistanceFunction &#123;

        private final boolean isCaseSensitive;

        public LevenshteinDistanceFunction(boolean isCaseSensitive) &#123;
            this.isCaseSensitive = isCaseSensitive;
        &#125;

        public int distance(CharSequence left, CharSequence right) &#123;
            int leftLength = left.length(), rightLength = right.length();

            // special cases.
            if (leftLength == 0)
                return rightLength;
            if (rightLength == 0)
                return leftLength;

            // Use the iterative matrix method.
            int[] currentRow = new int[rightLength + 1];
            int[] nextRow    = new int[rightLength + 1];

            // Fill first row with all edit counts.
            for (int i = 0; i &lt;= rightLength; i++)
                currentRow[i] = i;

            for (int i = 1; i &lt;= leftLength; i++) &#123;
                nextRow[0] = i;

                for(int j = 1; j &lt;= rightLength; j++) &#123;
                    int subDistance = currentRow[j - 1]; // Distance without insertions or deletions.
                    if (!charEquals(left.charAt(i - 1), right.charAt(j - 1), isCaseSensitive))
                            subDistance++; // Add one edit if letters are different.
                    nextRow[j] = Math.min(Math.min(nextRow[j - 1], currentRow[j]) + 1, subDistance);
                &#125;

                // Swap rows, use last row for next row.
                int[] t = currentRow;
                currentRow = nextRow;
                nextRow = t;
            &#125;

            return currentRow[rightLength];
        &#125;

    &#125;
</code></pre>
<h1 id="BKæ ‘"><a href="#BKæ ‘" class="headerlink" title="BKæ ‘"></a>BKæ ‘</h1><p>ç¼–è¾‘è·ç¦»çš„ç»å…¸åº”ç”¨å°±æ˜¯ç”¨äºæ‹¼å†™æ£€é”™ï¼Œå¦‚æœç”¨æˆ·è¾“å…¥çš„è¯è¯­ä¸åœ¨è¯å…¸ä¸­ï¼Œè‡ªåŠ¨ä»è¯å…¸ä¸­æ‰¾å‡ºç¼–è¾‘è·ç¦»å°äºæŸä¸ªæ•°nçš„å•è¯ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ­£ç¡®çš„é‚£ä¸€ä¸ªï¼Œné€šå¸¸å–åˆ°2æˆ–è€…3ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜çš„éš¾ç‚¹åœ¨äºï¼Œæ€æ ·æ‰èƒ½å¿«é€Ÿåœ¨å­—å…¸é‡Œæ‰¾å‡ºæœ€ç›¸è¿‘çš„å•è¯ï¼Ÿå¯ä»¥åƒ <a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi/archive/2012/08/10/2633025.html">ä½¿ç”¨è´å¶æ–¯åšè‹±æ–‡æ‹¼å†™æ£€æŸ¥ï¼ˆc#)</a> é‡Œæ˜¯é‚£æ ·ï¼Œé€šè¿‡å•è¯è‡ªåŠ¨ä¿®æ”¹ä¸€ä¸ªå•è¯ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨è¯å…¸é‡Œï¼Œè¿™æ ·æœ‰æš´åŠ›ç ´è§£çš„å«Œç–‘ï¼Œæ˜¯å¦æœ‰æ›´ä¼˜é›…çš„æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<p>1973å¹´ï¼ŒBurkhardå’ŒKelleræå‡ºçš„BKæ ‘æœ‰æ•ˆåœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚BKæ ‘çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p>
<pre><code>ä»¤d(x,y)è¡¨ç¤ºå­—ç¬¦ä¸²xåˆ°yçš„Levenshteinè·ç¦»ï¼Œé‚£ä¹ˆæ˜¾ç„¶ï¼š
d(x,y) = 0 å½“ä¸”ä»…å½“ x=y ï¼ˆLevenshteinè·ç¦»ä¸º0 &lt;==&gt; å­—ç¬¦ä¸²ç›¸ç­‰ï¼‰
d(x,y) = d(y,x) ï¼ˆä»xå˜åˆ°yçš„æœ€å°‘æ­¥æ•°å°±æ˜¯ä»yå˜åˆ°xçš„æœ€å°‘æ­¥æ•°ï¼‰
d(x,y) + d(y,z) &gt;= d(x,z) ï¼ˆä»xå˜åˆ°zæ‰€éœ€çš„æ­¥æ•°ä¸ä¼šè¶…è¿‡xå…ˆå˜æˆyå†å˜æˆzçš„æ­¥æ•°ï¼‰
</code></pre>
<p>æœ€åè¿™ä¸€ä¸ªæ€§è´¨å«åšä¸‰è§’å½¢ä¸ç­‰å¼ã€‚å°±å¥½åƒä¸€ä¸ªä¸‰è§’å½¢ä¸€æ ·ï¼Œä¸¤è¾¹ä¹‹å’Œå¿…ç„¶å¤§äºç¬¬ä¸‰è¾¹ã€‚</p>
<h2 id="BKå»ºæ ‘"><a href="#BKå»ºæ ‘" class="headerlink" title="BKå»ºæ ‘"></a>BKå»ºæ ‘</h2><p>é¦–å…ˆæˆ‘ä»¬éšä¾¿æ‰¾ä¸€ä¸ªå•è¯ä½œä¸ºæ ¹ï¼ˆæ¯”å¦‚GAMEï¼‰ã€‚ä»¥åæ’å…¥ä¸€ä¸ªå•è¯æ—¶é¦–å…ˆè®¡ç®—å•è¯ä¸æ ¹çš„Levenshteinè·ç¦»ï¼šå¦‚æœè¿™ä¸ªè·ç¦»å€¼æ˜¯è¯¥èŠ‚ç‚¹å¤„å¤´ä¸€æ¬¡å‡ºç°ï¼Œå»ºç«‹ä¸€ä¸ªæ–°çš„å„¿å­èŠ‚ç‚¹ï¼›å¦åˆ™æ²¿ç€å¯¹åº”çš„è¾¹é€’å½’ä¸‹å»ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ’å…¥å•è¯FAMEï¼Œå®ƒä¸GAMEçš„è·ç¦»ä¸º1ï¼Œäºæ˜¯æ–°å»ºä¸€ä¸ªå„¿å­ï¼Œè¿ä¸€æ¡æ ‡å·ä¸º1çš„è¾¹ï¼›ä¸‹ä¸€æ¬¡æ’å…¥GAINï¼Œç®—å¾—å®ƒä¸GAMEçš„è·ç¦»ä¸º2ï¼Œäºæ˜¯æ”¾åœ¨ç¼–å·ä¸º2çš„è¾¹ä¸‹ã€‚å†ä¸‹æ¬¡æˆ‘ä»¬æ’å…¥GATEï¼Œå®ƒä¸GAMEè·ç¦»ä¸º1ï¼Œäºæ˜¯æ²¿ç€é‚£æ¡ç¼–å·ä¸º1çš„è¾¹ä¸‹å»ï¼Œé€’å½’åœ°æ’å…¥åˆ°FAMEæ‰€åœ¨å­æ ‘ï¼›GATEä¸FAMEçš„è·ç¦»ä¸º2ï¼Œäºæ˜¯æŠŠGATEæ”¾åœ¨FAMEèŠ‚ç‚¹ä¸‹ï¼Œè¾¹çš„ç¼–å·ä¸º2ã€‚</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1511232052823.jpg" alt="enter description here" title="BKæ ‘"></p>
<h2 id="BKæŸ¥è¯¢"><a href="#BKæŸ¥è¯¢" class="headerlink" title="BKæŸ¥è¯¢"></a>BKæŸ¥è¯¢</h2><p>å¦‚æœæˆ‘ä»¬éœ€è¦è¿”å›ä¸é”™è¯¯å•è¯è·ç¦»ä¸è¶…è¿‡nçš„å•è¯ï¼Œè¿™ä¸ªé”™è¯¯å•è¯ä¸æ ‘æ ¹æ‰€å¯¹åº”çš„å•è¯è·ç¦»ä¸ºdï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦é€’å½’åœ°è€ƒè™‘ç¼–å·åœ¨d-nåˆ°d+nèŒƒå›´å†…çš„è¾¹æ‰€è¿æ¥çš„å­æ ‘ã€‚ç”±äºné€šå¸¸å¾ˆå°ï¼Œå› æ­¤æ¯æ¬¡ä¸æŸä¸ªèŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒæ—¶éƒ½å¯ä»¥<strong>æ’é™¤å¾ˆå¤šå­æ ‘</strong>ã€‚</p>
<p>å¯ä»¥é€šè¿‡ä¸‹å›¾ï¼ˆæ¥è‡ª <a target="_blank" rel="noopener" href="http://blog.csdn.net/tradymeky/article/details/40581547">è¶…é…·ç®—æ³•ï¼ˆ1ï¼‰ï¼šBKæ ‘ ï¼ˆåŠä¸ªäººç†è§£ï¼‰</a>ï¼‰ç†è§£ï¼š</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1511229083171.jpg" alt="enter description here" title="1511229083171"></p>
<h2 id="BK-å®ç°"><a href="#BK-å®ç°" class="headerlink" title="BK å®ç°"></a>BK å®ç°</h2><p>çŸ¥é“äº†åŸç†å®ç°å°±ç®€å•äº†ï¼Œè¿™é‡Œä»<a target="_blank" rel="noopener" href="https://github.com/sk-scd91/BKTree">github</a>æ‰¾ä¸€æ®µä»£ç </p>
<p>å»ºæ ‘ï¼š</p>
<pre><code>public boolean add(T t) &#123;
        if (t == null)
            throw new NullPointerException();

        if (rootNode == null) &#123;
            rootNode = new Node&lt;&gt;(t);
            length = 1;
            modCount++; // Modified tree by adding root.
            return true;
        &#125;

        Node&lt;T&gt; parentNode = rootNode;
        Integer distance;
        while ((distance = distanceFunction.distance(parentNode.item, t)) != 0
                || !t.equals(parentNode.item)) &#123;
            Node&lt;T&gt; childNode = parentNode.children.get(distance);
            if (childNode == null) &#123;
                parentNode.children.put(distance, new Node&lt;&gt;(t));
                length++;
                modCount++; // Modified tree by adding a child.
                return true;
            &#125;
            parentNode = childNode;
        &#125;

        return false;
    &#125;
</code></pre>
<p>æŸ¥æ‰¾ï¼š</p>
<pre><code> public List&lt;SearchResult&lt;T&gt;&gt; search(T t, int radius) &#123;
        if (t == null)
            return Collections.emptyList();
        ArrayList&lt;SearchResult&lt;T&gt;&gt; searchResults = new ArrayList&lt;&gt;();
        ArrayDeque&lt;Node&lt;T&gt;&gt; nextNodes = new ArrayDeque&lt;&gt;();
        if (rootNode != null)
            nextNodes.add(rootNode);

        while(!nextNodes.isEmpty()) &#123;
            Node&lt;T&gt; nextNode = nextNodes.poll();
            int distance = distanceFunction.distance(nextNode.item, t);
            if (distance &lt;= radius)
                searchResults.add(new SearchResult&lt;&gt;(distance, nextNode.item));
            int lowBound = Math.max(0, distance - radius), highBound = distance + radius;
            for (Integer i = lowBound; i &lt;= highBound; i++) &#123;
                if (nextNode.children.containsKey(i))
                    nextNodes.add(nextNode.children.get(i));
            &#125;
        &#125;

        searchResults.trimToSize();
        Collections.sort(searchResults);
        return Collections.unmodifiableList(searchResults);
    &#125;
</code></pre>
<h1 id="ä½¿ç”¨BKæ ‘åšæ–‡æœ¬çº é”™"><a href="#ä½¿ç”¨BKæ ‘åšæ–‡æœ¬çº é”™" class="headerlink" title="ä½¿ç”¨BKæ ‘åšæ–‡æœ¬çº é”™"></a>ä½¿ç”¨BKæ ‘åšæ–‡æœ¬çº é”™</h1><p>å‡†å¤‡è¯å…¸ï¼Œ18ä¸‡çš„å½±è§†åç§°ï¼š<br><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1511231191970.jpg" alt="enter description here" title="1511231191970"></p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<pre><code>  static void outputSearchResult( List&lt;SearchResult&lt;CharSequence&gt;&gt; results)&#123;
        for(SearchResult&lt;CharSequence&gt; item : results)&#123;
            System.out.println(item.item);
        &#125;
    &#125;

    static void test(BKTree&lt;CharSequence&gt; tree,String word)&#123;
        System.out.println(word+&quot;çš„æœ€ç›¸è¿‘ç»“æœï¼š&quot;);
        outputSearchResult(tree.search(word,Math.max(1,word.length()/4)));
    &#125;

    public static void main(String[] args) &#123;

        BKTree&lt;CharSequence&gt; tree = new BKTree(DistanceFunctions.levenshteinDistance());
        List&lt;String&gt; testStrings = FileUtil.readLine(&quot;./src/main/resources/act/name.txt&quot;);
        System.out.println(&quot;è¯å…¸æ¡æ•°ï¼š&quot;+testStrings.size());
        long startTime = System.currentTimeMillis();
        for(String testStr: testStrings)&#123;
            tree.add(testStr.replace(&quot;.&quot;,&quot;&quot;));
        &#125;
        System.out.println(&quot;å»ºæ ‘è€—æ—¶ï¼š&quot;+(System.currentTimeMillis()-startTime)+&quot;ms&quot;);
        startTime = System.currentTimeMillis();
        String[] testWords = new String[]&#123;
                &quot;æ¹„å…¬æ²³å‡¶æ¡ˆ&quot;,
                &quot;è‘«èŠ¦ä¸å…„å¼Ÿ&quot;,
                &quot;å°‘æ—è¶³çƒ&quot;
        &#125;;

        for (String testWord: testWords)&#123;
            test(tree,testWord);
        &#125;
        System.out.println(&quot;æµ‹è¯•è€—æ—¶ï¼š&quot;+(System.currentTimeMillis()-startTime)+&quot;ms&quot;);
    &#125;
</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>è¯å…¸æ¡æ•°ï¼š18513
å»ºæ ‘è€—æ—¶ï¼š421ms
æ¹„å…¬æ²³å‡¶æ¡ˆçš„æœ€ç›¸è¿‘ç»“æœï¼š
æ¹„å…¬æ²³å¤§æ¡ˆ
è‘«èŠ¦ä¸å…„å¼Ÿçš„æœ€ç›¸è¿‘ç»“æœï¼š
è‘«èŠ¦å…„å¼Ÿ
å°‘æ—è¶³çƒçš„æœ€ç›¸è¿‘ç»“æœï¼š
å°‘æ—è¶³çƒ
ç¬‘æ—è¶³çƒ
æµ‹è¯•è€—æ—¶ï¼š20ms
</code></pre>
<p>å‚è€ƒï¼š<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/tradymeky/article/details/40581547">http://blog.csdn.net/tradymeky/article/details/40581547</a><br><a target="_blank" rel="noopener" href="https://github.com/sk-scd91/BKTree">https://github.com/sk-scd91/BKTree</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/data2value/p/5707973.html">https://www.cnblogs.com/data2value/p/5707973.html</a></p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/11/13/jqpeng-%E4%BB%8ETrie%E6%A0%91%E5%88%B0%E5%8F%8C%E6%95%B0%E7%BB%84Trie%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/11/13/jqpeng-%E4%BB%8ETrie%E6%A0%91%E5%88%B0%E5%8F%8C%E6%95%B0%E7%BB%84Trie%E6%A0%91/" class="post-title-link" itemprop="url">ä»Trieæ ‘åˆ°åŒæ•°ç»„Trieæ ‘</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-11-13 10:44:00" itemprop="dateCreated datePublished" datetime="2017-11-13T10:44:00+08:00">2017-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>4 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/Trie.html">ä»Trieæ ‘åˆ°åŒæ•°ç»„Trieæ ‘</a></p>
<h1 id="Trieæ ‘"><a href="#Trieæ ‘" class="headerlink" title="Trieæ ‘"></a>Trieæ ‘</h1><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åˆç§°å•è¯æŸ¥æ‰¾æ ‘ï¼ŒTrieæ ‘ï¼Œæ˜¯ä¸€ç§æ ‘å½¢ç»“æ„ï¼Œæ˜¯ä¸€ç§å“ˆå¸Œæ ‘çš„å˜ç§ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯ï¼šåˆ©ç”¨å­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ¥å‡å°‘æŸ¥è¯¢æ—¶é—´ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘æ— è°“çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œèƒ½åœ¨å¸¸æ•°æ—¶é—´O(len)å†…å®ç°æ’å…¥å’ŒæŸ¥è¯¢æ“ä½œï¼Œæ˜¯ä¸€ç§ä»¥ç©ºé—´æ¢å–æ—¶é—´çš„æ•°æ®ç»“æ„ï¼Œå¹¿æ³›ç”¨äºè¯é¢‘ç»Ÿè®¡å’Œè¾“å…¥ç»Ÿè®¡é¢†åŸŸã€‚</p>
<p>æ¥çœ‹çœ‹Trieæ ‘é•¿ä»€ä¹ˆæ ·ï¼Œæˆ‘ä»¬ä»ç™¾åº¦æ‰¾ä¸€å¼ å›¾ç‰‡ï¼š</p>
<p><img src="https://raw.githubusercontent.com/jadepeng/blogpic/master/pic/2018/1509691910484.jpg" alt="enter description here" title="1509691910484"></p>
<p>å­—å…¸æ ‘åœ¨æŸ¥æ‰¾æ—¶ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ªå­—æ˜¯å¦åœ¨å­—å…¸æ ‘é‡Œï¼Œå¦‚æœåœ¨ç»§ç»­å¾€ä¸‹ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™å­—å…¸é‡Œä¸å­˜åœ¨ï¼Œå› æ­¤ï¼Œå¯¹äºä¸€ä¸ªé•¿åº¦ä¸ºlençš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥åœ¨Oï¼ˆlen)æ—¶é—´å†…å®ŒæˆæŸ¥è¯¢ã€‚</p>
<h2 id="å®ç°trieæ ‘"><a href="#å®ç°trieæ ‘" class="headerlink" title="å®ç°trieæ ‘"></a>å®ç°trieæ ‘</h2><p>æ€ä¹ˆå®ç°trieæ ‘å‘¢ï¼Œtrieæ ‘çš„å…³é”®æ˜¯ä¸€ä¸ªèŠ‚ç‚¹è¦åœ¨Oï¼ˆ1ï¼‰æ—¶é—´è·³è½¬åˆ°ä¸‹ä¸€çº§èŠ‚ç‚¹ï¼Œå› æ­¤é“¾è¡¨æ–¹å¼ä¸å¯å–ï¼Œæœ€å¥½ç”¨æ•°ç»„æ¥å­˜å‚¨ä¸‹ä¸€çº§èŠ‚ç‚¹ã€‚é—®é¢˜å°±æ¥äº†ï¼Œå¦‚æœæ˜¯çº¯è‹±æ–‡å­—æ¯ï¼Œé•¿åº¦26çš„æ•°ç»„å°±å¯ä»¥æå®šï¼ŒNä¸ªèŠ‚ç‚¹çš„æ•°ï¼Œå°±éœ€è¦Nä¸ªé•¿åº¦ä¸º26çš„æ•°ç»„ã€‚ä½†æ˜¯ï¼Œå¦‚æœåŒ…å«ä¸­æ–‡ç­‰å­—ç¬¦å‘¢ï¼Œå°±éœ€è¦Nä¸ª65535çš„æ•°ç»„ï¼Œç‰¹åˆ«å ç”¨å­˜å‚¨ç©ºé—´ã€‚å½“ç„¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨mapæ¥å­˜å‚¨ä¸‹çº§èŠ‚ç‚¹ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªNodeï¼ŒåŒ…å«èŠ‚ç‚¹çš„Character wordï¼Œä»¥åŠä¸‹çº§èŠ‚ç‚¹nextså’ŒèŠ‚ç‚¹å¯èƒ½é™„ä»¶çš„å€¼valuesï¼š</p>
<pre><code>public static class Node&lt;T&gt; &#123;
        Character word;

        List&lt;T&gt; values;

        Map&lt;Character, Node&gt; nexts = new HashMap&lt;&gt;(24);

        public Node() &#123;
        &#125;

        public Node(Character word) &#123;
            this.word = word;
        &#125;

        public Character getWord() &#123;
            return word;
        &#125;

        public void setWord(Character word) &#123;
            this.word = word;
        &#125;

        public void addValue(T value)&#123;
            if(values == null)&#123;
                values = new ArrayList&lt;&gt;();
            &#125;
            values.add(value);
        &#125;

        public List&lt;T&gt; getValues() &#123;
            return values;
        &#125;

        public Map&lt;Character, Node&gt; getNexts() &#123;
            return nexts;
        &#125;

        /**
         * @param node
         */
        public void addNext(Node node) &#123;
            this.nexts.put(node.getWord(), node);
        &#125;

        public Node getNext(Character word) &#123;
            return this.nexts.get(word);
        &#125;
    &#125;
</code></pre>
<p>æ¥çœ‹å¦‚ä½•æ„å»ºå­—å…¸æ ‘ï¼Œé¦–å…ˆå®šä¹‰ä¸€æ£µæ ‘ï¼ŒåŒ…å«æ ¹èŠ‚ç‚¹å³å¯</p>
<pre><code>    public static class Trie&lt;T&gt; &#123;
        Node&lt;T&gt; rootNode;

        public Trie() &#123;
            this.rootNode = new Node&lt;T&gt;();
        &#125;

        public Node&lt;T&gt; getRootNode() &#123;
            return rootNode;
        &#125;

    &#125;
</code></pre>
<p>æ„å»ºæ ‘ï¼Œæ‹†åˆ†æˆå•å­—ï¼Œç„¶åé€çº§æ„å»ºæ ‘ã€‚</p>
<pre><code> public static class TrieBuilder &#123;
        public static  Trie&lt;String&gt; buildTrie(String... values)&#123;
            Trie&lt;String&gt; trie = new Trie&lt;String&gt;();
            for(String sentence : values)&#123;
                // æ ¹èŠ‚ç‚¹
                Node&lt;String&gt; currentNode = trie.getRootNode();
                for (int i = 0; i &lt; sentence.length(); i++) &#123;
                    Character character = sentence.charAt(i);
                    // å¯»æ‰¾é¦–ä¸ªèŠ‚ç‚¹
                    Node&lt;String&gt; node = currentNode.getNext(character);
                    if(node == null)&#123;
                        // ä¸å­˜åœ¨ï¼Œåˆ›å»ºèŠ‚ç‚¹
                        node = new Node&lt;String&gt;(character);
                        currentNode.addNext(node);
                    &#125;
                    currentNode = node;
                &#125;

                // æ·»åŠ æ•°æ®
                currentNode.addValue(sentence);
            &#125;

            return trie;
        &#125;
</code></pre>
<h2 id="Trieæ ‘åº”ç”¨"><a href="#Trieæ ‘åº”ç”¨" class="headerlink" title="Trieæ ‘åº”ç”¨"></a>Trieæ ‘åº”ç”¨</h2><p>æ¯”å¦‚åˆ¤æ–­ä¸€ä¸ªè¯æ˜¯å¦åœ¨å­—å…¸æ ‘é‡Œï¼Œéå¸¸ç®€å•ï¼Œé€çº§åŒ¹é…ï¼Œæœ«äº†åˆ¤æ–­æœ€åçš„èŠ‚ç‚¹æ˜¯å¦åŒ…å«æ•°æ®ï¼š</p>
<pre><code>   public boolean isContains(String word) &#123;
            if (word == null || word.length() == 0) &#123;
                return false;
            &#125;
            Node&lt;T&gt; currentState = rootNode;
            for (int i = 0; i &lt; word.length(); i++) &#123;
                currentState = currentState.getNext(word.charAt(i));
                if (currentState == null) &#123;
                    return false;
                &#125;
            &#125;
            return currentState.getValues()!=null;
        &#125;
</code></pre>
<p>æµ‹è¯•ä»£ç :</p>
<pre><code>        public static void main(String[] args) &#123;

            Trie trie = TrieBuilder.buildTrie(&quot;åˆ˜å¾·å&quot;,&quot;åˆ˜ä¸‰å§&quot;,&quot;åˆ˜å¾·åˆš&quot;,&quot;æ±Ÿå§&quot;);
            System.out.println(trie.isContains(&quot;åˆ˜å¾·å&quot;));
            System.out.println(trie.isContains(&quot;åˆ˜å¾·&quot;));
            System.out.println(trie.isContains(&quot;åˆ˜å¤§å¤§&quot;));
        &#125;
</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>true
false
false
</code></pre>
<h1 id="åŒæ•°ç»„Trieæ ‘"><a href="#åŒæ•°ç»„Trieæ ‘" class="headerlink" title="åŒæ•°ç»„Trieæ ‘"></a>åŒæ•°ç»„Trieæ ‘</h1><p>åœ¨Trieæ•°å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†æ¯ä¸ªèŠ‚ç‚¹å‡éœ€è¦ ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨nextèŠ‚ç‚¹ï¼Œéå¸¸å ç”¨å­˜å‚¨ç©ºé—´ï¼Œç©ºé—´å¤æ‚åº¦å¤§ï¼ŒåŒæ•°ç»„Trieæ ‘æ­£æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚åŒæ•°ç»„Trieæ ‘(DoubleArrayTrie)æ˜¯ä¸€ç§ç©ºé—´å¤æ‚åº¦ä½çš„Trieæ ‘ï¼Œåº”ç”¨äºå­—ç¬¦åŒºé—´å¤§çš„è¯­è¨€ï¼ˆå¦‚ä¸­æ–‡ã€æ—¥æ–‡ç­‰ï¼‰åˆ†è¯é¢†åŸŸã€‚</p>
<h2 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åŒæ•°ç»„çš„åŸç†æ˜¯ï¼Œå°†åŸæ¥éœ€è¦å¤šä¸ªæ•°ç»„æ‰èƒ½è¡¨ç¤ºçš„Trieæ ‘ï¼Œä½¿ç”¨ä¸¤ä¸ªæ•°æ®å°±å¯ä»¥å­˜å‚¨ä¸‹æ¥ï¼Œå¯ä»¥æå¤§çš„å‡å°ç©ºé—´å¤æ‚åº¦ã€‚å…·ä½“æ¥è¯´ï¼š</p>
<p>ä½¿ç”¨ä¸¤ä¸ªæ•°ç»„baseå’Œcheckæ¥ç»´æŠ¤Trieæ ‘ï¼Œbaseè´Ÿè´£è®°å½•çŠ¶æ€ï¼Œcheckè´Ÿè´£æ£€æŸ¥å„ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ˜¯ä»åŒä¸€ä¸ªçŠ¶æ€è½¬ç§»è€Œæ¥ï¼Œå½“check[i]ä¸ºè´Ÿå€¼æ—¶ï¼Œè¡¨ç¤ºæ­¤çŠ¶æ€ä¸ºå­—ç¬¦ä¸²çš„ç»“æŸã€‚</p>
<p>ä¸Šé¢çš„æœ‰ç‚¹æŠ½è±¡ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå‡å®šä¸¤ä¸ªå•è¯ta,tb,baseå’Œcheckçš„å€¼ä¼šæ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ï¼š<br> base[t] + a.code = base[ta]<br> base[t] + b.code = base[tb]<br> check[ta] = check[tb]</p>
<p>åœ¨æ¯ä¸ªèŠ‚ç‚¹æ’å…¥çš„è¿‡ç¨‹ä¸­ä¼šä¿®æ”¹è¿™ä¸¤ä¸ªæ•°ç»„ï¼Œå…·ä½“è¯´æ¥ï¼š</p>
<p>1ã€åˆå§‹åŒ–rootèŠ‚ç‚¹base[0] = 1; check[0] = 0;</p>
<p>2ã€å¯¹äºæ¯ä¸€ç¾¤å…„å¼ŸèŠ‚ç‚¹ï¼Œå¯»æ‰¾ä¸€ä¸ªbeginå€¼ä½¿å¾—check[begin + a1â€¦an]  == 0ï¼Œä¹Ÿå°±æ˜¯æ‰¾åˆ°äº†nä¸ªç©ºé—²ç©ºé—´,a1â€¦anæ˜¯siblingsä¸­çš„nä¸ªèŠ‚ç‚¹å¯¹åº”çš„codeã€‚</p>
<p>3ã€ç„¶åå°†è¿™ç¾¤å…„å¼ŸèŠ‚ç‚¹çš„checkè®¾ä¸ºcheck[begin + a1â€¦an] = begin</p>
<p>4ã€æ¥ç€å¯¹æ¯ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœå®ƒæ²¡æœ‰å­©å­ï¼Œä»¤å…¶baseä¸ºè´Ÿå€¼ï¼›å¦åˆ™ä¸ºè¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„æ’å…¥ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯beginå€¼ï¼‰ï¼ŒåŒæ—¶æ’å…¥å­èŠ‚ç‚¹ï¼ˆè¿­ä»£è·³è½¬åˆ°æ­¥éª¤2ï¼‰ã€‚</p>
<pre><code>ç è¡¨ï¼š
   èƒ¶    å    åŠ¨    çŸ¥    ä¸‹    æˆ    ä¸¾    ä¸€    èƒ½    å¤©    ä¸‡    
33014 21517 21160 30693 19979 25104 20030 19968 33021 22825 19975 

DoubleArrayTrie&#123;
char =      Ã—    ä¸€    ä¸‡     Ã—    ä¸¾     Ã—    åŠ¨     Ã—     ä¸‹    å    Ã—    çŸ¥      Ã—     Ã—    èƒ½    ä¸€    å¤©    æˆ    èƒ¶
i    =      0 19970 19977 20032 20033 21162 21164 21519 21520 21522 30695 30699 33023 33024 33028 40001 44345 45137 66038
base =      1     2     6    -1 20032    -2 21162    -3     5 21519    -4 30695    -5    -6 33023     3  1540     4 33024
check=      0     1     1 20032     2 21162     3 21519  1540     4 30695     5 33023 33024     6 20032 21519 20032 33023
size=66039, allocSize=2097152, key=[ä¸€ä¸¾, ä¸€ä¸¾ä¸€åŠ¨, ä¸€ä¸¾æˆå, ä¸€ä¸¾æˆåå¤©ä¸‹çŸ¥, ä¸‡èƒ½, ä¸‡èƒ½èƒ¶], keySize=6, progress=6, nextCheckPos=33024, error_=0&#125;
</code></pre>
<p>é¦–å±‚:ä¸€[19968],ä¸‡[ 19975]<br> base[ä¸€] = base[0]+19968-19968 = 1<br> base[ä¸‡] = base[0]+19975-19968 =</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>å‚è€ƒ <a target="_blank" rel="noopener" href="http://www.hankcs.com/program/java/%E5%8F%8C%E6%95%B0%E7%BB%84trie%E6%A0%91doublearraytriejava%E5%AE%9E%E7%8E%B0.html">åŒæ•°ç»„Trieæ ‘(DoubleArrayTrie)Javaå®ç°</a><br> å¼€æºé¡¹ç›®ï¼š<a target="_blank" rel="noopener" href="https://github.com/komiya-atsushi/darts-java">https://github.com/komiya-atsushi/darts-java</a></p>
<h1 id="åŒæ•°ç»„Trie-ACè‡ªåŠ¨æœº"><a href="#åŒæ•°ç»„Trie-ACè‡ªåŠ¨æœº" class="headerlink" title="åŒæ•°ç»„Trie+ACè‡ªåŠ¨æœº"></a>åŒæ•°ç»„Trie+ACè‡ªåŠ¨æœº</h1><p>å‚è§ï¼š<a target="_blank" rel="noopener" href="http://www.hankcs.com/program/algorithm/aho-corasick-double-array-trie.html">http://www.hankcs.com/program/algorithm/aho-corasick-double-array-trie.html</a></p>
<p>ç»“åˆäº†ACè‡ªåŠ¨æœº+åŒæ•°ç»„Trieæ ‘ï¼š<br> ACè‡ªåŠ¨æœºèƒ½é«˜é€Ÿå®Œæˆå¤šæ¨¡å¼åŒ¹é…ï¼Œç„¶è€Œå…·ä½“å®ç°èªæ˜ä¸å¦å†³å®šæœ€ç»ˆæ€§èƒ½é«˜ä½ã€‚å¤§éƒ¨åˆ†å®ç°éƒ½æ˜¯ä¸€ä¸ªMap&lt;Character, State&gt;äº†äº‹ï¼Œæ— è®ºæ˜¯TreeMapçš„å¯¹æ•°å¤æ‚åº¦ï¼Œè¿˜æ˜¯HashMapçš„å·¨é¢ç©ºé—´å¤æ‚åº¦ä¸å“ˆå¸Œå‡½æ•°çš„æ€§èƒ½æ¶ˆè€—ï¼Œéƒ½ä¼šé™ä½æ•´ä½“æ€§èƒ½ã€‚</p>
<p>åŒæ•°ç»„Trieæ ‘èƒ½é«˜é€ŸO(n)å®Œæˆå•ä¸²åŒ¹é…ï¼Œå¹¶ä¸”å†…å­˜æ¶ˆè€—å¯æ§ï¼Œç„¶è€Œè½¯è‚‹åœ¨äºå¤šæ¨¡å¼åŒ¹é…ï¼Œå¦‚æœè¦åŒ¹é…å¤šä¸ªæ¨¡å¼ä¸²ï¼Œå¿…é¡»å…ˆå®ç°å‰ç¼€æŸ¥è¯¢ï¼Œç„¶åé¢‘ç¹æˆªå–æ–‡æœ¬åç¼€æ‰å¯å¤šåŒ¹é…ï¼Œè¿™æ ·ä¸€ä»½æ–‡æœ¬è¦å›é€€æ‰«æå¤šéï¼Œæ€§èƒ½æä½ã€‚</p>
<p>å¦‚æœèƒ½ç”¨åŒæ•°ç»„Trieæ ‘è¡¨è¾¾ACè‡ªåŠ¨æœºï¼Œå°±èƒ½é›†åˆä¸¤è€…çš„ä¼˜ç‚¹ï¼Œå¾—åˆ°ä¸€ç§è¿‘ä¹å®Œç¾çš„æ•°æ®ç»“æ„ã€‚åœ¨æˆ‘çš„Javaå®ç°ä¸­ï¼Œæˆ‘ç§°å…¶ä¸ºAhoCorasickDoubleArrayTrieï¼Œæ”¯æŒæ³›å‹å’ŒæŒä¹…åŒ–ï¼Œè‡ªå·±éå¸¸å–œçˆ±ã€‚</p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/06/22/jqpeng-%E4%BD%BF%E7%94%A8websocket-sharp%E6%9D%A5%E5%88%9B%E5%BB%BAc#%E7%89%88%E6%9C%AC%E7%9A%84websocket%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/06/22/jqpeng-%E4%BD%BF%E7%94%A8websocket-sharp%E6%9D%A5%E5%88%9B%E5%BB%BAc#%E7%89%88%E6%9C%AC%E7%9A%84websocket%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">ä½¿ç”¨websocket-sharpæ¥åˆ›å»ºc#ç‰ˆæœ¬çš„websocketæœåŠ¡</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-06-22 17:34:00" itemprop="dateCreated datePublished" datetime="2017-06-22T17:34:00+08:00">2017-06-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/websocket-sharp.html">ä½¿ç”¨websocket-sharpæ¥åˆ›å»ºc#ç‰ˆæœ¬çš„websocketæœåŠ¡</a></p>
<p>å½“å‰æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œéœ€è¦ç½‘é¡µç«¯è°ƒç”¨æ‰«æä»ªï¼Œjavascriptä¸å…·å¤‡è°ƒç”¨èƒ½åŠ›ï¼Œå› æ­¤éœ€è¦åœ¨æœºå™¨ä¸Šæä¾›ä¸€ä¸ªwsæœåŠ¡ç»™å‰ç«¯ç½‘é¡µè°ƒç”¨æ‰«æä»ªã€‚è€Œæ‰«æä»ªæœ‰ä¸€ä¸ªc#ç‰ˆæœ¬çš„APIï¼Œå› æ­¤éœ€è¦å¯»æ‰¾ä¸€ä¸ªc#çš„websocketåº“ã€‚</p>
<p>javaé‡Œæœ‰å¤§åé¼é¼çš„nettyï¼Œé€šè¿‡æœç´¢ï¼Œc#å¯ä»¥é€‰æ‹©<a target="_blank" rel="noopener" href="https://github.com/sta/websocket-sharp">websocket-sharp</a>æ¥å®ç°websocket Serverã€‚</p>
<h3 id="ä½¿ç”¨websocket-sharpåˆ›å»ºwebsocket-server"><a href="#ä½¿ç”¨websocket-sharpåˆ›å»ºwebsocket-server" class="headerlink" title="ä½¿ç”¨websocket-sharpåˆ›å»ºwebsocket server###"></a>ä½¿ç”¨websocket-sharpåˆ›å»ºwebsocket server###</h3><pre><code>using System;
using WebSocketSharp;
using WebSocketSharp.Server;

namespace Example
&#123;
  public class Laputa : WebSocketBehavior
  &#123;
    protected override void OnMessage (MessageEventArgs e)
    &#123;
      var msg = e.Data == &quot;BALUS&quot;
                ? &quot;I&#39;ve been balused already...&quot;
                : &quot;I&#39;m not available now.&quot;;

      Send (msg);
    &#125;
  &#125;

  public class Program
  &#123;
    public static void Main (string[] args)
    &#123;
      var wssv = new WebSocketServer (&quot;ws://dragonsnest.far&quot;);
      wssv.AddWebSocketService&lt;Laputa&gt; (&quot;/Laputa&quot;);
      wssv.Start ();
      Console.ReadKey (true);
      wssv.Stop ();
    &#125;
  &#125;
&#125;
</code></pre>
<h4 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h4><p>Required namespace.</p>
<pre><code>using WebSocketSharp.Server;
</code></pre>
<p>The <code>WebSocketBehavior</code> and <code>WebSocketServer</code> ä¸¤ä¸ªç±»éœ€è¦å¼•ç”¨ <code>WebSocketSharp.Server</code> namespace.</p>
<h4 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h4><p>ç¼–å†™å¤„ç†ç±»ï¼Œéœ€è¦ç»§æ‰¿ <code>WebSocketBehavior</code> class.</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœä½ è¦åˆ›å»ºä¸€ä¸ªecho Service,</p>
<pre><code>using System;
using WebSocketSharp;
using WebSocketSharp.Server;

public class Echo : WebSocketBehavior
&#123;
  protected override void OnMessage (MessageEventArgs e)
  &#123;
    Send (e.Data);
  &#125;
&#125;
</code></pre>
<p>å†æä¾›ä¸€ä¸ª chat service,</p>
<pre><code>using System;
using WebSocketSharp;
using WebSocketSharp.Server;

public class Chat : WebSocketBehavior
&#123;
  private string _suffix;

  public Chat ()
    : this (null)
  &#123;
  &#125;

  public Chat (string suffix)
  &#123;
    _suffix = suffix ?? String.Empty;
  &#125;

  protected override void OnMessage (MessageEventArgs e)
  &#123;
    Sessions.Broadcast (e.Data + _suffix);
  &#125;
&#125;
</code></pre>
<p>å¯ä»¥é€šè¿‡ç»§æ‰¿<code>WebSocketBehavior</code>ç±»æ¥è‡ªå®šä¹‰Service.</p>
<p>é€šè¿‡é‡è½½ <code>WebSocketBehavior.OnMessage (MessageEventArgs)</code> æ–¹æ³•, æ¥å¤„ç†æ¶ˆæ¯</p>
<p>åŒæ—¶ä½ ä¹Ÿå¯ä»¥é‡è½½ <code>WebSocketBehavior.OnOpen ()</code>, <code>WebSocketBehavior.OnError (ErrorEventArgs)</code>, å’Œ <code>WebSocketBehavior.OnClose (CloseEventArgs)</code> æ–¹æ³•,æ¥å¤„ç†websocketè¿æ¥äº‹ä»¶ã€‚</p>
<p>é€šè¿‡<code>WebSocketBehavior.Send</code> æ–¹æ³•æ¥ç»™å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚</p>
<p>If you would like to get the sessions in the service, you should access the <code>WebSocketBehavior.Sessions</code> property (returns a <code>WebSocketSharp.Server.WebSocketSessionManager</code>).</p>
<p>The <code>WebSocketBehavior.Sessions.Broadcast</code> method can send data to every client in the service.</p>
<h4 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h4><p>åˆ›å»º <code>WebSocketServer</code> å¯¹è±¡.</p>
<pre><code>var wssv = new WebSocketServer (4649);
wssv.AddWebSocketService&lt;Echo&gt; (&quot;/Echo&quot;);
wssv.AddWebSocketService&lt;Chat&gt; (&quot;/Chat&quot;);
wssv.AddWebSocketService&lt;Chat&gt; (&quot;/ChatWithNyan&quot;, () =&gt; new Chat (&quot; Nyan!&quot;));
</code></pre>
<h4 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h4><p>å¯åŠ¨ WebSocket server.</p>
<pre><code>wssv.Start ();
</code></pre>
<h4 id="Step-5"><a href="#Step-5" class="headerlink" title="Step 5"></a>Step 5</h4><p>åœæ­¢ WebSocket server.</p>
<pre><code>wssv.Stop (code, reason);
</code></pre>
<h3 id="æµ‹è¯•Demo"><a href="#æµ‹è¯•Demo" class="headerlink" title="æµ‹è¯•Demo"></a>æµ‹è¯•Demo</h3><p><code>ç›®çš„</code>ï¼šå¯¹å¤–æä¾›ä¸€ä¸ªwebsocketæœåŠ¡ï¼Œè®©ç½‘é¡µç«¯çš„jså¯ä»¥è°ƒç”¨æ‰«æä»ª</p>
<h4 id="æœåŠ¡ç«¯ä»£ç "><a href="#æœåŠ¡ç«¯ä»£ç " class="headerlink" title="æœåŠ¡ç«¯ä»£ç "></a>æœåŠ¡ç«¯ä»£ç </h4><pre><code> class Program
    &#123;
        static void Main(string[] args)
        &#123;
            var wssv = new WebSocketServer(10086);
            wssv.AddWebSocketService&lt;ScannerHandler&gt;(&quot;/scan&quot;);
            wssv.Start();
            if (wssv.IsListening)
            &#123;
                Console.WriteLine(&quot;Listening on port &#123;0&#125;, and providing WebSocket services:&quot;, wssv.Port);
                foreach (var path in wssv.WebSocketServices.Paths)
                    Console.WriteLine(&quot;- &#123;0&#125;&quot;, path);
            &#125;

            Console.WriteLine(&quot;\nPress Enter key to stop the server...&quot;);
            Console.ReadLine();

            wssv.Stop();
        &#125;
    &#125;

    public class ScannerHandler : WebSocketBehavior
    &#123;
        protected override void OnMessage(MessageEventArgs e)
        &#123;
            if(e.Data == &quot;scan&quot;)
            &#123;
                ScanResult result = ScanerHelper.Scan(&quot;D:\\test.jpg&quot;);
                if (result.Success)
                &#123;
                    Console.WriteLine(&quot;scan success&quot;);
                    Send(&quot;scan success&quot;);
                &#125;
                else
                &#123;
                    Send(&quot;scan eror&quot;);
                &#125;
            &#125;
           
        &#125;
    &#125;
</code></pre>
<h4 id="å‰ç«¯ä»£ç "><a href="#å‰ç«¯ä»£ç " class="headerlink" title="å‰ç«¯ä»£ç "></a>å‰ç«¯ä»£ç </h4><p>javascriptä»£ç </p>
<pre><code>     var ws;
    function initWS() &#123;
        ws = new WebSocket(&quot;ws://127.0.0.1:10086/scan&quot;);
        ws.onopen = function () &#123;
            console.log(&quot;Openened connection to websocket&quot;);

        &#125;;
        ws.onclose = function () &#123;
            console.log(&quot;Close connection to websocket&quot;);
            // æ–­çº¿é‡è¿
            initWS();
        &#125;

        ws.onmessage = function (e) &#123;
            alert(e.data)
        &#125;
    &#125;
    initWS();
    function scan() &#123;
        ws &amp;&amp; ws.send(&#39;scan&#39;);
    &#125;
</code></pre>
<p>htmlä»£ç </p>
<pre><code>&lt;button onclick=&quot;scan()&quot;&gt;æ‰«æ&lt;/button&gt;
</code></pre>
<ul>
<li>initWSåˆ›å»ºè¿æ¥ï¼Œæ”¯æŒæ–­çº¿é‡è¿</li>
<li>å¯ä»¥è°ƒç”¨scanå‡½æ•°ï¼Œå‘é€scanæŒ‡ä»¤</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/06/19/jqpeng-IDEA+PHP+XDebug%E8%B0%83%E8%AF%95%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/06/19/jqpeng-IDEA+PHP+XDebug%E8%B0%83%E8%AF%95%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">IDEA+PHP+XDebugè°ƒè¯•é…ç½®</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-06-19 14:38:00" itemprop="dateCreated datePublished" datetime="2017-06-19T14:38:00+08:00">2017-06-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>1 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/xdbug.html">IDEA+PHP+XDebugè°ƒè¯•é…ç½®</a></p>
<h2 id="XDebugè°ƒè¯•é…ç½®"><a href="#XDebugè°ƒè¯•é…ç½®" class="headerlink" title="XDebugè°ƒè¯•é…ç½®"></a>XDebugè°ƒè¯•é…ç½®</h2><p>ä¸´æ—¶éœ€è¦è°ƒè¯•æœåŠ¡å™¨ä¸Šçš„PHP webç¨‹åºï¼Œå› æ­¤å®‰è£…xdebugï¼Œä¸‹é¢ç®€å•è®°å½•</p>
<h3 id="å®‰è£…xdebug"><a href="#å®‰è£…xdebug" class="headerlink" title="å®‰è£…xdebug"></a>å®‰è£…xdebug</h3><h4 id="ä¸‹è½½æœ€æ–°å¹¶è§£å‹"><a href="#ä¸‹è½½æœ€æ–°å¹¶è§£å‹" class="headerlink" title="ä¸‹è½½æœ€æ–°å¹¶è§£å‹"></a>ä¸‹è½½æœ€æ–°å¹¶è§£å‹</h4><pre><code>wget https://xdebug.org/files/xdebug-2.5.4.tgz
tar zxvf xdebug-2.5.4.tgz 
cd xdebug-2.5.4/
</code></pre>
<h4 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h4><p>æŒ‰ç…§READMEé‡Œçš„æ­¥éª¤å®‰è£…</p>
<pre><code>./configure --enable-xdebug
Â·Â·Â·

æŠ¥é”™
&gt;checking Check for supported PHP versions... configure: error: not supported. Need a PHP version &gt;= 5.5.0 and &lt; 7.2.0 (found 5.3.10-1ubuntu3.21)


åŸæ¥æœåŠ¡å™¨ä¸Šçš„phpç‰ˆæœ¬æ¯”è¾ƒä½ï¼š
&gt;PHP 5.3.10-1ubuntu3.26 with Suhosin-Patch (cli) (built: Feb 13 2017 20:37:53) 
Copyright (c) 1997-2012 The PHP Group
Zend Engine v2.3.0, Copyright (c) 1998-2012 Zend Technologies

æœ€ç¨³å¦¥èµ·è§ï¼Œä¸‹è½½è€ç‰ˆæœ¬çš„xdebugï¼Œä¸‹è½½2.2.2ç‰ˆæœ¬

``` bash
wget https://xdebug.org/files/xdebug-2.2.2.tgz
tar zxvf xdebug-2.2.2.tgz 
cd xdebug-2.2.2/
./configure --enable-xdebug
make
</code></pre>
<p>makeå®Œæˆåï¼Œmodulesä¸‹é¢å°±æœ‰äº†ç¼–è¯‘å¥½çš„xdebug.so:</p>
<pre><code>root@nginx01:/opt/research/xdebug-2.2.2# ll modules/
total 808
drwxr-xr-x 2 root root   4096 Jun 19 14:17 ./
drwxr-xr-x 9 root root   4096 Jun 19 13:10 ../
-rw-r--r-- 1 root root    939 Jun 19 13:09 xdebug.la
-rwxr-xr-x 1 root root 814809 Jun 19 13:09 xdebug.so*
</code></pre>
<h4 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h4><p>ä¿®æ”¹php.iniï¼ŒæœåŠ¡å™¨ä½¿ç”¨çš„php5-fpmï¼Œé…ç½®æ–‡ä»¶åœ¨/etc/php5/fpm/php.ini</p>
<p>ä¿®æ”¹ï¼Œå¢åŠ xdebugé…ç½®ä¿¡æ¯</p>
<pre><code>zend_extension=&quot;/opt/research/xdebug-2.2.2/modules/xdebug.so&quot;
xdebug.remote_enable = On
xdebug.remote_handler = dbgp
xdebug.remote_port = 9001 #ç«¯å£9001
xdebug.remote_connect_back = 1 
#xdebug.remote_host= 192.168.xxx.xxx
xdebug.idekey = PHPSTORM
xdebug.remote_log = /opt/research/xdebug-2.2.2/xdebug.log
</code></pre>
<h3 id="IDEA-é…ç½®"><a href="#IDEA-é…ç½®" class="headerlink" title="IDEA é…ç½®"></a>IDEA é…ç½®</h3><h4 id="é…ç½®xdebugç«¯å£ä¸º9001"><a href="#é…ç½®xdebugç«¯å£ä¸º9001" class="headerlink" title="é…ç½®xdebugç«¯å£ä¸º9001"></a>é…ç½®xdebugç«¯å£ä¸º9001</h4><p>åœ¨è®¾ç½®é‡Œæœç´¢XDEBUGï¼Œé…ç½®ç«¯å£9001<br><img src="https://ooo.0o0.ooo/2017/06/19/5947709e37cf4.jpg" alt="enter description here" title="1497854105384"></p>
<h4 id="è°ƒè¯•é…ç½®"><a href="#è°ƒè¯•é…ç½®" class="headerlink" title="è°ƒè¯•é…ç½®"></a>è°ƒè¯•é…ç½®</h4><p>åœ¨RUN-Edit Configuratinsé‡Œï¼Œæ–°å¢PHP Web Application<br><img src="https://ooo.0o0.ooo/2017/06/19/5947707361211.jpg" alt="enter description here" title="1497854062372"></p>
<p>Serveræ–°å¢æœåŠ¡å™¨åœ°å€ï¼ŒDebuggerè®¾ç½®ä¸ºXdebugï¼Œå°†æœåŠ¡å™¨ä¸Šçš„ç»å¯¹åœ°å€ï¼Œæ˜ å°„åˆ°æœ¬åœ°</p>
<p><img src="https://ooo.0o0.ooo/2017/06/19/59477034b6e7f.jpg" alt="XDEBUGé…ç½®" title="1497853999274"></p>
<p>ç„¶åå°±å¯ä»¥å¯åŠ¨è°ƒè¯•äº†</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/06/12/jqpeng-HTML5%E5%BD%95%E9%9F%B3%E6%8E%A7%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/06/12/jqpeng-HTML5%E5%BD%95%E9%9F%B3%E6%8E%A7%E4%BB%B6/" class="post-title-link" itemprop="url">HTML5å½•éŸ³æ§ä»¶</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-06-12 17:07:00" itemprop="dateCreated datePublished" datetime="2017-06-12T17:07:00+08:00">2017-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>7.3k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>7 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/6993912.html">HTML5å½•éŸ³æ§ä»¶</a></p>
<p>æœ€è¿‘çš„é¡¹ç›®åˆéœ€è¦ç”¨åˆ°å½•éŸ³ï¼Œå¹´å‰æœ‰è¿‡è°ƒç ”ï¼Œå†æ¬¡ç¿»å‡ºæ¥ä½¿ç”¨ï¼Œè¿™é‡Œåšä¸€ä¸ªè®°å½•ã€‚</p>
<p>HTML5æä¾›äº†å½•éŸ³æ”¯æŒï¼Œå› æ­¤å¯ä»¥æ–¹ä¾¿ä½¿ç”¨HTML5æ¥å½•éŸ³ï¼Œæ¥å®ç°å½•éŸ³ã€è¯­éŸ³è¯†åˆ«ç­‰åŠŸèƒ½ï¼Œè¯­éŸ³å¼€å‘å¿…å¤‡ã€‚ä½†æ˜¯ESæ ‡å‡†æä¾›çš„APIå¹¶ä¸äººæ€§åŒ–ï¼Œä¸æ–¹ä¾¿ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸æä¾›ä¿å­˜ä¸ºwavçš„åŠŸèƒ½ï¼Œå¼€å‘èµ·æ¥è´¹åŠ²å•Šï¼ï¼</p>
<p>githubå¯»æ‰¾è½®å­ï¼Œå‘ç°<a target="_blank" rel="noopener" href="https://github.com/mattdiamond/Recorderjs">Recorder.js</a>ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³éœ€æ±‚äº†ï¼Œè‰¯å¥½çš„å°è£…ï¼Œæ”¯æŒå¯¼å‡ºwavï¼Œä½†æ˜¯å­˜åœ¨ï¼š</p>
<ul>
<li>wavé‡‡æ ·ç‡ä¸å¯è°ƒæ•´</li>
<li>recorderåˆ›å»ºéº»çƒ¦ï¼Œéœ€è¦è‡ªå·±åˆå§‹åŒ–getUserMedia</li>
<li>æ— å®æ—¶æ•°æ®å›è°ƒï¼Œä¸æ–¹ä¾¿ç»˜åˆ¶æ³¢å½¢</li>
<li>ã€‚ã€‚ã€‚</li>
</ul>
<h2 id="æ”¹é€ è½®å­"><a href="#æ”¹é€ è½®å­" class="headerlink" title="æ”¹é€ è½®å­"></a>æ”¹é€ è½®å­</h2><h3 id="åˆ›å»ºrecorderå·¥å…·æ–¹æ³•"><a href="#åˆ›å»ºrecorderå·¥å…·æ–¹æ³•" class="headerlink" title="åˆ›å»ºrecorderå·¥å…·æ–¹æ³•"></a>åˆ›å»ºrecorderå·¥å…·æ–¹æ³•</h3><p>æä¾›åˆ›å»ºrecorderå·¥å…·å‡½æ•°ï¼Œå°è£…audioæ¥å£ï¼š</p>
<pre><code>static createRecorder(callback,config)&#123;
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        
        if (navigator.getUserMedia) &#123;
            navigator.getUserMedia(
                &#123; audio: true &#125; //åªå¯ç”¨éŸ³é¢‘
                , function (stream) &#123;
                    var audio_context = new AudioContext;
                    var input = audio_context.createMediaStreamSource(stream);
                    var rec = new Recorder(input, config);
                    callback(rec);
                &#125;
                , function (error) &#123;
                    switch (error.code || error.name) &#123;
                        case &#39;PERMISSION_DENIED&#39;:
                        case &#39;PermissionDeniedError&#39;:
                            throwError(&#39;ç”¨æˆ·æ‹’ç»æä¾›ä¿¡æ¯ã€‚&#39;);
                            break;
                        case &#39;NOT_SUPPORTED_ERROR&#39;:
                        case &#39;NotSupportedError&#39;:
                            throwError(&#39;æµè§ˆå™¨ä¸æ”¯æŒç¡¬ä»¶è®¾å¤‡ã€‚&#39;);
                            break;
                        case &#39;MANDATORY_UNSATISFIED_ERROR&#39;:
                        case &#39;MandatoryUnsatisfiedError&#39;:
                            throwError(&#39;æ— æ³•å‘ç°æŒ‡å®šçš„ç¡¬ä»¶è®¾å¤‡ã€‚&#39;);
                            break;
                        default:
                            throwError(&#39;æ— æ³•æ‰“å¼€éº¦å…‹é£ã€‚å¼‚å¸¸ä¿¡æ¯:&#39; + (error.code || error.name));
                            break;
                    &#125;
                &#125;);
        &#125; else &#123;
            throwError(&#39;å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ã€‚&#39;); return;
        &#125;
    &#125;
</code></pre>
<h3 id="é‡‡æ ·ç‡"><a href="#é‡‡æ ·ç‡" class="headerlink" title="é‡‡æ ·ç‡"></a>é‡‡æ ·ç‡</h3><p>H5å½•åˆ¶çš„é»˜è®¤æ˜¯44kçš„ï¼Œæ–‡ä»¶å¤§ï¼Œä¸æ–¹ä¾¿ä¼ è¾“ï¼Œå› æ­¤éœ€è¦è¿›è¡Œé‡æ–°é‡‡æ ·ï¼Œä¸€èˆ¬é‡‡ç”¨æ’å€¼å–ç‚¹æ–¹æ³•ï¼š</p>
<p>ä»¥ä¸‹ä»£ç ä¸»è¦æ¥è‡ªstackoverflowï¼š</p>
<pre><code>             /**
             * è½¬æ¢é‡‡æ ·ç‡
             * @param data
             * @param newSampleRate ç›®æ ‡é‡‡æ ·ç‡
             * @param oldSampleRate åŸå§‹æ•°æ®é‡‡æ ·ç‡
             * @returns &#123;any[]|Array&#125;
             */
            function interpolateArray(data, newSampleRate, oldSampleRate) &#123;
                var fitCount = Math.round(data.length * (newSampleRate / oldSampleRate));
                var newData = new Array();
                var springFactor = new Number((data.length - 1) / (fitCount - 1));
                newData[0] = data[0]; // for new allocation
                for (var i = 1; i &lt; fitCount - 1; i++) &#123;
                    var tmp = i * springFactor;
                    var before = new Number(Math.floor(tmp)).toFixed();
                    var after = new Number(Math.ceil(tmp)).toFixed();
                    var atPoint = tmp - before;
                    newData[i] = this.linearInterpolate(data[before], data[after], atPoint);
                &#125;
                newData[fitCount - 1] = data[data.length - 1]; // for new allocation
                return newData;
            &#125;

            function linearInterpolate(before, after, atPoint) &#123;
                return before + (after - before) * atPoint;
            &#125;
</code></pre>
<p>ä¿®æ”¹å¯¼å‡ºwavå‡½æ•°exportWAVï¼Œå¢åŠ é‡‡æ ·ç‡é€‰é¡¹ï¼š</p>
<pre><code>            /**
             * å¯¼å‡ºwav
             * @param type
             * @param desiredSamplingRate æœŸæœ›çš„é‡‡æ ·ç‡
             */
            function exportWAV(type,desiredSamplingRate) &#123;
                // é»˜è®¤ä¸º16k
                desiredSamplingRate = desiredSamplingRate || 16000;
                var buffers = [];
                for (var channel = 0; channel &lt; numChannels; channel++) &#123;
                    var buffer = mergeBuffers(recBuffers[channel], recLength);
                    // éœ€è¦è½¬æ¢é‡‡æ ·ç‡
                    if (desiredSamplingRate!=sampleRate) &#123;
                        // æ’å€¼å»ç‚¹
                        buffer = interpolateArray(buffer, desiredSamplingRate, sampleRate);
                    &#125;
                    buffers.push(buffer);
                &#125;
                var interleaved = numChannels === 2 ? interleave(buffers[0], buffers[1]) : buffers[0];
                var dataview = encodeWAV(interleaved,desiredSamplingRate);
                var audioBlob = new Blob([dataview], &#123; type: type &#125;);
                self.postMessage(&#123; command: &#39;exportWAV&#39;, data: audioBlob &#125;);
            &#125;
</code></pre>
<h3 id="å®æ—¶å½•éŸ³æ•°æ®å›è°ƒ"><a href="#å®æ—¶å½•éŸ³æ•°æ®å›è°ƒ" class="headerlink" title="å®æ—¶å½•éŸ³æ•°æ®å›è°ƒ"></a>å®æ—¶å½•éŸ³æ•°æ®å›è°ƒ</h3><p>ä¸ºäº†æ–¹ä¾¿ç»˜åˆ¶éŸ³é‡ã€æ³¢å½¢å›¾ï¼Œéœ€è¦è·å–åˆ°å®æ—¶æ•°æ®ï¼š</p>
<p>configæ–°å¢ä¸€ä¸ªå›è°ƒå‡½æ•°onaudioprocessï¼š</p>
<pre><code>  config = &#123;
        bufferLen: 4096,
        numChannels: 1, // é»˜è®¤å•å£°é“
        mimeType: &#39;audio/wav&#39;,
        onaudioprocess:null
    &#125;;
</code></pre>
<p>ä¿®æ”¹å½•éŸ³æ•°æ®å¤„ç†å‡½æ•°ï¼š</p>
<pre><code>        this.node.onaudioprocess = (e) =&gt; &#123;
            if (!this.recording) return;
            var buffer = [];

            for (var channel = 0; channel &lt; this.config.numChannels; channel++) &#123;
                buffer.push(e.inputBuffer.getChannelData(channel));
            &#125;

            // å‘é€ç»™worker
            this.worker.postMessage(&#123;
                command: &#39;record&#39;,
                buffer: buffer
            &#125;);

            // æ•°æ®å›è°ƒ
            if(this.config.onaudioprocess)&#123;
                this.config.onaudioprocess(buffer[0]);
            &#125;
        &#125;;
</code></pre>
<p>è¿™æ ·ï¼Œåœ¨åˆ›å»ºrecorderæ—¶ï¼Œé…ç½®onaudioprocesså°±å¯ä»¥è·å–åˆ°å®æ—¶æ•°æ®äº†</p>
<h3 id="å®æ—¶æ•°æ®ç¼–ç "><a href="#å®æ—¶æ•°æ®ç¼–ç " class="headerlink" title="å®æ—¶æ•°æ®ç¼–ç "></a>å®æ—¶æ•°æ®ç¼–ç </h3><p>ç¼–ç è®¡ç®—è€—æ—¶ï¼Œéœ€è¦æ”¾åˆ°workeræ‰§è¡Œï¼š</p>
<p>æ¥å£å‡½æ•°æ–°å¢encodeï¼Œå‘é€æ¶ˆæ¯ç»™workerï¼Œè®©workeræ‰§è¡Œï¼š</p>
<pre><code>    encode(cb,buffer,sampleRate) &#123;
        cb = cb || this.config.callback;
        if (!cb) throw new Error(&#39;Callback not set&#39;);
        this.callbacks.encode.push(cb);
        this.worker.postMessage(&#123; command: &#39;encode&#39;,buffer:buffer,sampleRate:sampleRate&#125;);
    &#125;
</code></pre>
<p>workeré‡Œæ–°å¢encodeå‡½æ•°ï¼Œå¤„ç†encodeè¯·æ±‚ï¼Œå®Œæˆåæ‰§è¡Œå›è°ƒ</p>
<pre><code> self.onmessage = function (e) &#123;
                switch (e.data.command) &#123;

                    case &#39;encode&#39;:
                        encode(e.data.buffer,e.data.sampleRate);
                        break;

                &#125;
            &#125;;        
    encode(cb,buffer,sampleRate) &#123;
        cb = cb || this.config.callback;
        if (!cb) throw new Error(&#39;Callback not set&#39;);
        this.callbacks.encode.push(cb);
        this.worker.postMessage(&#123; command: &#39;encode&#39;,buffer:buffer,sampleRate:sampleRate&#125;);
    &#125;
</code></pre>
<h3 id="wavä¸Šä¼ "><a href="#wavä¸Šä¼ " class="headerlink" title="wavä¸Šä¼ "></a>wavä¸Šä¼ </h3><p>å¢åŠ ä¸€ä¸ªä¸Šä¼ å‡½æ•°ï¼š</p>
<pre><code>     exportWAVAndUpload(url, callback) &#123;
        var _url = url;
        exportWAV(function(blob)&#123;
            var fd = new FormData();
            fd.append(&quot;audioData&quot;, blob);
            var xhr = new XMLHttpRequest();
            if (callback) &#123;
                xhr.upload.addEventListener(&quot;progress&quot;, function (e) &#123;
                    callback(&#39;uploading&#39;, e);
                &#125;, false);
                xhr.addEventListener(&quot;load&quot;, function (e) &#123;
                    callback(&#39;ok&#39;, e);
                &#125;, false);
                xhr.addEventListener(&quot;error&quot;, function (e) &#123;
                    callback(&#39;error&#39;, e);
                &#125;, false);
                xhr.addEventListener(&quot;abort&quot;, function (e) &#123;
                    callback(&#39;cancel&#39;, e);
                &#125;, false);
            &#125;
            xhr.open(&quot;POST&quot;, url);
            xhr.send(fd);
        &#125;)     
    &#125;
</code></pre>
<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><p>=<a target="_blank" rel="noopener" href="http://files.cnblogs.com/files/xiaoqi/recorder.js">ç‚¹å‡»ä¸‹è½½</a></p>
<h2 id="å‘ç°æ–°è½®å­"><a href="#å‘ç°æ–°è½®å­" class="headerlink" title="å‘ç°æ–°è½®å­"></a>å‘ç°æ–°è½®å­</h2><p>ä»Šå¤©å†æ¬¡çœ‹è¿™ä¸ªé¡¹ç›®ï¼Œå‘ç°è¿™ä¸ªé¡¹ç›®å·²ç»ä¸ç»´æŠ¤äº†ï¼Œ</p>
<blockquote>
<p>Note: This repository is not being actively maintained due to lack of time and interest. If you maintain or know of a good fork, please let me know so I can direct future visitors to it. In the meantime, if this library isnâ€™t working, you can find a list of popular forks here: <a target="_blank" rel="noopener" href="http://forked.yannick.io/mattdiamond/recorderjs">http://forked.yannick.io/mattdiamond/recorderjs</a>.</p>
</blockquote>
<p>ä½œè€…æ¨è<a target="_blank" rel="noopener" href="https://github.com/chris-rudmin/Recorderjs">https://github.com/chris-rudmin/Recorderjs</a>ï¼Œæä¾›æ›´å¤šçš„åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>bitRate</strong> (<em>optional</em>) Specifies the target bitrate in bits/sec. The encoder selects an application-specific default when this is not specified.</li>
<li><strong>bufferLength</strong> - (<em>optional</em>) The length of the buffer that the internal JavaScriptNode uses to capture the audio. Can be tweaked if experiencing performance issues. Defaults to <code>4096</code>.</li>
<li><strong>encoderApplication</strong> - (<em>optional</em>) Specifies the encoder application. Supported values are <code>2048</code> - Voice, <code>2049</code> - Full Band Audio, <code>2051</code> - Restricted Low Delay. Defaults to <code>2049</code>.</li>
<li><strong>encoderComplexity</strong> - (<em>optional</em>) Value between 0 and 10 which determines latency and processing for resampling. <code>0</code> is fastest with lowest complexity. <code>10</code> is slowest with highest complexity. The encoder selects a default when this is not specified.</li>
<li><strong>encoderFrameSize</strong> (<em>optional</em>) Specifies the frame size in ms used for encoding. Defaults to <code>20</code>.</li>
<li><strong>encoderPath</strong> - (<em>optional</em>) Path to encoderWorker.min.js worker script. Defaults to <code>encoderWorker.min.js</code></li>
<li><strong>encoderSampleRate</strong> - (<em>optional</em>) Specifies the sample rate to encode at. Defaults to <code>48000</code>. Supported values are <code>8000</code>, <code>12000</code>, <code>16000</code>, <code>24000</code> or <code>48000</code>.</li>
<li><strong>leaveStreamOpen</strong> - (<em>optional</em>) Keep the stream around when trying to <code>stop</code> recording, so you can re-<code>start</code> without re-<code>initStream</code>. Defaults to <code>false</code>.</li>
<li><strong>maxBuffersPerPage</strong> - (<em>optional</em>) Specifies the maximum number of buffers to use before generating an Ogg page. This can be used to lower the streaming latency. The lower the value the more overhead the ogg stream will incur. Defaults to <code>40</code>.</li>
<li><strong>monitorGain</strong> - (<em>optional</em>) Sets the gain of the monitoring output. Gain is an a-weighted value between <code>0</code> and <code>1</code>. Defaults to <code>0</code></li>
<li><strong>numberOfChannels</strong> - (<em>optional</em>) The number of channels to record. <code>1</code> = mono, <code>2</code> = stereo. Defaults to <code>1</code>. Maximum <code>2</code> channels are supported.</li>
<li><strong>originalSampleRateOverride</strong> - (<em>optional</em>) Override the ogg opus â€˜input sample rateâ€™ field. Google Speech API requires this field to be <code>16000</code>.</li>
<li><strong>resampleQuality</strong> - (<em>optional</em>) Value between 0 and 10 which determines latency and processing for resampling. <code>0</code> is fastest with lowest quality. <code>10</code> is slowest with highest quality. Defaults to <code>3</code>.</li>
<li><strong>streamPages</strong> - (<em>optional</em>) <code>dataAvailable</code> event will fire after each encoded page. Defaults to <code>false</code>.</li>
</ul>
<p>æ¨èä½¿ç”¨</p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/06/07/jqpeng-Spring%20Boot%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8jar%E5%A4%96%E9%83%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/06/07/jqpeng-Spring%20Boot%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8jar%E5%A4%96%E9%83%A8/" class="post-title-link" itemprop="url">Spring Booté…ç½®æ–‡ä»¶æ”¾åœ¨jarå¤–éƒ¨</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-06-07 09:17:00" itemprop="dateCreated datePublished" datetime="2017-06-07T09:17:00+08:00">2017-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>1 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/6955288.html">Spring Booté…ç½®æ–‡ä»¶æ”¾åœ¨jarå¤–éƒ¨</a></p>
<p>Spring Bootç¨‹åºé»˜è®¤ä»application.propertiesæˆ–è€…application.yamlè¯»å–é…ç½®ï¼Œå¦‚ä½•å°†é…ç½®ä¿¡æ¯å¤–ç½®ï¼Œæ–¹ä¾¿é…ç½®å‘¢ï¼Ÿ</p>
<p>æŸ¥è¯¢å®˜ç½‘ï¼Œå¯ä»¥å¾—åˆ°ä¸‹é¢çš„å‡ ç§æ–¹æ¡ˆ:</p>
<h2 id="é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®š"><a href="#é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®š" class="headerlink" title="é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®š"></a>é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®š</h2><p>SpringApplicationä¼šé»˜è®¤å°†å‘½ä»¤è¡Œé€‰é¡¹å‚æ•°è½¬æ¢ä¸ºé…ç½®ä¿¡æ¯<br> ä¾‹å¦‚ï¼Œå¯åŠ¨æ—¶å‘½ä»¤å‚æ•°æŒ‡å®šï¼š</p>
<pre><code>java -jar myproject.jar --server.port = 9000
</code></pre>
<p>ä»å‘½ä»¤è¡ŒæŒ‡å®šé…ç½®é¡¹çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸è¿‡ä½ å¯ä»¥é€šè¿‡setAddCommandLinePropertiesæ¥ç¦ç”¨</p>
<pre><code>SpringApplication.setAddCommandLineProperties(false).
</code></pre>
<h2 id="å¤–ç½®é…ç½®æ–‡ä»¶"><a href="#å¤–ç½®é…ç½®æ–‡ä»¶" class="headerlink" title="å¤–ç½®é…ç½®æ–‡ä»¶"></a>å¤–ç½®é…ç½®æ–‡ä»¶</h2><p>Springç¨‹åºä¼šæŒ‰ä¼˜å…ˆçº§ä»ä¸‹é¢è¿™äº›è·¯å¾„æ¥åŠ è½½application.propertiesé…ç½®æ–‡ä»¶</p>
<ul>
<li>å½“å‰ç›®å½•ä¸‹çš„/configç›®å½•</li>
<li>å½“å‰ç›®å½•</li>
<li>classpathé‡Œçš„/configç›®å½•</li>
<li>classpath è·Ÿç›®å½•</li>
</ul>
<p>å› æ­¤ï¼Œè¦å¤–ç½®é…ç½®æ–‡ä»¶å°±å¾ˆç®€å•äº†ï¼Œåœ¨jaræ‰€åœ¨ç›®å½•æ–°å»ºconfigæ–‡ä»¶å¤¹ï¼Œç„¶åæ”¾å…¥é…ç½®æ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥æ”¾åœ¨é…ç½®æ–‡ä»¶åœ¨jarç›®å½•</p>
<h2 id="è‡ªå®šä¹‰é…ç½®æ–‡ä»¶"><a href="#è‡ªå®šä¹‰é…ç½®æ–‡ä»¶" class="headerlink" title="è‡ªå®šä¹‰é…ç½®æ–‡ä»¶"></a>è‡ªå®šä¹‰é…ç½®æ–‡ä»¶</h2><p>å¦‚æœä½ ä¸æƒ³ä½¿ç”¨application.propertiesä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œæ€ä¹ˆåŠï¼Ÿå®Œå…¨æ²¡é—®é¢˜</p>
<pre><code>java -jar myproject.jar --spring.config.location=classpath:/default.properties,classpath:/override.properties
</code></pre>
<p>æˆ–è€…</p>
<pre><code>java -jar -Dspring.config.location=D:\config\config.properties springbootrestdemo-0.0.1-SNAPSHOT.jar 
</code></pre>
<p>å½“ç„¶ï¼Œè¿˜èƒ½åœ¨ä»£ç é‡ŒæŒ‡å®š</p>
<pre><code>@SpringBootApplication
@PropertySource(value=&#123;&quot;file:config.properties&quot;&#125;)
public class SpringbootrestdemoApplication &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(SpringbootrestdemoApplication.class, args);
    &#125;
&#125;
</code></pre>
<h2 id="æŒ‰Profileä¸åŒç¯å¢ƒè¯»å–ä¸åŒé…ç½®"><a href="#æŒ‰Profileä¸åŒç¯å¢ƒè¯»å–ä¸åŒé…ç½®" class="headerlink" title="æŒ‰Profileä¸åŒç¯å¢ƒè¯»å–ä¸åŒé…ç½®"></a>æŒ‰Profileä¸åŒç¯å¢ƒè¯»å–ä¸åŒé…ç½®</h2><p>ä¸åŒç¯å¢ƒçš„é…ç½®è®¾ç½®ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>devç¯å¢ƒä¸‹çš„é…ç½®é…ç½®åœ¨application-dev.propertiesä¸­ï¼›</li>
<li>prodç¯å¢ƒä¸‹çš„é…ç½®é…ç½®åœ¨application-prod.propertiesä¸­ã€‚</li>
</ul>
<p>åœ¨application.propertiesä¸­æŒ‡å®šä½¿ç”¨å“ªä¸€ä¸ªæ–‡ä»¶</p>
<pre><code>spring.profiles.active = dev
</code></pre>
<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¿è¡Œçš„æ—¶å€™æ‰‹åŠ¨æŒ‡å®šï¼š</p>
<pre><code>java -jar myproject.jar --spring.profiles.active = prod
</code></pre>
<p>å‚è€ƒï¼š<br> 1    å‚è§<a target="_blank" rel="noopener" href="http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">Externalized Configuration</a></p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/06/01/jqpeng-Netty%E6%96%AD%E7%BA%BF%E9%87%8D%E8%BF%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017/06/01/jqpeng-Netty%E6%96%AD%E7%BA%BF%E9%87%8D%E8%BF%9E/" class="post-title-link" itemprop="url">Nettyæ–­çº¿é‡è¿</a>
        </h2>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-06-01 09:52:00" itemprop="dateCreated datePublished" datetime="2017-06-01T09:52:00+08:00">2017-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:44:20" itemprop="dateModified" datetime="2021-05-14T17:44:20+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>2 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/6927387.html">Nettyæ–­çº¿é‡è¿</a></p>
<h1 id="Nettyæ–­çº¿é‡è¿"><a href="#Nettyæ–­çº¿é‡è¿" class="headerlink" title="Nettyæ–­çº¿é‡è¿"></a>Nettyæ–­çº¿é‡è¿</h1><p>æœ€è¿‘ä½¿ç”¨Nettyå¼€å‘ä¸€ä¸ªä¸­è½¬æœåŠ¡ï¼Œéœ€è¦ä¸€ç›´ä¿æŒä¸Serverç«¯çš„è¿æ¥ï¼Œç½‘ç»œä¸­æ–­åéœ€è¦å¯ä»¥è‡ªåŠ¨é‡è¿ï¼ŒæŸ¥è¯¢å®˜ç½‘èµ„æ–™ï¼Œå®ç°æ–¹æ¡ˆå¾ˆç®€å•ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯åœ¨channelUnregisteredé’©å­å‡½æ•°é‡Œæ‰§è¡Œé‡è¿ã€‚</p>
<h2 id="åˆ›å»ºè¿æ¥"><a href="#åˆ›å»ºè¿æ¥" class="headerlink" title="åˆ›å»ºè¿æ¥"></a>åˆ›å»ºè¿æ¥</h2><p>éœ€è¦æŠŠconfigureBootstrapé‡æ„ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæ–¹ä¾¿åç»­å¤ç”¨</p>
<ol>
<li>EventLoopGroup group = new NioEventLoopGroup();Â </li>
</ol>
<hr>
<ol start="2">
<li>private volatile Bootstrap bootstrap;Â </li>
</ol>
<hr>
<ol start="3">
<li><hr>
</li>
<li>public void init(String host, int port) throws RobotException {Â </li>
</ol>
<hr>
<ol start="5">
<li>this.serverIp = host;Â </li>
</ol>
<hr>
<ol start="6">
<li>this.serverPort = port;Â </li>
</ol>
<hr>
<ol start="7">
<li>try {Â </li>
</ol>
<hr>
<ol start="8">
<li>// åˆ›å»ºå¹¶åˆå§‹åŒ– Netty å®¢æˆ·ç«¯ Bootstrap å¯¹è±¡Â </li>
</ol>
<hr>
<ol start="9">
<li>bootstrap = configureBootstrap(new Bootstrap(),group);Â </li>
</ol>
<hr>
<ol start="10">
<li>bootstrap.option(ChannelOption.TCP_NODELAY, true);Â </li>
</ol>
<hr>
<ol start="11">
<li>doConnect(bootstrap);Â </li>
</ol>
<hr>
<ol start="12">
<li>}Â </li>
</ol>
<hr>
<ol start="13">
<li>catch(Exception ex){Â </li>
</ol>
<hr>
<ol start="14">
<li>ex.printStackTrace();Â </li>
</ol>
<hr>
<ol start="15">
<li>throw new RobotException(â€œconnect remote control server error!â€,ex.getCause());Â </li>
</ol>
<hr>
<ol start="16">
<li>}Â </li>
</ol>
<hr>
<ol start="17">
<li>}Â </li>
</ol>
<hr>
<ol start="18">
<li><hr>
</li>
<li>Bootstrap configureBootstrap(Bootstrap b, EventLoopGroup g) {Â </li>
</ol>
<hr>
<ol start="20">
<li>b.group(g).channel(NioSocketChannel.class)Â </li>
</ol>
<hr>
<ol start="21">
<li>.remoteAddress(serverIp, serverPort)Â </li>
</ol>
<hr>
<ol start="22">
<li>.handler(new ChannelInitializer&lt;SocketChannel&gt;() {Â </li>
</ol>
<hr>
<ol start="23">
<li>@OverrideÂ </li>
</ol>
<hr>
<ol start="24">
<li>public void initChannel(SocketChannel channel) throws Exception {Â </li>
</ol>
<hr>
<ol start="25">
<li>ChannelPipeline pipeline = channel.pipeline();Â </li>
</ol>
<hr>
<ol start="26">
<li>// ç¼–è§£ç å™¨Â </li>
</ol>
<hr>
<ol start="27">
<li>pipeline.addLast(protoCodec);Â </li>
</ol>
<hr>
<ol start="28">
<li>// è¯·æ±‚å¤„ç†Â </li>
</ol>
<hr>
<ol start="29">
<li>pipeline.addLast(RobotClient.this);Â </li>
</ol>
<hr>
<ol start="30">
<li>}Â </li>
</ol>
<hr>
<ol start="31">
<li>});Â </li>
</ol>
<hr>
<ol start="32">
<li><hr>
</li>
<li>return b;Â </li>
</ol>
<hr>
<ol start="34">
<li>}Â </li>
</ol>
<hr>
<ol start="35">
<li><hr>
</li>
<li>void doConnect(Bootstrap b) {Â </li>
</ol>
<hr>
<ol start="37">
<li>try {Â </li>
</ol>
<hr>
<ol start="38">
<li><hr>
</li>
<li>ChannelFuture future = b.connect();Â </li>
</ol>
<hr>
<ol start="40">
<li>future.addListener(new ChannelFutureListener() {Â </li>
</ol>
<hr>
<ol start="41">
<li>@OverrideÂ </li>
</ol>
<hr>
<ol start="42">
<li>public void operationComplete(ChannelFuture future) throws Exception {Â </li>
</ol>
<hr>
<ol start="43">
<li>if (future.isSuccess()) {Â </li>
</ol>
<hr>
<ol start="44">
<li>System.out.println(â€œStarted Tcp Client: â€œ + serverIp);Â </li>
</ol>
<hr>
<ol start="45">
<li>} else {Â </li>
</ol>
<hr>
<ol start="46">
<li>System.out.println(â€œStarted Tcp Client Failed: â€œ);Â </li>
</ol>
<hr>
<ol start="47">
<li>}Â </li>
</ol>
<hr>
<ol start="48">
<li>if (future.cause() != null) {Â </li>
</ol>
<hr>
<ol start="49">
<li>future.cause().printStackTrace();Â </li>
</ol>
<hr>
<ol start="50">
<li>}Â </li>
</ol>
<hr>
<ol start="51">
<li><hr>
</li>
<li>}Â </li>
</ol>
<hr>
<ol start="53">
<li>});Â </li>
</ol>
<hr>
<ol start="54">
<li>} catch (Exception e) {Â </li>
</ol>
<hr>
<ol start="55">
<li>e.printStackTrace();Â </li>
</ol>
<hr>
<ol start="56">
<li>}Â </li>
</ol>
<hr>
<ol start="57">
<li>}Â </li>
</ol>
<hr>
<h2 id="æ–­çº¿é‡è¿"><a href="#æ–­çº¿é‡è¿" class="headerlink" title="æ–­çº¿é‡è¿"></a>æ–­çº¿é‡è¿</h2><p>æ¥çœ‹æ–­çº¿é‡è¿çš„å…³é”®ä»£ç ï¼š</p>
<ol>
<li>@ChannelHandler.SharableÂ </li>
</ol>
<hr>
<ol start="2">
<li>public class RobotClient extends SimpleChannelInboundHandler&lt;RobotProto&gt; {Â </li>
</ol>
<hr>
<ol start="3">
<li>@OverrideÂ </li>
</ol>
<hr>
<ol start="4">
<li>public void channelUnregistered(ChannelHandlerContext ctx) throws Exception {Â </li>
</ol>
<hr>
<ol start="5">
<li>// çŠ¶æ€é‡ç½®Â </li>
</ol>
<hr>
<ol start="6">
<li>isConnected = false;Â </li>
</ol>
<hr>
<ol start="7">
<li>this.serverStatus = -1;Â </li>
</ol>
<hr>
<ol start="8">
<li><hr>
</li>
<li>final EventLoop loop = ctx.channel().eventLoop();Â </li>
</ol>
<hr>
<ol start="10">
<li>loop.schedule(new Runnable() {Â </li>
</ol>
<hr>
<ol start="11">
<li>@OverrideÂ </li>
</ol>
<hr>
<ol start="12">
<li>public void run() {Â </li>
</ol>
<hr>
<ol start="13">
<li>doConnect(configureBootstrap(new Bootstrap(), loop));Â </li>
</ol>
<hr>
<ol start="14">
<li>}Â </li>
</ol>
<hr>
<ol start="15">
<li>}, 1, TimeUnit.SECONDS);Â </li>
</ol>
<hr>
<ol start="16">
<li>}Â </li>
</ol>
<hr>
<ol start="17">
<li>}Â </li>
</ol>
<hr>
<p>éœ€è¦æ³¨æ„ï¼ŒClientç±»éœ€è¦æ·»åŠ @ChannelHandler.Sharableæ³¨è§£ï¼Œå¦åˆ™é‡è¿æ—¶ä¼šæŠ¥é”™</p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/8/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/blog/page/10/">10</a><a class="extend next" rel="next" href="/blog/page/10/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JadePeng"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">JadePeng</p>
  <div class="site-description" itemprop="description">JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">100</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JadePeng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">644k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">9:46</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/blog/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
