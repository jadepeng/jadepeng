<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.iflyresearch.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="æ–‡ç« ä½œè€…:jqpengåŸæ–‡é“¾æ¥: ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) â€“ å¯åŠ¨åˆ†æ ä»æœ¬æ–‡å¼€å§‹ï¼Œä¸å®šæœŸåˆ†æä¸€ä¸ªå¼€æºé¡¹ç›®æºä»£ç ï¼Œèµ·ç¯‡ä»å¤§åé¼é¼çš„zookeeperå¼€å§‹ã€‚ ä¸ºä»€ä¹ˆæ˜¯zkï¼Œå› ä¸ºç”¨åˆ°zkçš„åœºæ™¯å®åœ¨å¤ªå¤šäº†ï¼Œå¤§éƒ¨åˆ†è€³ç†Ÿèƒ½è¯¦çš„åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æœ‰zookeeperçš„å½±å­ï¼Œæ¯”å¦‚hbaseï¼Œstormï¼Œdubboï¼Œkafkaç­‰ç­‰ï¼Œå¦å¤–å‰é¢æåˆ°çš„RPCæ¡†æ¶åŸç†ä¸å®ç°ä¹Ÿç”¨åˆ°äº†zookeeperã€‚ ç›®å½•  1">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) -- å¯åŠ¨åˆ†æ">
<meta property="og:url" content="http://blog.iflyresearch.com/2017/12/01/jqpeng-%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81%E4%B9%8Bzookeeper(1)%20--%20%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
<meta property="og:description" content="æ–‡ç« ä½œè€…:jqpengåŸæ–‡é“¾æ¥: ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) â€“ å¯åŠ¨åˆ†æ ä»æœ¬æ–‡å¼€å§‹ï¼Œä¸å®šæœŸåˆ†æä¸€ä¸ªå¼€æºé¡¹ç›®æºä»£ç ï¼Œèµ·ç¯‡ä»å¤§åé¼é¼çš„zookeeperå¼€å§‹ã€‚ ä¸ºä»€ä¹ˆæ˜¯zkï¼Œå› ä¸ºç”¨åˆ°zkçš„åœºæ™¯å®åœ¨å¤ªå¤šäº†ï¼Œå¤§éƒ¨åˆ†è€³ç†Ÿèƒ½è¯¦çš„åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æœ‰zookeeperçš„å½±å­ï¼Œæ¯”å¦‚hbaseï¼Œstormï¼Œdubboï¼Œkafkaç­‰ç­‰ï¼Œå¦å¤–å‰é¢æåˆ°çš„RPCæ¡†æ¶åŸç†ä¸å®ç°ä¹Ÿç”¨åˆ°äº†zookeeperã€‚ ç›®å½•  1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/590166a796fb3.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/5901674b5600d.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/5901838aed112.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/59018f04f17b9.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/59018cc60446f.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/5901abdf8ffaa.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/04/27/5901af5b683c8.jpg">
<meta property="article:published_time" content="2017-12-01T06:43:00.000Z">
<meta property="article:modified_time" content="2021-05-14T09:34:38.581Z">
<meta property="article:author" content="JadePeng">
<meta property="article:tag" content="jqpeng">
<meta property="article:tag" content="java">
<meta property="article:tag" content="zookeeper">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ooo.0o0.ooo/2017/04/27/590166a796fb3.jpg">

<link rel="canonical" href="http://blog.iflyresearch.com/2017/12/01/jqpeng-%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81%E4%B9%8Bzookeeper(1)%20--%20%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) -- å¯åŠ¨åˆ†æ | JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">çˆ±å­¦ä¹ çˆ±åˆ†äº«</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-åšå®¢">

    <a href="/categories/%E5%8D%9A%E5%AE%A2/" rel="section"><i class="fa fa-th fa-fw"></i>åšå®¢</a>

  </li>
        <li class="menu-item menu-item-åˆ†ç±»">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.iflyresearch.com/2017/12/01/jqpeng-%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81%E4%B9%8Bzookeeper(1)%20--%20%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="JadePeng">
      <meta itemprop="description" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) -- å¯åŠ¨åˆ†æ
        </h1>

        <div class="post-meta">

         
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-12-01 14:43:00" itemprop="dateCreated datePublished" datetime="2017-12-01T14:43:00+08:00">2017-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-14 17:34:38" itemprop="dateModified" datetime="2021-05-14T17:34:38+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">åšå®¢</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%9A%E5%AE%A2/jqpeng/" itemprop="url" rel="index"><span itemprop="name">jqpeng</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>20 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>æ–‡ç« ä½œè€…:jqpeng<br>åŸæ–‡é“¾æ¥: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoqi/p/7942234.html">ä¸€èµ·è¯»æºç ä¹‹zookeeper(1) â€“ å¯åŠ¨åˆ†æ</a></p>
<p>ä»æœ¬æ–‡å¼€å§‹ï¼Œä¸å®šæœŸåˆ†æä¸€ä¸ªå¼€æºé¡¹ç›®æºä»£ç ï¼Œèµ·ç¯‡ä»å¤§åé¼é¼çš„zookeeperå¼€å§‹ã€‚<br> ä¸ºä»€ä¹ˆæ˜¯zkï¼Œå› ä¸ºç”¨åˆ°zkçš„åœºæ™¯å®åœ¨å¤ªå¤šäº†ï¼Œå¤§éƒ¨åˆ†è€³ç†Ÿèƒ½è¯¦çš„åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æœ‰zookeeperçš„å½±å­ï¼Œæ¯”å¦‚hbaseï¼Œstormï¼Œdubboï¼Œkafkaç­‰ç­‰ï¼Œå¦å¤–å‰é¢æåˆ°çš„<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi/p/java-rpc.html">RPCæ¡†æ¶åŸç†ä¸å®ç°</a>ä¹Ÿç”¨åˆ°äº†zookeeperã€‚</p>
<p>ç›®å½•</p>
<ul>
<li>1 ç¯å¢ƒå‡†å¤‡<ul>
<li>1.1 å¯¼å…¥ä»£ç </li>
<li>1.2 è®¾ç½®é…ç½®æ–‡ä»¶</li>
<li>1.3 è°ƒè¯•é…ç½®</li>
</ul>
</li>
<li>2 å¯åŠ¨åˆ†æ<ul>
<li>2.1 QuorumPeerMain</li>
<li>2.2 ZooKeeperServerMain</li>
<li>2.3 ServerCnxnFactory</li>
<li>2.4 ZooKeeperServer</li>
<li>2.5 æœåŠ¡å¯åŠ¨<ul>
<li>2.5.1 é…ç½®cnxnFactory</li>
<li>2.5.2 å¯åŠ¨cnxnFactory<ul>
<li>socketå¤„ç†çº¿ç¨‹</li>
<li>socketç½‘ç»œè¯·æ±‚å¤„ç†</li>
<li>è¯»å–è¿æ¥è¯·æ±‚</li>
<li>åˆ›å»ºsession</li>
</ul>
</li>
<li>2.5.3 zkæœåŠ¡å™¨å¯åŠ¨<ul>
<li>SessionTracker</li>
</ul>
</li>
<li>2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»<ul>
<li>RequestProcessor</li>
<li>PrepRequestProcessor</li>
<li>SyncRequestProcessor</li>
<li>FinalRequestProcessor</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1 ç¯å¢ƒå‡†å¤‡"></a>1 ç¯å¢ƒå‡†å¤‡</h2><p>é¦–å…ˆï¼Œä¸‹è½½zkçš„æ–°ç‰ˆæœ¬ï¼Œæœ€æ–°çš„ç¨³å®šç‰ˆæ˜¯3.4.10ï¼Œç”±äºå·²ä¸‹è½½3.4.9.å…ˆç›´æ¥ä½¿ç”¨ã€‚</p>
<h3 id="1-1-å¯¼å…¥ä»£ç "><a href="#1-1-å¯¼å…¥ä»£ç " class="headerlink" title="1.1 å¯¼å…¥ä»£ç "></a>1.1 å¯¼å…¥ä»£ç </h3><p>IDEAç›´æ¥æ‰“å¼€zkç›®å½•ï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/590166a796fb3.jpg" alt="enter description here" title="1493264040459"></p>
<p>é¡¹ç›®è®¾ç½®ä¸ºjdk1.7<br> ç„¶åï¼Œå°†src/javaä¸‹é¢çš„mainå’Œgeneratedè®¾ç½®ä¸ºæºç ç›®å½•ï¼ŒåŒæ—¶å°†libç›®å½•æ·»åŠ ä¸ºliabaryã€‚</p>
<h3 id="1-2-è®¾ç½®é…ç½®æ–‡ä»¶"><a href="#1-2-è®¾ç½®é…ç½®æ–‡ä»¶" class="headerlink" title="1.2 è®¾ç½®é…ç½®æ–‡ä»¶"></a>1.2 è®¾ç½®é…ç½®æ–‡ä»¶</h3><p>åœ¨confç›®å½•ï¼Œæ–°å»ºzoo.cfgï¼Œæ‹·è´sample.cfgå³å¯</p>
<p><img src="https://ooo.0o0.ooo/2017/04/27/5901674b5600d.jpg" alt="enter description here" title="1493264204261"></p>
<h3 id="1-3-è°ƒè¯•é…ç½®"><a href="#1-3-è°ƒè¯•é…ç½®" class="headerlink" title="1.3 è°ƒè¯•é…ç½®"></a>1.3 è°ƒè¯•é…ç½®</h3><p>æŸ¥çœ‹bin/zkServer</p>
<pre><code>set ZOOMAIN=org.apache.zookeeper.server.quorum.QuorumPeerMain
....
endlocal
</code></pre>
<p>è°ƒç”¨çš„æ˜¯org.apache.zookeeper.server.quorum.QuorumPeerMainï¼Œå› æ­¤QuorumPeerMainï¼Œé…ç½®è°ƒè¯•ç¨‹åºï¼Œargumentsè®¾ç½®conf/zoo.cfg</p>
<p><img src="https://ooo.0o0.ooo/2017/04/27/5901838aed112.jpg" alt="enter description here" title="1493271435981"></p>
<p>è¿™æ ·ï¼Œå°±å¯ä»¥æ„‰å¿«çš„Debugä»£ç äº†-ğŸ˜ƒ</p>
<h2 id="2-å¯åŠ¨åˆ†æ"><a href="#2-å¯åŠ¨åˆ†æ" class="headerlink" title="2 å¯åŠ¨åˆ†æ"></a>2 å¯åŠ¨åˆ†æ</h2><h3 id="2-1-QuorumPeerMain"><a href="#2-1-QuorumPeerMain" class="headerlink" title="2.1 QuorumPeerMain"></a>2.1 QuorumPeerMain</h3><p>QuorumPeerMainçš„mainé‡Œï¼Œè°ƒç”¨initializeAndRun</p>
<pre><code>    protected void initializeAndRun(String[] args)
        throws ConfigException, IOException
    &#123;
        QuorumPeerConfig config = new QuorumPeerConfig();
        if (args.length == 1) &#123;
            config.parse(args[0]);
        &#125;

        // Start and schedule the the purge task æ¸…ç†ä»»åŠ¡
        DatadirCleanupManager purgeMgr = new DatadirCleanupManager(config
                .getDataDir(), config.getDataLogDir(), config
                .getSnapRetainCount(), config.getPurgeInterval());
        purgeMgr.start();

        // é›†ç¾¤æ¨¡å¼
        if (args.length == 1 &amp;&amp; config.servers.size() &gt; 0) &#123;
            runFromConfig(config);
        &#125; else &#123;
            LOG.warn(&quot;Either no config or no quorum defined in config, running &quot;
                    + &quot; in standalone mode&quot;);
            // there is only server in the quorum -- run as standalone
            // å•æœºæ¨¡å¼
            ZooKeeperServerMain.main(args);
        &#125;
    &#125;
</code></pre>
<p>ä¸»è¦æ‰§è¡Œäº†ï¼š</p>
<ul>
<li>åŠ è½½è§£æé…ç½®æ–‡ä»¶åˆ°QuorumPeerConfig</li>
<li>æ‰§è¡Œæ¸…ç†ä»»åŠ¡</li>
<li>åˆ¤æ–­æ˜¯é›†ç¾¤æ¨¡å¼è¿˜æ˜¯å•æœºæ¨¡å¼ï¼Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æœªé…ç½®serverï¼Œæ‰€ä»¥æ˜¯å•æœºæ¨¡å¼ï¼Œæ‰§è¡Œ ZooKeeperServerMain.main</li>
</ul>
<blockquote>
<p>æœ¬æ–‡é‡ç‚¹åˆ†æå•æœºæ¨¡å¼ä¸‹çš„zkï¼Œé›†ç¾¤æ¨¡å¼æš‚æ—¶ä¸è§£è¯»</p>
</blockquote>
<h3 id="2-2-ZooKeeperServerMain"><a href="#2-2-ZooKeeperServerMain" class="headerlink" title="2.2 ZooKeeperServerMain"></a>2.2 ZooKeeperServerMain</h3><p>ZooKeeperServerMain.mainè°ƒç”¨initializeAndRun</p>
<pre><code> protected void initializeAndRun(String[] args)
        throws ConfigException, IOException
    &#123;
        try &#123;
            ManagedUtil.registerLog4jMBeans();
        &#125; catch (JMException e) &#123;
            LOG.warn(&quot;Unable to register log4j JMX control&quot;, e);
        &#125;

        ServerConfig config = new ServerConfig();
        if (args.length == 1) &#123;
            config.parse(args[0]);
        &#125; else &#123;
            config.parse(args);
        &#125;

        runFromConfig(config);
    &#125;```

è¯»å–é…ç½®ï¼Œç„¶årunFromConfigï¼š

``` java
 public void runFromConfig(ServerConfig config) throws IOException &#123;
        LOG.info(&quot;Starting server&quot;);
        FileTxnSnapLog txnLog = null;
        try &#123;
            // Note that this thread isn&#39;t going to be doing anything else,
            // so rather than spawning another thread, we will just call
            // run() in this thread.
            // create a file logger url from the command line args
            final ZooKeeperServer zkServer = new ZooKeeperServer();
            // Registers shutdown handler which will be used to know the
            // server error or shutdown state changes.
            final CountDownLatch shutdownLatch = new CountDownLatch(1);
            zkServer.registerServerShutdownHandler(
                    new ZooKeeperServerShutdownHandler(shutdownLatch));

            // å¿«ç…§
            txnLog = new FileTxnSnapLog(new File(config.dataLogDir), new File(
                    config.dataDir));
            zkServer.setTxnLogFactory(txnLog);
            zkServer.setTickTime(config.tickTime);
            zkServer.setMinSessionTimeout(config.minSessionTimeout);
            zkServer.setMaxSessionTimeout(config.maxSessionTimeout);
            // socketå·¥å‚
            cnxnFactory = ServerCnxnFactory.createFactory();
            cnxnFactory.configure(config.getClientPortAddress(),
                    config.getMaxClientCnxns());
            cnxnFactory.startup(zkServer);

            // Watch status of ZooKeeper server. It will do a graceful shutdown
            // if the server is not running or hits an internal error.
            shutdownLatch.await();
            shutdown();

            cnxnFactory.join();
            if (zkServer.canShutdown()) &#123;
                zkServer.shutdown();
            &#125;
        &#125; catch (InterruptedException e) &#123;
            // warn, but generally this is ok
            LOG.warn(&quot;Server interrupted&quot;, e);
        &#125; finally &#123;
            if (txnLog != null) &#123;
                txnLog.close();
            &#125;
        &#125;
    &#125;
</code></pre>
<p>å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>åˆ›å»ºzkServerï¼Œå¯¹ZooKeeperServerè®¾ç½®ä¸€äº›é…ç½®å‚æ•°ï¼Œå¦‚tickTimeã€minSessionTimeoutã€maxSessionTimeout</li>
<li>åˆ›å»ºCountDownLatchï¼Œæ³¨é‡Šé‡Œå†™äº†ï¼Œç”¨æ¥watch zkçš„çŠ¶æ€ï¼Œå½“zkå…³é—­æˆ–è€…å‡ºç°å†…éƒ¨é”™è¯¯çš„æ—¶å€™<strong>ä¼˜é›…</strong>çš„å…³é—­æœåŠ¡</li>
<li>æ ¹æ®é…ç½®å‚æ•°dataLogDirå’ŒdataDiråˆ›å»ºFileTxnSnapLogï¼Œç”¨æ¥å­˜å‚¨zkæ•°æ®å’Œæ—¥å¿—å¿«ç…§</li>
<li>åˆ›å»ºcnxnFactoryï¼Œzkçš„ socketå·¥å‚ï¼Œè´Ÿè´£å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œzké‡Œæœ‰nettyå’ŒNIOä¸¤ç§å®ç°</li>
<li>cnxnFactory.startup(zkServer)ï¼Œå¯åŠ¨zkæœåŠ¡å™¨</li>
</ul>
<h3 id="2-3-ServerCnxnFactory"><a href="#2-3-ServerCnxnFactory" class="headerlink" title="2.3 ServerCnxnFactory"></a>2.3 ServerCnxnFactory</h3><p>cnxnFactoryè´Ÿè´£zkçš„ç½‘ç»œè¯·æ±‚ï¼ŒcreateFactoryä¸­ï¼Œä»ç³»ç»Ÿé…ç½®ä¸­è¯»å–ZOOKEEPER_SERVER_CNXN_FACTORYï¼Œé»˜è®¤æ˜¯æ²¡æœ‰è¿™ä¸ªé…ç½®çš„ï¼Œå› æ­¤é»˜è®¤æ˜¯ä½¿ç”¨NIOServerCnxnFactoryï¼ŒåŸºäºjavaçš„NIOå®ç°ï¼Œ</p>
<pre><code>    static public ServerCnxnFactory createFactory() throws IOException &#123;
        String serverCnxnFactoryName =
            System.getProperty(ZOOKEEPER_SERVER_CNXN_FACTORY);
        if (serverCnxnFactoryName == null) &#123;
            serverCnxnFactoryName = NIOServerCnxnFactory.class.getName();
        &#125;
        try &#123;
            return (ServerCnxnFactory) Class.forName(serverCnxnFactoryName)
                                                .newInstance();
        &#125; catch (Exception e) &#123;
            IOException ioe = new IOException(&quot;Couldn&#39;t instantiate &quot;
                    + serverCnxnFactoryName);
            ioe.initCause(e);
            throw ioe;
        &#125;
    &#125;
</code></pre>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“å‘ç°ï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/59018f04f17b9.jpg" alt="enter description here" title="1493274374075"></p>
<p>ServerCnxnFactoryè¿˜æœ‰ä¸ªNettyServerCnxnFactoryå®ç°ï¼ŒåŸºäºNettyå®ç°NIOã€‚ServerCnxnFactoryé‡Œå…·ä½“è´Ÿè´£ä»€ä¹ˆï¼Œåé¢å†æ¥çœ‹ã€‚</p>
<h3 id="2-4-ZooKeeperServer"><a href="#2-4-ZooKeeperServer" class="headerlink" title="2.4 ZooKeeperServer"></a>2.4 ZooKeeperServer</h3><p>ç°åœ¨ï¼Œä¸»è§’ç™»åœºï¼Œæˆ‘ä»¬æ¥çœ‹ZooKeeperServerå†…éƒ¨æœ‰ä»€ä¹ˆç„å¦™ã€‚<br><img src="https://ooo.0o0.ooo/2017/04/27/59018cc60446f.jpg" alt="enter description here" title="1493273799033"></p>
<p>ZooKeeperServeræ˜¯å•æœºæ¨¡å¼ä½¿ç”¨çš„ç±»ï¼Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨çš„æ˜¯å®ƒçš„å­ç±»ã€‚<br> æˆ‘ä»¬å…ˆæ¥çœ‹ZooKeeperServeråŒ…å«å“ªäº›å†…å®¹ï¼š</p>
<pre><code>    public static final int DEFAULT_TICK_TIME = 3000;
    protected int tickTime = DEFAULT_TICK_TIME;
    /** value of -1 indicates unset, use default */
    protected int minSessionTimeout = -1;
    /** value of -1 indicates unset, use default */
    protected int maxSessionTimeout = -1;
    protected SessionTracker sessionTracker; //åˆ›å»ºå’Œç®¡ç†session
    private FileTxnSnapLog txnLogFactory = null; //æ–‡ä»¶å¿«ç…§
    private ZKDatabase zkDb; // ZooKeeperæ ‘å½¢æ•°æ®çš„æ¨¡å‹
    private final AtomicLong hzxid = new AtomicLong(0); //åŸå­å¢é•¿Longï¼Œç”¨äºåˆ†é…äº‹åŠ¡ç¼–å·
    public final static Exception ok = new Exception(&quot;No prob&quot;);
    protected RequestProcessor firstProcessor; // ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä¸­çš„ç¬¬ä¸€ä¸ªå¤„ç†å™¨
    protected volatile State state = State.INITIAL;

    protected enum State &#123;
        INITIAL, RUNNING, SHUTDOWN, ERROR;
    &#125;

    /**
     * This is the secret that we use to generate passwords, for the moment it
     * is more of a sanity check.
     */
    static final private long superSecret = 0XB3415C00L;

    private final AtomicInteger requestsInProcess = new AtomicInteger(0);
    final List&lt;ChangeRecord&gt; outstandingChanges = new ArrayList&lt;ChangeRecord&gt;();
    // this data structure must be accessed under the outstandingChanges lock
    final HashMap&lt;String, ChangeRecord&gt; outstandingChangesForPath =
        new HashMap&lt;String, ChangeRecord&gt;();
    
    private ServerCnxnFactory serverCnxnFactory; //ServerSocketå·¥å‚ï¼Œæ¥å—å®¢æˆ·ç«¯çš„socketè¿æ¥

    private final ServerStats serverStats; //serverçš„è¿è¡ŒçŠ¶æ€ç»Ÿè®¡
    private final ZooKeeperServerListener listener; // ZKè¿è¡ŒçŠ¶æ€ç›‘å¬
    private ZooKeeperServerShutdownHandler zkShutdownHandler;
</code></pre>
<h3 id="2-5-æœåŠ¡å¯åŠ¨"><a href="#2-5-æœåŠ¡å¯åŠ¨" class="headerlink" title="2.5 æœåŠ¡å¯åŠ¨"></a>2.5 æœåŠ¡å¯åŠ¨</h3><p>å‰é¢æœ‰ç‚¹è·‘åï¼Œç»§ç»­å›å½’å¯åŠ¨è¿‡ç¨‹:</p>
<pre><code>            cnxnFactory = ServerCnxnFactory.createFactory();
            cnxnFactory.configure(config.getClientPortAddress(),
                    config.getMaxClientCnxns());
            cnxnFactory.startup(zkServer);
</code></pre>
<h4 id="2-5-1-é…ç½®cnxnFactory"><a href="#2-5-1-é…ç½®cnxnFactory" class="headerlink" title="2.5.1 é…ç½®cnxnFactory"></a>2.5.1 é…ç½®cnxnFactory</h4><p>è¿›å…¥configureï¼š</p>
<pre><code>    @Override
    public void configure(InetSocketAddress addr, int maxcc) throws IOException &#123;
        configureSaslLogin();

        // ZKç½‘ç»œè¯·æ±‚ä¸»çº¿ç¨‹
        thread = new ZooKeeperThread(this, &quot;NIOServerCxn.Factory:&quot; + addr);
        thread.setDaemon(true);

        maxClientCnxns = maxcc;
        this.ss = ServerSocketChannel.open();
        ss.socket().setReuseAddress(true);
        LOG.info(&quot;binding to port &quot; + addr);
        ss.socket().bind(addr);
        ss.configureBlocking(false);
        ss.register(selector, SelectionKey.OP_ACCEPT);
    &#125;
</code></pre>
<p>å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>configureSaslLoginï¼Œå…·ä½“ä¸ç»†çœ‹ï¼Œåº”è¯¥æ˜¯å¤„ç†é‰´æƒ</li>
<li>åˆå§‹åŒ–ZooKeeperThreadï¼Œè¿™ä¸ªZooKeeperThreadçš„ä½œç”¨æ˜¯è´Ÿè´£å¤„ç†æœªå¤„ç†å¼‚å¸¸ï¼š</li>
</ul>
<pre><code>public class ZooKeeperThread extends Thread &#123;

    private static final Logger LOG = LoggerFactory
            .getLogger(ZooKeeperThread.class);

    private UncaughtExceptionHandler uncaughtExceptionalHandler = new UncaughtExceptionHandler() &#123;

        @Override
        public void uncaughtException(Thread t, Throwable e) &#123;
            handleException(t.getName(), e);
        &#125;
    &#125;;

    public ZooKeeperThread(Runnable thread, String threadName) &#123;
        super(thread, threadName);
        setUncaughtExceptionHandler(uncaughtExceptionalHandler);
    &#125;

    protected void handleException(String thName, Throwable e) &#123;
        LOG.warn(&quot;Exception occured from thread &#123;&#125;&quot;, thName, e);
    &#125;
&#125;
</code></pre>
<ul>
<li>å¯åŠ¨ServerSocketChannelï¼Œå¹¶ç»‘å®šé…ç½®çš„addrï¼Œå¹¶ä¸”æ³¨å†Œselectorï¼ˆå¯ä»¥æœç´¢NIOäº†è§£ç»†èŠ‚ï¼‰</li>
</ul>
<h4 id="2-5-2-å¯åŠ¨cnxnFactory"><a href="#2-5-2-å¯åŠ¨cnxnFactory" class="headerlink" title="2.5.2 å¯åŠ¨cnxnFactory"></a>2.5.2 å¯åŠ¨cnxnFactory</h4><p>ç»§ç»­åˆ†æï¼Œè¿›å…¥cnxnFactory.startup(zkServer)</p>
<pre><code>    @Override
    public void startup(ZooKeeperServer zks) throws IOException,
            InterruptedException &#123;
        start();
        setZooKeeperServer(zks);
        zks.startdata();
        zks.startup();
    &#125;
</code></pre>
<p>é¦–å…ˆï¼Œstartï¼Œåˆ¤æ–­çº¿ç¨‹çŠ¶æ€ï¼Œå¦‚æœæœªå¯åŠ¨åˆ™å¯åŠ¨çº¿ç¨‹ï¼Œæ³¨æ„åªä¼šå¯åŠ¨ä¸€æ¬¡ã€‚</p>
<pre><code>    @Override
    public void start() &#123;
        // ensure thread is started once and only once
        if (thread.getState() == Thread.State.NEW) &#123;
            thread.start();
        &#125;
    &#125;
</code></pre>
<h5 id="socketå¤„ç†çº¿ç¨‹"><a href="#socketå¤„ç†çº¿ç¨‹" class="headerlink" title="socketå¤„ç†çº¿ç¨‹"></a>socketå¤„ç†çº¿ç¨‹</h5><p>å¯åŠ¨åï¼Œå°±ä¼šæ‰§è¡ŒcnxnFactory.run</p>
<pre><code>    public void run() &#123;
        while (!ss.socket().isClosed()) &#123;
            try &#123;
                selector.select(1000);
                Set&lt;SelectionKey&gt; selected;
                synchronized (this) &#123;
                    selected = selector.selectedKeys();
                &#125;
                ArrayList&lt;SelectionKey&gt; selectedList = new ArrayList&lt;SelectionKey&gt;(
                        selected);
                Collections.shuffle(selectedList);
                for (SelectionKey k : selectedList) &#123;
                    if ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != 0) &#123;
                        SocketChannel sc = ((ServerSocketChannel) k
                                .channel()).accept();
                        InetAddress ia = sc.socket().getInetAddress();
                        int cnxncount = getClientCnxnCount(ia);
                        if (maxClientCnxns &gt; 0 &amp;&amp; cnxncount &gt;= maxClientCnxns)&#123;
                            LOG.warn(&quot;Too many connections from &quot; + ia
                                     + &quot; - max is &quot; + maxClientCnxns );
                            sc.close();
                        &#125; else &#123;
                            LOG.info(&quot;Accepted socket connection from &quot;
                                     + sc.socket().getRemoteSocketAddress());
                            sc.configureBlocking(false);
                            SelectionKey sk = sc.register(selector,
                                    SelectionKey.OP_READ);
                            NIOServerCnxn cnxn = createConnection(sc, sk);
                            sk.attach(cnxn);
                            addCnxn(cnxn);
                        &#125;
                    &#125; else if ((k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != 0) &#123;
                        NIOServerCnxn c = (NIOServerCnxn) k.attachment();
                        c.doIO(k);
                    &#125; else &#123;
                        if (LOG.isDebugEnabled()) &#123;
                            LOG.debug(&quot;Unexpected ops in select &quot;
                                      + k.readyOps());
                        &#125;
                    &#125;
                &#125;
                selected.clear();
            &#125; catch (RuntimeException e) &#123;
                LOG.warn(&quot;Ignoring unexpected runtime exception&quot;, e);
            &#125; catch (Exception e) &#123;
                LOG.warn(&quot;Ignoring exception&quot;, e);
            &#125;
        &#125;
        closeAll();
        LOG.info(&quot;NIOServerCnxn factory exited run method&quot;);
    &#125;
</code></pre>
<p>è¿™é‡Œç›¸å½“äºä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¿æ¥ï¼Œé€šè¿‡selector.select(1000)æ¥è·å–ç½‘ç»œè¯·æ±‚ï¼Œä¸€æ—¦æœ‰è¿æ¥å°±ç»ªï¼Œåˆ™å¼€å§‹å¤„ç†ï¼š</p>
<ul>
<li>é¦–å…ˆæ‰“ä¹± Collections.shuffle(selectedList);</li>
<li>forå¾ªç¯å¤„ç†<ul>
<li>å¦‚æœSelectionKey.OP_ACCEPTï¼Œä»£è¡¨ä¸€ä¸ªæ–°è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºSocketChannelï¼Œåˆ›å»ºNIOServerCnxnï¼Œç„¶åaddCnxn</li>
<li>å¦‚æœå¯è¯»å†™ï¼Œåˆ™ NIOServerCnxn.doIO(k)ï¼Œæ‰§è¡ŒIOæ“ä½œ</li>
</ul>
</li>
</ul>
<h5 id="socketç½‘ç»œè¯·æ±‚å¤„ç†"><a href="#socketç½‘ç»œè¯·æ±‚å¤„ç†" class="headerlink" title="socketç½‘ç»œè¯·æ±‚å¤„ç†"></a>socketç½‘ç»œè¯·æ±‚å¤„ç†</h5><p>è¿™é‡Œç®€å•åˆ†æä¸‹doIO,æ‘˜å½•éƒ¨åˆ†ä»£ç ï¼š</p>
<pre><code>void doIO(SelectionKey k) throws InterruptedException &#123;
        try &#123;
            if (isSocketOpen() == false) &#123;
                LOG.warn(&quot;trying to do i/o on a null socket for session:0x&quot;
                         + Long.toHexString(sessionId));

                return;
            &#125;
            if (k.isReadable()) &#123;
                // è¯»å–4ä¸ªå­—èŠ‚
                int rc = sock.read(incomingBuffer);
                if (rc &lt; 0) &#123;
                    throw new EndOfStreamException(
                            &quot;Unable to read additional data from client sessionid 0x&quot;
                            + Long.toHexString(sessionId)
                            + &quot;, likely client has closed socket&quot;);
                &#125;
                // è¯»æ»¡äº†
                if (incomingBuffer.remaining() == 0) &#123;
                    boolean isPayload;
                    if (incomingBuffer == lenBuffer) &#123; // start of next request
                        incomingBuffer.flip(); // å¤ä½
                        isPayload = readLength(k); // è¯»å–è½½è·é•¿åº¦
                        incomingBuffer.clear();
                    &#125; else &#123;
                        // continuation
                        isPayload = true;
                    &#125;
                    if (isPayload) &#123; // not the case for 4letterword
                        readPayload();
                    &#125;
                    else &#123;
                        // four letter words take care
                        // need not do anything else
                        return;
                    &#125;
                &#125;
            &#125;
</code></pre>
<p>è¯»å–4ä¸ªå­—èŠ‚ï¼Œè·å–åˆ°æ•°æ®é•¿åº¦ï¼Œç„¶åè¯»å–è½½è·ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚</p>
<pre><code>    private void readPayload() throws IOException, InterruptedException &#123;
        if (incomingBuffer.remaining() != 0) &#123; // have we read length bytes?
            int rc = sock.read(incomingBuffer); // sock is non-blocking, so ok
            if (rc &lt; 0) &#123;
                throw new EndOfStreamException(
                        &quot;Unable to read additional data from client sessionid 0x&quot;
                        + Long.toHexString(sessionId)
                        + &quot;, likely client has closed socket&quot;);
            &#125;
        &#125;

        if (incomingBuffer.remaining() == 0) &#123; // have we read length bytes?
            packetReceived();
            incomingBuffer.flip(); // å¤ä½
            if (!initialized) &#123;
                readConnectRequest(); // è¯»å–è¿æ¥è¯·æ±‚
            &#125; else &#123;
                readRequest();
            &#125;
            lenBuffer.clear();
            incomingBuffer = lenBuffer;
        &#125;
    &#125;
</code></pre>
<p>å…ˆæ˜¯è¯»å–æ•°æ®ï¼Œç„¶åå†è¯»å–è¯·æ±‚ï¼Œè¿™é‡Œå…³æ³¨readConnectRequest</p>
<h5 id="è¯»å–è¿æ¥è¯·æ±‚"><a href="#è¯»å–è¿æ¥è¯·æ±‚" class="headerlink" title="è¯»å–è¿æ¥è¯·æ±‚"></a>è¯»å–è¿æ¥è¯·æ±‚</h5><pre><code>    private void readConnectRequest() throws IOException, InterruptedException &#123;
        if (zkServer == null) &#123;
            throw new IOException(&quot;ZooKeeperServer not running&quot;);
        &#125;
        zkServer.processConnectRequest(this, incomingBuffer);
        initialized = true;
    &#125;
</code></pre>
<p>ç»§ç»­ï¼Œä¸‹é¢æ˜¯å¤„ç†è¿æ¥è¯·æ±‚ï¼š</p>
<pre><code>     public void processConnectRequest(ServerCnxn cnxn, ByteBuffer incomingBuffer) throws IOException &#123;
        BinaryInputArchive bia = BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer));
        ConnectRequest connReq = new ConnectRequest();
        connReq.deserialize(bia, &quot;connect&quot;); // ååºåˆ—åŒ–è¯·æ±‚
        ....
        // å®¢æˆ·ç«¯è®¾ç½®çš„è¶…æ—¶æ—¶é—´
        int sessionTimeout = connReq.getTimeOut();
        byte passwd[] = connReq.getPasswd();
        int minSessionTimeout = getMinSessionTimeout();
        if (sessionTimeout &lt; minSessionTimeout) &#123;
            sessionTimeout = minSessionTimeout;
        &#125;
        // æœåŠ¡ç«¯è®¾ç½®çš„æœ€å¤§è¶…æ—¶æ—¶é—´
        int maxSessionTimeout = getMaxSessionTimeout();
        if (sessionTimeout &gt; maxSessionTimeout) &#123;
            sessionTimeout = maxSessionTimeout;
        &#125;
        cnxn.setSessionTimeout(sessionTimeout);
        // We don&#39;t want to receive any packets until we are sure that the
        // session is setup
        cnxn.disableRecv();
        // è¯·æ±‚æ˜¯å¦å¸¦ä¸Šsessionid
        long sessionId = connReq.getSessionId();
        if (sessionId != 0) &#123;
            // è¯·æ±‚å¸¦äº†sessionid
            long clientSessionId = connReq.getSessionId();
            LOG.info(&quot;Client attempting to renew session 0x&quot;
                    + Long.toHexString(clientSessionId)
                    + &quot; at &quot; + cnxn.getRemoteSocketAddress());
            // å…³é—­è¯·æ±‚
            serverCnxnFactory.closeSession(sessionId);
            cnxn.setSessionId(sessionId);
            // é‡æ–°æ‰“å¼€è¯·æ±‚
            reopenSession(cnxn, sessionId, passwd, sessionTimeout);
        &#125; else &#123;
            LOG.info(&quot;Client attempting to establish new session at &quot;
                    + cnxn.getRemoteSocketAddress());
            // åˆ›å»ºæ–°sesssion
            createSession(cnxn, passwd, sessionTimeout);
        &#125;
    &#125;
</code></pre>
<p>ä»¥ä¸Šå®Œæˆï¼š</p>
<ul>
<li>å°†è¯»å–å‡ºæ¥çš„incomingBufferååºåˆ—åŒ–ä¸ºConnectRequestå¯¹è±¡</li>
<li>ç„¶åè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ŒServerCnxnæ¥æ”¶åˆ°è¯¥ç”³è¯·åï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„sessionTimeoutæ—¶é—´ä»¥åŠZooKeeperServeræœ¬èº«çš„minSessionTimeoutã€maxSessionTimeoutå‚æ•°ï¼Œç¡®å®šæœ€ç»ˆçš„sessionTimeoutæ—¶é—´</li>
<li>åˆ¤æ–­å®¢æˆ·ç«¯çš„è¯·æ±‚æ˜¯å¦å·²ç»å«æœ‰sessionId<ul>
<li>å¦‚æœå«æœ‰ï¼Œåˆ™æ‰§è¡ŒsessionIdçš„æ˜¯å¦è¿‡æœŸã€å¯†ç æ˜¯å¦æ­£ç¡®ç­‰æ£€æŸ¥</li>
<li>å¦‚æœæ²¡æœ‰sessionIdï¼Œåˆ™åˆ›å»ºä¸€ä¸ªsession</li>
</ul>
</li>
</ul>
<h5 id="åˆ›å»ºsession"><a href="#åˆ›å»ºsession" class="headerlink" title="åˆ›å»ºsession"></a>åˆ›å»ºsession</h5><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å†çœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºsessionï¼š</p>
<pre><code>    long createSession(ServerCnxn cnxn, byte passwd[], int timeout) &#123;
        long sessionId = sessionTracker.createSession(timeout);
        Random r = new Random(sessionId ^ superSecret);
        r.nextBytes(passwd);
        ByteBuffer to = ByteBuffer.allocate(4);
        to.putInt(timeout);
        cnxn.setSessionId(sessionId);
        submitRequest(cnxn, sessionId, OpCode.createSession, 0, to, null);
        return sessionId;
    &#125;
</code></pre>
<ul>
<li>ä½¿ç”¨sessionTrackerç”Ÿæˆä¸€ä¸ªsessionId</li>
<li>submitRequestæ„å»ºä¸€ä¸ªRequestè¯·æ±‚ï¼Œè¯·æ±‚çš„ç±»å‹ä¸ºOpCode.createSession</li>
</ul>
<pre><code>    private void submitRequest(ServerCnxn cnxn, long sessionId, int type,
            int xid, ByteBuffer bb, List&lt;Id&gt; authInfo) &#123;
        Request si = new Request(cnxn, sessionId, xid, type, bb, authInfo);
        submitRequest(si);
    &#125;
    
    public void submitRequest(Request si) &#123;
        if (firstProcessor == null) &#123;
            synchronized (this) &#123;
                try &#123;
                    // Since all requests are passed to the request
                    // processor it should wait for setting up the request
                    // processor chain. The state will be updated to RUNNING
                    // after the setup.
                    while (state == State.INITIAL) &#123;
                        wait(1000);
                    &#125;
                &#125; catch (InterruptedException e) &#123;
                    LOG.warn(&quot;Unexpected interruption&quot;, e);
                &#125;
                if (firstProcessor == null || state != State.RUNNING) &#123;
                    throw new RuntimeException(&quot;Not started&quot;);
                &#125;
            &#125;
        &#125;
        try &#123;
            touch(si.cnxn);
            boolean validpacket = Request.isValid(si.type);
            if (validpacket) &#123;
                firstProcessor.processRequest(si);
                if (si.cnxn != null) &#123;
                    incInProcess();
                &#125;
            &#125; else &#123;
                LOG.warn(&quot;Received packet at server of unknown type &quot; + si.type);
                new UnimplementedRequestProcessor().processRequest(si);
            &#125;
        &#125; catch (MissingSessionException e) &#123;
            if (LOG.isDebugEnabled()) &#123;
                LOG.debug(&quot;Dropping request: &quot; + e.getMessage());
            &#125;
        &#125; catch (RequestProcessorException e) &#123;
            LOG.error(&quot;Unable to process request:&quot; + e.getMessage(), e);
        &#125;
    &#125;
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªRequest</li>
<li>ç­‰å¾…firstProcessoråˆ›å»ºå®Œæˆï¼Œç„¶åè°ƒç”¨firstProcessor.processRequest</li>
</ul>
<blockquote>
<p>firstProcessoræ˜¯ä»€ä¹ˆä¸œä¸œï¼Œä¸‹é¢å†æ­æ™“</p>
</blockquote>
<h4 id="2-5-3-zkæœåŠ¡å™¨å¯åŠ¨"><a href="#2-5-3-zkæœåŠ¡å™¨å¯åŠ¨" class="headerlink" title="2.5.3 zkæœåŠ¡å™¨å¯åŠ¨"></a>2.5.3 zkæœåŠ¡å™¨å¯åŠ¨</h4><p>å†æ¬¡å›åˆ°startupï¼Œ  setZooKeeperServer(zks)ï¼Œä»£ç å¾ˆç®€å•</p>
<pre><code> final public void setZooKeeperServer(ZooKeeperServer zk) &#123;
        this.zkServer = zk;
        if (zk != null) &#123;
            zk.setServerCnxnFactory(this);
        &#125;
    &#125;
</code></pre>
<p>ç„¶åæ˜¯zkæœåŠ¡å™¨çš„startdata:</p>
<pre><code>    public void startdata() 
    throws IOException, InterruptedException &#123;
        //check to see if zkDb is not null
        if (zkDb == null) &#123;
            zkDb = new ZKDatabase(this.txnLogFactory);
        &#125;  
        if (!zkDb.isInitialized()) &#123;
            loadData();
        &#125;
    &#125;
</code></pre>
<p>åˆå§‹åŒ–ZKDatabaseï¼Œä»txnLogFactoryé‡Œè¯»å–å¿«ç…§æ•°æ®ã€‚</p>
<p>æœ€åæ˜¯zkæœåŠ¡å™¨çš„startupï¼š</p>
<pre><code>    public synchronized void startup() &#123;
        if (sessionTracker == null) &#123;
            createSessionTracker();
        &#125;
        startSessionTracker();
        setupRequestProcessors();

        registerJMX();

        setState(State.RUNNING);
        notifyAll();
    &#125;
</code></pre>
<p>å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>createSessionTrackeråˆ›å»ºsessionTracker</li>
<li>startSessionTrackerå¯åŠ¨SessionTracker</li>
<li>setupRequestProcessors åˆ›å»ºè¯·æ±‚å¤„ç†å™¨é“¾</li>
<li>registerJMX æ³¨å†ŒJMX</li>
<li>setState(State.RUNNING) è®¾ç½®çŠ¶æ€ä¸ºè¿è¡Œä¸­</li>
</ul>
<h5 id="SessionTracker"><a href="#SessionTracker" class="headerlink" title="SessionTracker"></a>SessionTracker</h5><p>çœ‹SessionTrackerçš„æ³¨é‡Šï¼š</p>
<blockquote>
<p>This is the basic interface that ZooKeeperServer uses to track sessions.<br> è´Ÿè´£è¿½è¸ªSessionçš„</p>
</blockquote>
<p>åœ¨zké‡Œçš„å®ç°æ˜¯SessionTrackerImplï¼š</p>
<pre><code>    protected void createSessionTracker() &#123;
        sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(),
                tickTime, 1, getZooKeeperServerListener());
    &#125;
    
    protected void startSessionTracker() &#123;
        ((SessionTrackerImpl)sessionTracker).start();
    &#125;
</code></pre>
<p>SessionTrackerImplåé¢å†è¯¦ç»†åˆ†æã€‚</p>
<h4 id="2-5-4-ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»"><a href="#2-5-4-ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»" class="headerlink" title="2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»"></a>2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»</h4><p>è¿™é‡Œæ˜¯zkçš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œzkæ¥æ”¶åˆ°çš„è¯·æ±‚æœ€ç»ˆåœ¨è¿™é‡Œè¿›è¡Œå¤„ç†ã€‚</p>
<pre><code> protected void setupRequestProcessors() &#123;
        RequestProcessor finalProcessor = new FinalRequestProcessor(this);
        RequestProcessor syncProcessor = new SyncRequestProcessor(this,
                finalProcessor);
        ((SyncRequestProcessor)syncProcessor).start();
        firstProcessor = new PrepRequestProcessor(this, syncProcessor);
        ((PrepRequestProcessor)firstProcessor).start();
    &#125;
</code></pre>
<p>è¯·æ±‚å¤„ç†é“¾ä»‹ç»</p>
<ul>
<li>é¦–å…ˆæ˜¯PrepRequestProcessor</li>
<li>ç„¶åæ˜¯SyncRequestProcessor</li>
<li>æœ€åæ˜¯finalProcessor</li>
</ul>
<p>ä¸‹é¢ä¾æ¬¡è§£è¯»ï¼š</p>
<h5 id="RequestProcessor"><a href="#RequestProcessor" class="headerlink" title="RequestProcessor"></a>RequestProcessor</h5><blockquote>
<p>RequestProcessors are chained together to process transactions.<br> RequestProcessorséƒ½æ˜¯é“¾åœ¨ä¸€èµ·çš„äº‹åŠ¡å¤„ç†é“¾</p>
</blockquote>
<pre><code>public interface RequestProcessor &#123;
    @SuppressWarnings(&quot;serial&quot;)
    public static class RequestProcessorException extends Exception &#123;
        public RequestProcessorException(String msg, Throwable t) &#123;
            super(msg, t);
        &#125;
    &#125;

    void processRequest(Request request) throws RequestProcessorException;

    void shutdown();
&#125;
</code></pre>
<p>åŒ…å«ä¸‹é¢è¿™äº›å®ç°ï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/5901abdf8ffaa.jpg" alt="enter description here" title="1493281760211"><br> æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸‹é¢å‡ ä¸ªï¼š</p>
<h5 id="PrepRequestProcessor"><a href="#PrepRequestProcessor" class="headerlink" title="PrepRequestProcessor"></a>PrepRequestProcessor</h5><p>ä¸ºä»€ä¹ˆæˆä¸ºè¯·æ±‚å¤„ç†é“¾ï¼Œçœ‹ä¸‹PrepRequestProcessorä»£ç å°±çŸ¥é“äº†ï¼š</p>
<pre><code>    RequestProcessor nextProcessor;

    ZooKeeperServer zks;

    public PrepRequestProcessor(ZooKeeperServer zks,
            RequestProcessor nextProcessor) &#123;
        super(&quot;ProcessThread(sid:&quot; + zks.getServerId() + &quot; cport:&quot;
                + zks.getClientPort() + &quot;):&quot;, zks.getZooKeeperServerListener());
        this.nextProcessor = nextProcessor;
        this.zks = zks;
    &#125;protected void pRequest(Request request) throws RequestProcessorException &#123;
        â€¦â€¦
        nextProcessor.processRequest(request);
    &#125;
</code></pre>
<p>æ„é€ å‡½æ•°é‡ŒåŒ…å«nextProcessorï¼Œåœ¨pRequestå®Œæˆåï¼Œæ‰§è¡ŒnextProcessor.processRequestï¼Œç›¸å½“äºé“¾å¼æ‰§è¡Œã€‚</p>
<p>æ¥ç€åˆ†æï¼Œå†æ¥çœ‹ç±»çš„å®šä¹‰ï¼š</p>
<pre><code>public class PrepRequestProcessor extends ZooKeeperCriticalThread implements
            RequestProcessor &#123;

        LinkedBlockingQueue&lt;Request&gt; submittedRequests = new LinkedBlockingQueue&lt;Request&gt;();

        RequestProcessor nextProcessor;    
&#125;
</code></pre>
<p>å‡ ä¸ªè¦ç‚¹</p>
<ul>
<li>ç»§æ‰¿è‡ªZooKeeperCriticalThreadï¼Œæ˜¯ä¸€ä¸ªThread</li>
<li>é‡è¦å±æ€§submittedRequests æ˜¯ä¸€ä¸ªLinkedBlockingQueueï¼ŒLinkedBlockingQueueå®ç°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ç°äº†å…ˆè¿›å…ˆå‡ºç‰¹æ€§ï¼Œæ˜¯ä½œä¸ºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„é¦–é€‰ã€‚</li>
</ul>
<p>PrepRequestProcessorä½œä¸ºå¤„ç†é“¾çš„æºå¤´ï¼Œå¯¹å¤–æä¾›processRequestæ–¹æ³•æ”¶é›†è¯·æ±‚ï¼Œç”±äºæ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å°†è¯·æ±‚æ”¾å…¥submittedRequestsé˜Ÿåˆ—ã€‚</p>
<pre><code>    public void processRequest(Request request) &#123;
        // request.addRQRec(&quot;&gt;prep=&quot;+zks.outstandingChanges.size());
        submittedRequests.add(request);
    &#125;
</code></pre>
<p>æ”¾å…¥é˜Ÿåˆ—åï¼ŒPrepRequestProcessoræœ¬èº«å°±æ˜¯ä¸€ä¸ªThreadï¼Œæ‰€ä»¥startåæ‰§è¡Œrunï¼Œåœ¨runæ–¹æ³•ä¸­åˆä¼šå°†ç”¨æˆ·æäº¤çš„è¯·æ±‚å–å‡ºæ¥è¿›è¡Œå¤„ç†ï¼š</p>
<pre><code>    public void run() &#123;
            while (true) &#123;
                // å–å‡ºä¸€ä¸ªè¯·æ±‚
                Request request = submittedRequests.take();
                if (Request.requestOfDeath == request) &#123;
                    break;
                &#125;
                // å¤„ç†è¯·æ±‚
                pRequest(request);
            &#125;
        &#125;
</code></pre>
<p>å†æ¥çœ‹pRequestï¼š<br><img src="https://ooo.0o0.ooo/2017/04/27/5901af5b683c8.jpg" alt="enter description here" title="1493282652397"></p>
<p>æ ¹æ®requestçš„typeï¼Œæ„é€ å¯¹åº”çš„è¯·æ±‚ï¼Œå¯¹äºå¢åˆ æ”¹ç­‰å½±å“æ•°æ®çŠ¶æ€çš„æ“ä½œéƒ½è¢«è®¤ä¸ºæ˜¯äº‹åŠ¡ï¼ˆtxn:transaction) ï¼Œéœ€è¦åˆ›å»ºå‡ºäº‹åŠ¡è¯·æ±‚å¤´(hdr)ï¼Œè°ƒç”¨pRequest2Txnï¼Œå…¶ä»–æ“ä½œåˆ™ä¸å±äºäº‹åŠ¡æ“ä½œï¼Œéœ€è¦éªŒè¯ä¸‹sessionIdæ˜¯å¦åˆæ³•ã€‚</p>
<pre><code> //create/close session don&#39;t require request record
            case OpCode.createSession:
            case OpCode.closeSession:
                pRequest2Txn(request.type, zks.getNextZxid(), request, null, true);
                break;
 
            //All the rest don&#39;t need to create a Txn - just verify session
            case OpCode.sync:
            case OpCode.exists:
            case OpCode.getData:
            case OpCode.getACL:
            case OpCode.getChildren:
            case OpCode.getChildren2:
            case OpCode.ping:
            case OpCode.setWatches:
                zks.sessionTracker.checkSession(request.sessionId,
                        request.getOwner());
                break;
</code></pre>
<p>æ¥çœ‹pRequest2Txnï¼Œä»¥createä¸ºä¾‹</p>
<pre><code>  pRequest2Txn(request.type, zks.getNextZxid(), request, createRequest, true);
 
   protected void pRequest2Txn(int type, long zxid, Request request, Record record, boolean deserialize)
        throws KeeperException, IOException, RequestProcessorException
    &#123;
        request.hdr = new TxnHeader(request.sessionId, request.cxid, zxid,
                                    zks.getTime(), type);

        switch (type) &#123;
            case OpCode.create:                
                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());
                CreateRequest createRequest = (CreateRequest)record;   
                if(deserialize)
                    ByteBufferInputStream.byteBuffer2Record(request.request, createRequest);
                String path = createRequest.getPath();
                int lastSlash = path.lastIndexOf(&#39;/&#39;);
                if (lastSlash == -1 || path.indexOf(&#39;\0&#39;) != -1 || failCreate) &#123;
                    LOG.info(&quot;Invalid path &quot; + path + &quot; with session 0x&quot; +
                            Long.toHexString(request.sessionId));
                    throw new KeeperException.BadArgumentsException(path);
                &#125;
                List&lt;ACL&gt; listACL = removeDuplicates(createRequest.getAcl());
                if (!fixupACL(request.authInfo, listACL)) &#123;
                    throw new KeeperException.InvalidACLException(path);
                &#125;
                String parentPath = path.substring(0, lastSlash);
                ChangeRecord parentRecord = getRecordForPath(parentPath);

                checkACL(zks, parentRecord.acl, ZooDefs.Perms.CREATE,
                        request.authInfo);
                int parentCVersion = parentRecord.stat.getCversion();
                CreateMode createMode =
                    CreateMode.fromFlag(createRequest.getFlags());
                if (createMode.isSequential()) &#123;
                    path = path + String.format(Locale.ENGLISH, &quot;%010d&quot;, parentCVersion);
                &#125;
                validatePath(path, request.sessionId);
                try &#123;
                    if (getRecordForPath(path) != null) &#123;
                        throw new KeeperException.NodeExistsException(path);
                    &#125;
                &#125; catch (KeeperException.NoNodeException e) &#123;
                    // ignore this one
                &#125;
                boolean ephemeralParent = parentRecord.stat.getEphemeralOwner() != 0;
                if (ephemeralParent) &#123;
                    throw new KeeperException.NoChildrenForEphemeralsException(path);
                &#125;
                int newCversion = parentRecord.stat.getCversion()+1;
                request.txn = new CreateTxn(path, createRequest.getData(),
                        listACL,
                        createMode.isEphemeral(), newCversion);
                StatPersisted s = new StatPersisted();
                if (createMode.isEphemeral()) &#123;
                    s.setEphemeralOwner(request.sessionId);
                &#125;
                parentRecord = parentRecord.duplicate(request.hdr.getZxid());
                parentRecord.childCount++;
                parentRecord.stat.setCversion(newCversion);
                addChangeRecord(parentRecord);
                addChangeRecord(new ChangeRecord(request.hdr.getZxid(), path, s,
                        0, listACL));
                break;
</code></pre>
<ul>
<li>é¦–å…ˆæ˜¯ zks.getNextZxid()åˆ›å»ºä¸€ä¸ªäº‹åŠ¡idï¼ŒAtomicLong hzxidæ˜¯è‡ªå¢é•¿idï¼Œåˆå§‹åŒ–ä¸º0ï¼Œæ¯æ¬¡åŠ ä¸€</li>
<li>åœ¨pRequest2Txnå†…éƒ¨ï¼Œå…ˆç»™requeståˆ›å»ºä¸€ä¸ªTxnHeaderï¼Œè¿™ä¸ªheaderåŒ…å«äº‹åŠ¡id</li>
<li>ç„¶ååˆ¤æ–­è¯·æ±‚ç±»å‹</li>
<li>zks.sessionTracker.checkSession(request.sessionId, request.getOwner()) æ£€æŸ¥session</li>
<li>ååºåˆ—åŒ–ä¸ºCreateRequest</li>
</ul>
<h5 id="SyncRequestProcessor"><a href="#SyncRequestProcessor" class="headerlink" title="SyncRequestProcessor"></a>SyncRequestProcessor</h5><h5 id="FinalRequestProcessor"><a href="#FinalRequestProcessor" class="headerlink" title="FinalRequestProcessor"></a>FinalRequestProcessor</h5><p>æœªå®Œå¾…ç»­</p>
<hr>
<blockquote>
<p>ä½œè€…ï¼šJadepeng<br> å‡ºå¤„ï¼šjqpengçš„æŠ€æœ¯è®°äº‹æœ¬â€“<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoqi">http://www.cnblogs.com/xiaoqi</a><br> æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚<br> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/jqpeng/" rel="tag"># jqpeng</a>
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/zookeeper/" rel="tag"># zookeeper</a>
          </div>
        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/11/21/jqpeng-%E4%BB%8E%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB%E3%80%81BK%E6%A0%91%E5%88%B0%E6%96%87%E6%9C%AC%E7%BA%A0%E9%94%99/" rel="prev" title="ä»ç¼–è¾‘è·ç¦»ã€BKæ ‘åˆ°æ–‡æœ¬çº é”™">
      <i class="fa fa-chevron-left"></i> ä»ç¼–è¾‘è·ç¦»ã€BKæ ‘åˆ°æ–‡æœ¬çº é”™
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/12/08/jqpeng-%E4%BD%BF%E7%94%A8SpringBoot%E5%BC%80%E5%8F%91REST%E6%9C%8D%E5%8A%A1/" rel="next" title="ä½¿ç”¨SpringBootå¼€å‘RESTæœåŠ¡">
      ä½¿ç”¨SpringBootå¼€å‘RESTæœåŠ¡ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">1 ç¯å¢ƒå‡†å¤‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%AF%BC%E5%85%A5%E4%BB%A3%E7%A0%81"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 å¯¼å…¥ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%AE%BE%E7%BD%AE%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 è®¾ç½®é…ç½®æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%B0%83%E8%AF%95%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 è°ƒè¯•é…ç½®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">2 å¯åŠ¨åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-QuorumPeerMain"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 QuorumPeerMain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-ZooKeeperServerMain"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 ZooKeeperServerMain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-ServerCnxnFactory"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 ServerCnxnFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-ZooKeeperServer"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 ZooKeeperServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 æœåŠ¡å¯åŠ¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-%E9%85%8D%E7%BD%AEcnxnFactory"><span class="nav-number">2.5.1.</span> <span class="nav-text">2.5.1 é…ç½®cnxnFactory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-%E5%90%AF%E5%8A%A8cnxnFactory"><span class="nav-number">2.5.2.</span> <span class="nav-text">2.5.2 å¯åŠ¨cnxnFactory</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#socket%E5%A4%84%E7%90%86%E7%BA%BF%E7%A8%8B"><span class="nav-number">2.5.2.1.</span> <span class="nav-text">socketå¤„ç†çº¿ç¨‹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#socket%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86"><span class="nav-number">2.5.2.2.</span> <span class="nav-text">socketç½‘ç»œè¯·æ±‚å¤„ç†</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E8%BF%9E%E6%8E%A5%E8%AF%B7%E6%B1%82"><span class="nav-number">2.5.2.3.</span> <span class="nav-text">è¯»å–è¿æ¥è¯·æ±‚</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAsession"><span class="nav-number">2.5.2.4.</span> <span class="nav-text">åˆ›å»ºsession</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-zk%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8"><span class="nav-number">2.5.3.</span> <span class="nav-text">2.5.3 zkæœåŠ¡å™¨å¯åŠ¨</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SessionTracker"><span class="nav-number">2.5.3.1.</span> <span class="nav-text">SessionTracker</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-4-ZooKeeperServer%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E5%99%A8%E9%93%BE%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.5.4.</span> <span class="nav-text">2.5.4  ZooKeeperServerè¯·æ±‚å¤„ç†å™¨é“¾ä»‹ç»</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RequestProcessor"><span class="nav-number">2.5.4.1.</span> <span class="nav-text">RequestProcessor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PrepRequestProcessor"><span class="nav-number">2.5.4.2.</span> <span class="nav-text">PrepRequestProcessor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SyncRequestProcessor"><span class="nav-number">2.5.4.3.</span> <span class="nav-text">SyncRequestProcessor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FinalRequestProcessor"><span class="nav-number">2.5.4.4.</span> <span class="nav-text">FinalRequestProcessor</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JadePeng"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">JadePeng</p>
  <div class="site-description" itemprop="description">JadePengçš„æŠ€æœ¯ç¬”è®°æœ¬</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">100</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JadePeng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">644k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">9:46</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
